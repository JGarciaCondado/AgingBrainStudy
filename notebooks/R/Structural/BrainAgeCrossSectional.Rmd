---
title: "BrainAge Cross Sectional Analysis"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('BrainAgeCrossSectional.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/BrainAgeCrossSectional', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr); library(dplyr); library(sjPlot);library(metafor)

# Save path
path <- '~/Documents/Projects/AgingBrainStudy/figures/crossectional/'

# Load functions
source('~/Documents/Projects/AgingBrainStudy/scripts/regression_analysis.R')
source('~/Documents/Projects/AgingBrainStudy/scripts/improve_figure.R')

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
theme_set(theme_bw())
```

# BrainAge modelling

A linear regression BrainAge model was trained for each cohort on e4 non-carriers and AB-. The model was then applied to the rest of the cohort.

The model was trained using the following features:

-   Amygdala normalized volume
-   Hippocampus normalized volume
-   Inferior parietal cortical thickness
-   Inferior temporal cortical thickness
-   Middle temporal cortical thickness
-   Entorhinal cortical thickness
-   Parahippocampal cortical thickness
-   Fusiform cortical thickness

# A4/LEARN

Command used: model_age -o analysis/final/a4 -f data/final/a4/processed/structural_features.csv --clinical data/final/a4/processed/clinical.csv

```{r, include = FALSE}
# Load deltas and baseline
deltas <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/final/a4/ageml/model_age/predicted_age.csv') %>%
  rename(delta = delta_all)
baseline <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/a4/processed/baseline.csv',
                     na.strings = c("", "NA"))

# Merge data
cn_data <- merge(deltas[, c('ID', 'delta')], baseline, by = 'ID')

# Standardize data
cn_data_std <- cn_data %>%
  mutate(
    delta = scale(delta),
    e4_carrier = ifelse(e4_carrier == 'e4+', 1, 0),
    sex = ifelse(sex == 'Female', 1, 0),
    ab_status = ifelse(ab_status == 'ab+', 1, 0),
    ab_composite = scale(ab_composite),
    ptau = scale(ptau),
    tau_composite = scale(tau_composite),
  )

```

```{r}
# Distribution of deltas for controls
cat("Cognitively Unimpaired \n")
cat("Delta mean:", mean(cn_data$delta), "\n")
cat("Delta std:", sqrt(var(cn_data$delta)), "\n")
```

## Delta differences {.tabset}

### E4 status

```{r}
# Compute group means and their difference
delta_diff_e4 <- abs(diff(aggregate(delta ~ e4_carrier, data = subset(cn_data, !is.na(e4_carrier)), mean)$delta))
p_val_e4 <- t.test(delta ~ e4_carrier, data = cn_data)$p.value

# Logistic regression
a4_model_e4 <- glm(e4_carrier ~ delta, data = cn_data_std, family = binomial)
a4_e4_standrdized <- summary(a4_model_e4)

# Plot
ggplot(subset(cn_data, !is.na(e4_carrier)), aes(x = e4_carrier, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by E4 status",
    x = "E4 status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, 
    y = 6,
    label = sprintf("Mean difference: %.3f", delta_diff_e4),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, 
    y = 5,
    label = sprintf("p = %.2g", p_val_e4),
    size = 4,
    fontface = "italic"
  )
```

### Amyloid status

```{r}
# Compute group means and their difference
delta_diff_ab <- abs(diff(aggregate(delta ~ ab_status, data = subset(cn_data, !is.na(ab_status)), mean)$delta))
p_val_ab <- t.test(delta ~ ab_status, data = cn_data)$p.value

# Logistic regression
a4_model_ab_status <- glm(ab_status ~ delta, data = cn_data_std, family = binomial)
a4_ab_status_standrdized <- summary(a4_model_ab_status)

# Plot
ggplot(subset(cn_data, !is.na(ab_status)), aes(x = ab_status, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by AB status",
    x = "AB status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 6,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_ab),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, y = 5,
    label = sprintf("p = %.2g", p_val_ab),
    size = 4,
    fontface = "italic"
  )
```

### Sex differences

```{r}
# Compute group means and their difference
delta_diff_sex <- abs(diff(aggregate(delta ~ sex, data = subset(cn_data, !is.na(sex)), mean)$delta))
p_val_sex <- t.test(delta ~ sex, data = cn_data)$p.value

# Logistic regression
a4_sex_model <- glm(sex ~ delta, data = cn_data_std, family = binomial)
a4_sex_standrdized <- summary(a4_sex_model)

# Plot
ggplot(subset(cn_data, !is.na(sex)), aes(x = sex, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by Sex",
    x = "Sex",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 6,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_sex),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, y = 5,
    label = sprintf("p = %.2g", p_val_sex),
    size = 4,
    fontface = "italic"
  )
```

## Biomarkers {.tabset}

Correlation between BrainAge delt and different biomarkers. Sensitivity analysis includes addin sex, educaiton, APOEe4, AB-status and MRI Age as covariates. Further sensitivity analysis limits datapoints to those within 1 year of the MRI.

### PACC

```{r}
# Run analysis on PACC
pacc_analysis = regression_analysis(cn_data, 
                                    'PACC_mri', 
                                    'delta', 
                                    c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
pacc_analysis$scatter_plot

# Store pacc analysis
a4_pacc_model = lm(ab_composite ~ delta, data = cn_data_std)
a4_pacc_standrdized = summary(a4_pacc_model)

# Time sensitivity analysis
pacc_sens = regression_analysis(cn_data[cn_data$time_diff_pacc <=1 & cn_data$time_diff_pacc >=-1,],
                                'PACC_mri', 
                                'delta', 
                                c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    pacc_analysis$partial_correlation$estimate,
    pacc_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    pacc_sens$partial_correlation$estimate,
    pacc_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
pacc_analysis$scatter_plot <- improve_graph(pacc_analysis$scatter_plot, 'Delta (years)', 'PACC')
ggsave(paste(path, 'pacc_a4.png'), pacc_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### AB

```{r}
# Run analysis on AB
ab_analysis = regression_analysis(cn_data,
                                  'ab_composite', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
ab_analysis$scatter_plot

# Save standrdized results
a4_ab_model = lm(ab_composite ~ delta, data = cn_data_std)
a4_ab_standrdized = summary(a4_ab_model)

# Time sensitivity analysis
ab_sens = regression_analysis(cn_data[cn_data$time_diff_ab <=1 & cn_data$time_diff_ab >=-1,],
                              'ab_composite', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    ab_analysis$partial_correlation$estimate,
    ab_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    ab_sens$partial_correlation$estimate,
    ab_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
ab_analysis$scatter_plot <- improve_graph(ab_analysis$scatter_plot, 'Delta (years)', 'Aβ-PET')
ggsave(paste(path, 'ab_a4.png'), ab_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### ptau217

```{r}
# Run analysis on AB
ptau_analysis = regression_analysis(cn_data[cn_data$exploratory == 1,],
                                  'ptau', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
ptau_analysis$scatter_plot

# Save standardized results
a4_ptau_model = lm(ptau ~ delta, data = cn_data_std[cn_data$exploratory == 1,])
a4_ptau_standrdized = summary(a4_ptau_model)

# Time sensitivity analysis
ptau_sens = regression_analysis(cn_data[cn_data$exploratory == 1 & cn_data$time_diff_ptau <=1 & cn_data$time_diff_ptau >=-1,],
                              'ptau', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    ptau_analysis$partial_correlation$estimate,
    ptau_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    ptau_sens$partial_correlation$estimate,
    ptau_sens$partial_correlation$p.value, "\n")
# Apply figure improvement and save
ptau_analysis$scatter_plot <- improve_graph(ptau_analysis$scatter_plot, 'Delta (years)', 'pTau217')
ggsave(paste(path, 'ptau_a4.png'), ptau_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### TAU

```{r}
# Run analysis on AB
tau_analysis = regression_analysis(cn_data[cn_data$exploratory == 1,],
                                  'tau_composite', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
tau_analysis$scatter_plot

# Save standardized results
a4_tau_model = lm(tau_composite ~ delta, data = cn_data_std[cn_data$exploratory == 1,])
a4_tau_standrdized = summary(a4_tau_model)

# Time sensitivity analysis
tau_sens = regression_analysis(cn_data[cn_data$exploratory == 1 & cn_data$time_diff_tau <=1 & cn_data$time_diff_tau >=-1,],
                              'tau_composite', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    tau_analysis$partial_correlation$estimate,
    tau_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    tau_sens$partial_correlation$estimate,
    tau_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
tau_analysis$scatter_plot <- improve_graph(tau_analysis$scatter_plot, 'Delta (years)', 'Tau-PET')
ggsave(paste(path, 'tau_a4.png'), tau_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

# HABS

Command used: model_age -o analysis/final/habs -f data/final/habs/processed/structural_features.csv --clinical data/final/habs/processed/clinical.csv

```{r, include = FALSE}
# Load deltas and baseline
deltas <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/final/habs/ageml/model_age/predicted_age.csv') %>%
  rename(delta = delta_all)
baseline <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/habs/processed/baseline.csv',
                     na.strings = c("", "NA"))

# Merge data
cn_data <- merge(deltas[, c('ID', 'delta')], baseline, by = 'ID')

# Standardize data
cn_data_std <- cn_data %>%
  mutate(
    delta = scale(delta),
    e4_carrier = ifelse(e4_carrier == 'e4+', 1, 0),
    sex = ifelse(sex == 'Female', 1, 0),
    ab_status = ifelse(ab_status == 'ab+', 1, 0),
    ab_composite = scale(ab_composite),
    ptau = scale(ptau),
    tau_composite = scale(tau_composite)
  )
```

```{r}
# Distribution of deltas for controls
cat("Cognitively Unimpaired \n")
cat("Delta mean:", mean(cn_data$delta), "\n")
cat("Delta std:", sqrt(var(cn_data$delta)), "\n")
```

## Delta differences {.tabset}

### E4 status

```{r}
# Compute group means and their difference
delta_diff_e4 <- abs(diff(aggregate(delta ~ e4_carrier, data = subset(cn_data, !is.na(e4_carrier)), mean)$delta))
p_val_e4 <- t.test(delta ~ e4_carrier, data = cn_data)$p.value

# Logistic regression
habs_model_e4 <- glm(e4_carrier ~ delta, data = cn_data_std, family = binomial)
habs_e4_standrdized <- summary(habs_model_e4)

# Plot
ggplot(subset(cn_data, !is.na(e4_carrier)), aes(x = e4_carrier, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by E4 status",
    x = "E4 status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, 
    y = 8.5,
    label = sprintf("Mean difference: %.3f", delta_diff_e4),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, 
    y = 7,
    label = sprintf("p = %.2g", p_val_e4),
    size = 4,
    fontface = "italic"
  )
```

### Amyloid status

```{r}
# Compute group means and their difference
delta_diff_ab <- abs(diff(aggregate(delta ~ ab_status, data = subset(cn_data, !is.na(ab_status)), mean)$delta))
p_val_ab <- t.test(delta ~ ab_status, data = cn_data)$p.value

# Logistic regression
habs_model_ab_status <- glm(ab_status ~ delta, data = cn_data_std, family = binomial)
habs_ab_status_standrdized <- summary(habs_model_ab_status)

# Plot
ggplot(subset(cn_data, !is.na(ab_status)), aes(x = ab_status, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by AB status",
    x = "AB status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 8.5,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_ab),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, y = 7,
    label = sprintf("p = %.2g", p_val_ab),
    size = 4,
    fontface = "italic"
  )
```

### Sex differences

```{r}
# Compute group means and their difference
delta_diff_sex <- abs(diff(aggregate(delta ~ sex, data = subset(cn_data, !is.na(sex)), mean)$delta))
p_val_sex <- t.test(delta ~ sex, data = cn_data)$p.value

# Logistic regresion
habs_sex_model <- glm(sex ~ delta, data = cn_data_std, family = binomial)
habs_sex_standrdized <- summary(habs_sex_model)

# Plot
ggplot(subset(cn_data, !is.na(sex)), aes(x = sex, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by Sex",
    x = "Sex",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 8.5,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_sex),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, y = 7,
    label = sprintf("p = %.2g", p_val_sex),
    size = 4,
    fontface = "italic"
  )
```

## Biomarkers {.tabset}

Correlation between BrainAge delt and different biomarkers. Sensitivity analysis includes addin sex, educaiton, APOEe4, AB-status and MRI Age as covariates. Further sensitivity analysis limits datapoints to those within 1 year of the MRI.

### PACC

```{r}
# Run analysis on PACC
pacc_analysis = regression_analysis(cn_data, 
                                    'PACC_mri', 
                                    'delta', 
                                    c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
pacc_analysis$scatter_plot

# Store pacc analysis
habs_pacc_model = lm(PACC_mri ~ delta, data = cn_data_std)
habs_pacc_standrdized = summary(habs_pacc_model)

# Time sensitivity analysis
pacc_sens = regression_analysis(cn_data[cn_data$time_diff_pacc <=1 & cn_data$time_diff_pacc >=-1,],
                                'PACC_mri', 
                                'delta', 
                                c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    pacc_analysis$partial_correlation$estimate,
    pacc_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    pacc_sens$partial_correlation$estimate,
    pacc_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
pacc_analysis$scatter_plot <- improve_graph(pacc_analysis$scatter_plot, 'Delta (years)', 'PACC')
ggsave(paste(path, 'pacc_habs.png'), pacc_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### AB

```{r}
# Run analysis on AB
ab_analysis = regression_analysis(cn_data,
                                  'ab_composite', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
ab_analysis$scatter_plot

# Save standrdized results
habs_ab_model = lm(ab_composite ~ delta, data = cn_data_std)
habs_ab_standrdized = summary(habs_ab_model)

# Time sensitivity analysis
ab_sens = regression_analysis(cn_data[cn_data$time_diff_ab <=1 & cn_data$time_diff_ab >=-1,],
                              'ab_composite', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    ab_analysis$partial_correlation$estimate,
    ab_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    ab_sens$partial_correlation$estimate,
    ab_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
ab_analysis$scatter_plot <- improve_graph(ab_analysis$scatter_plot, 'Delta (years)', 'Aβ-PET')
ggsave(paste(path, 'ab_habs.png'), ab_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### ptau217

```{r}
# Run analysis on AB
ptau_analysis = regression_analysis(cn_data[cn_data$exploratory == 1,],
                                  'ptau', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
ptau_analysis$scatter_plot

# Save standardized results
habs_ptau_model = lm(ptau ~ delta, data = cn_data_std[cn_data$exploratory == 1,])
habs_ptau_standrdized = summary(habs_ptau_model)

# Time sensitivity analysis
ptau_sens = regression_analysis(cn_data[cn_data$exploratory == 1 & cn_data$time_diff_ptau <=1 & cn_data$time_diff_ptau >=-1,],
                              'ptau', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    ptau_analysis$partial_correlation$estimate,
    ptau_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    ptau_sens$partial_correlation$estimate,
    ptau_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
ptau_analysis$scatter_plot <- improve_graph(ptau_analysis$scatter_plot, 'Delta (years)', 'pTau217')
ggsave(paste(path, 'ptau_habs.png'), ptau_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### TAU

```{r}
# Run analysis on AB
tau_analysis = regression_analysis(cn_data[cn_data$exploratory == 1,],
                                  'tau_composite', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
tau_analysis$scatter_plot

# Save standardized results
habs_tau_model = lm(tau_composite ~ delta, data = cn_data_std[cn_data$exploratory == 1,])
habs_tau_standrdized = summary(habs_tau_model)

# Time sensitivity analysis
tau_sens = regression_analysis(cn_data[cn_data$exploratory == 1 & cn_data$time_diff_tau <=1 & cn_data$time_diff_tau >=-1,],
                              'tau_composite', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    tau_analysis$partial_correlation$estimate,
    tau_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    tau_sens$partial_correlation$estimate,
    tau_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
tau_analysis$scatter_plot <- improve_graph(tau_analysis$scatter_plot, 'Delta (years)', 'Tau-PET')
ggsave(paste(path, 'tau_habs.png'), tau_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

# ADNI CU

Command used: model_age -o analysis/final/adni -f data/final/adni/processed/structural_features.csv --clinical data/final/adni/processed/clinical.csv

```{r, include = FALSE}
# Load deltas and baseline
deltas <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/final/adni/ageml/model_age/predicted_age.csv') %>%
  rename(delta = delta_all)
baseline <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/adni/processed/baseline.csv',
                     na.strings = c("", "NA"))

# Merge data
data <- merge(deltas[, c('ID', 'delta')], baseline, by = 'ID')

# Seperate data for CN and MCI
cn_data <- data[data$diagnosis == 'CN',]
mci_data <- data[data$diagnosis == 'MCI',]

# Standrdize data
data_std <- data %>%
  mutate(
    delta = scale(delta),
    e4_carrier = ifelse(e4_carrier == 'e4+', 1, 0),
    sex = ifelse(sex == 'Female', 1, 0),
    ab_status = ifelse(ab_status == 'ab+', 1, 0),
    ab_composite = scale(ab_composite),
    ptau = scale(ptau),
    tau_composite = scale(tau_composite)
  )
cn_data_std <- data_std[data_std$diagnosis == 'CN',]
mci_data_std <- data_std[data_std$diagnosis == 'MCI',]

```

```{r}
# Distribution of deltas for controls
cat("Cognitively Unimpaired \n")
cat("Delta mean:", mean(cn_data$delta), "\n")
cat("Delta std:", sqrt(var(cn_data$delta)), "\n")
```

## Delta differences {.tabset}

### E4 status

```{r}
# Compute group means and their difference
delta_diff_e4 <- abs(diff(aggregate(delta ~ e4_carrier, data = subset(cn_data, !is.na(e4_carrier)), mean)$delta))
p_val_e4 <- t.test(delta ~ e4_carrier, data = cn_data)$p.value

# Logistic regression
adni_cu_model_e4 <- glm(e4_carrier ~ delta, data = cn_data_std, family = binomial)
adni_cu_e4_standrdized <- summary(adni_cu_model_e4)

# Plot
ggplot(subset(cn_data, !is.na(e4_carrier)), aes(x = e4_carrier, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by E4 status",
    x = "E4 status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, 
    y = 8.5,
    label = sprintf("Mean difference: %.3f", delta_diff_e4),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, 
    y = 7,
    label = sprintf("p = %.2g", p_val_e4),
    size = 4,
    fontface = "italic"
  )
```

### Amyloid status

```{r}
# Compute group means and their difference
delta_diff_ab <- abs(diff(aggregate(delta ~ ab_status, data = subset(cn_data, !is.na(ab_status)), mean)$delta))
p_val_ab <- t.test(delta ~ ab_status, data = cn_data)$p.value

# Logistic regression
adni_cu_model_ab_status <- glm(ab_status ~ delta, data = cn_data_std, family = binomial)
adni_cu_ab_status_standrdized <- summary(adni_cu_model_ab_status)

# Plot
ggplot(subset(cn_data, !is.na(ab_status)), aes(x = ab_status, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by AB status",
    x = "AB status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 8.5,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_ab),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, y = 7,
    label = sprintf("p = %.2g", p_val_ab),
    size = 4,
    fontface = "italic"
  )
```

### Sex differences

```{r}
# Compute group means and their difference
delta_diff_sex <- abs(diff(aggregate(delta ~ sex, data = subset(cn_data, !is.na(sex)), mean)$delta))
p_val_sex <- t.test(delta ~ sex, data = cn_data)$p.value

# Logistic regression
adni_cu_sex_model <- glm(sex ~ delta, data = cn_data_std, family = binomial)
adni_cu_sex_standrdized <- summary(adni_cu_sex_model)

# Plot
ggplot(subset(cn_data, !is.na(sex)), aes(x = sex, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by Sex",
    x = "Sex",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 8.5,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_sex),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, y = 7,
    label = sprintf("p = %.2g", p_val_sex),
    size = 4,
    fontface = "italic"
  )
```

## Biomarkers {.tabset}

Correlation between BrainAge delt and different biomarkers. Sensitivity analysis includes addin sex, educaiton, APOEe4, AB-status and MRI Age as covariates. Further sensitivity analysis limits datapoints to those within 1 year of the MRI.

### PACC

```{r}
# Run analysis on PACC
pacc_analysis = regression_analysis(cn_data, 
                                    'PACC_mri', 
                                    'delta', 
                                    c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
pacc_analysis$scatter_plot

# Store pacc analysis
adni_cu_pacc_model = lm(PACC_mri ~ delta, data = cn_data_std)
adni_cu_pacc_standrdized = summary(adni_cu_pacc_model)

# Time sensitivity analysis
pacc_sens = regression_analysis(cn_data[cn_data$time_diff_pacc <=1 & cn_data$time_diff_pacc >=-1,],
                                'PACC_mri', 
                                'delta', 
                                c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    pacc_analysis$partial_correlation$estimate,
    pacc_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    pacc_sens$partial_correlation$estimate,
    pacc_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
pacc_analysis$scatter_plot <- improve_graph(pacc_analysis$scatter_plot, 'Delta (years)', 'PACC')
ggsave(paste(path, 'pacc_adni_cu.png'), pacc_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### AB

```{r}
# Run analysis on AB
ab_analysis = regression_analysis(cn_data,
                                  'ab_composite', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
ab_analysis$scatter_plot

# Save standrdized results
adni_cu_ab_model = lm(ab_composite ~ delta, data = cn_data_std)
adni_cu_ab_standrdized = summary(adni_cu_ab_model)

# Time sensitivity analysis
ab_sens = regression_analysis(cn_data[cn_data$time_diff_ab <=1 & cn_data$time_diff_ab >=-1,],
                              'ab_composite', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    ab_analysis$partial_correlation$estimate,
    ab_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    ab_sens$partial_correlation$estimate,
    ab_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
ab_analysis$scatter_plot <- improve_graph(ab_analysis$scatter_plot, 'Delta (years)', 'Aβ-PET')
ggsave(paste(path, 'ab_adni_cu.png'), ab_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### ptau217

```{r}
# Run analysis on AB
ptau_analysis = regression_analysis(cn_data[cn_data$exploratory == 1,],
                                  'ptau', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
ptau_analysis$scatter_plot

# Save standardized results
adni_cu_ptau_model = lm(ptau ~ delta, data = cn_data_std[cn_data$exploratory == 1,])
adni_cu_ptau_standrdized = summary(adni_cu_ptau_model)

# Time sensitivity analysis
ptau_sens = regression_analysis(cn_data[cn_data$exploratory == 1 & cn_data$time_diff_ptau <=1 & cn_data$time_diff_ptau >=-1,],
                              'ptau', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    ptau_analysis$partial_correlation$estimate,
    ptau_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    ptau_sens$partial_correlation$estimate,
    ptau_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
ptau_analysis$scatter_plot <- improve_graph(ptau_analysis$scatter_plot, 'Delta (years)', 'pTau217')
ggsave(paste(path, 'ptau_adni_cu.png'), ptau_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### TAU

```{r}
# Run analysis on AB
tau_analysis = regression_analysis(cn_data[cn_data$exploratory == 1,],
                                  'tau_composite', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
tau_analysis$scatter_plot

# Save standardized results
adni_cu_tau_model = lm(tau_composite ~ delta, data = cn_data_std[cn_data$exploratory == 1,])
adni_cu_tau_standrdized = summary(adni_cu_tau_model)

# Time sensitivity analysis
tau_sens = regression_analysis(cn_data[cn_data$exploratory == 1 & cn_data$time_diff_tau <=1 & cn_data$time_diff_tau >=-1,],
                              'tau_composite', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    tau_analysis$partial_correlation$estimate,
    tau_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    tau_sens$partial_correlation$estimate,
    tau_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
tau_analysis$scatter_plot <- improve_graph(tau_analysis$scatter_plot, 'Delta (years)', 'Tau-PET')
ggsave(paste(path, 'tau_adni_cu.png'), tau_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

# ADNI MCI

```{r}
# Distribution of deltas for controls
cat("Mild Cognitive Impairment \n")
cat("Delta mean:", mean(mci_data$delta), "\n")
cat("Delta std:", sqrt(var(mci_data$delta)), "\n")
```

## Delta differences {.tabset}

### E4 status

```{r}
# Compute group means and their difference
delta_diff_e4 <- abs(diff(aggregate(delta ~ e4_carrier, data = subset(mci_data, !is.na(e4_carrier)), mean)$delta))
p_val_e4 <- t.test(delta ~ e4_carrier, data = mci_data)$p.value

# Linear regression model preddicintg e4_carriership
adni_mci_e4_model <- glm(e4_carrier ~ delta, data = mci_data_std, family = "binomial")
adni_mci_e4_standrdized <- summary(adni_mci_e4_model)

# Plot
ggplot(subset(mci_data, !is.na(e4_carrier)), aes(x = e4_carrier, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by E4 status",
    x = "E4 status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, 
    y = 12,
    label = sprintf("Mean difference: %.3f", delta_diff_e4),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, 
    y = 10,
    label = sprintf("p = %.2g", p_val_e4),
    size = 4,
    fontface = "italic"
  )
```

### Amyloid status

```{r}
# Compute group means and their difference
delta_diff_ab <- abs(diff(aggregate(delta ~ ab_status, data = subset(mci_data, !is.na(ab_status)), mean)$delta))
p_val_ab <- t.test(delta ~ ab_status, data = mci_data)$p.value

# Logistic regresison
adni_mci_ab_status_model <- glm(ab_status ~ delta, data = mci_data_std, family = "binomial")
adni_mci_ab_status_standrdized <- summary(adni_mci_ab_status_model)

# Plot
ggplot(subset(mci_data, !is.na(ab_status)), aes(x = ab_status, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by AB status",
    x = "AB status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 12,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_ab),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, y = 10,
    label = sprintf("p = %.2g", p_val_ab),
    size = 4,
    fontface = "italic"
  )
```

### Sex differences

```{r}
# Compute group means and their difference
delta_diff_sex <- abs(diff(aggregate(delta ~ sex, data = subset(mci_data, !is.na(sex)), mean)$delta))
p_val_sex <- t.test(delta ~ sex, data = mci_data)$p.value

# Logistic regression
adni_mci_sex_model <- glm(sex ~ delta, data = mci_data_std, family = binomial)
adni_mci_sex_standrdized <- summary(adni_mci_sex_model)

# Plot
ggplot(subset(mci_data, !is.na(sex)), aes(x = sex, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by Sex",
    x = "Sex",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 12,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_sex),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, y = 10,
    label = sprintf("p = %.2g", p_val_sex),
    size = 4,
    fontface = "italic"
  )
```

### MCI vs CU

```{r}
# Compute group means and their difference
delta_diff_mci <- abs(diff(aggregate(delta ~ diagnosis, data = data, mean)$delta))
p_val_mci <- t.test(delta ~ diagnosis, data = data)$p.value

# Logistic regression
data$mci <- ifelse(data$diagnosis == 'MCI', 1, 0)
classification_model <- glm(mci ~ scale(delta), data = data, family = "binomial")
adni_mci_cu_standrdized <- summary(classification_model)

# Print beta coefficient, standard error and p-value
cat("Beta coefficient:", classification_model$coefficients[2], "\n")
cat("Standard error:", summary(classification_model)$coefficients[2, 2], "\n")
cat("p-value:", summary(classification_model)$coefficients[2, 4], "\n")

# Plot
ggplot(data, aes(x = diagnosis, y = delta)) +
  geom_boxplot() +
  labs(
    title = "Delta differences by Diagnosis",
    x = "Diagnosis",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 12,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_mci),
    size = 4,
    fontface = "italic"
  ) +
  annotate(
    "text",
    x = 1.5, y = 10,
    label = sprintf("p = %.2g", p_val_mci),
    size = 4,
    fontface = "italic"
  )
```

## Biomarkers {.tabset}

Correlation between BrainAge delt and different biomarkers. Sensitivity analysis includes addin sex, educaiton, APOEe4, AB-status and MRI Age as covariates. Further sensitivity analysis limits datapoints to those within 1 year of the MRI.

### PACC

```{r}
# Run analysis on PACC
pacc_analysis = regression_analysis(mci_data, 
                                    'PACC_mri', 
                                    'delta', 
                                    c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
pacc_analysis$scatter_plot

# Store pacc analysis
adni_mci_pacc_model = lm(PACC_mri ~ delta, data = mci_data_std)
adni_mci_pacc_standrdized = summary(adni_mci_pacc_model)

# Time sensitivity analysis
pacc_sens = regression_analysis(mci_data[mci_data$time_diff_pacc <=1 & mci_data$time_diff_pacc >=-1,],
                                'PACC_mri', 
                                'delta', 
                                c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    pacc_analysis$partial_correlation$estimate,
    pacc_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    pacc_sens$partial_correlation$estimate,
    pacc_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
pacc_analysis$scatter_plot <- improve_graph(pacc_analysis$scatter_plot, 'Delta (years)', 'PACC')
ggsave(paste(path, 'pacc_adni_mci.png'), pacc_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### AB

```{r}
# Run analysis on AB
ab_analysis = regression_analysis(mci_data,
                                  'ab_composite', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
ab_analysis$scatter_plot

# Save standrdized results
adni_mci_ab_model = lm(ab_composite ~ delta, data = mci_data_std)
adni_mci_ab_standrdized = summary(adni_mci_ab_model)

# Time sensitivity analysis
ab_sens = regression_analysis(mci_data[mci_data$time_diff_ab <=1 & mci_data$time_diff_ab >=-1,],
                              'ab_composite', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    ab_analysis$partial_correlation$estimate,
    ab_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    ab_sens$partial_correlation$estimate,
    ab_sens$partial_correlation$p.value, "\n")
# Apply figure improvement and save
ab_analysis$scatter_plot <- improve_graph(ab_analysis$scatter_plot, 'Delta (years)', 'Aβ-PET')
ggsave(paste(path, 'ab_adni_mci.png'), ab_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### ptau217

```{r}
# Run analysis on AB
ptau_analysis = regression_analysis(mci_data[mci_data$exploratory == 1,],
                                  'ptau', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
ptau_analysis$scatter_plot

# Save standardized results
adni_mci_ptau_model = lm(ptau ~ delta, data = mci_data_std[mci_data$exploratory == 1,])
adni_mci_ptau_standrdized = summary(adni_mci_ptau_model)

# Time sensitivity analysis
ptau_sens = regression_analysis(mci_data[mci_data$exploratory == 1 & mci_data$time_diff_ptau <=1 & mci_data$time_diff_ptau >=-1,],
                              'ptau', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    ptau_analysis$partial_correlation$estimate,
    ptau_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    ptau_sens$partial_correlation$estimate,
    ptau_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
ptau_analysis$scatter_plot <- improve_graph(ptau_analysis$scatter_plot, 'Delta (years)', 'pTau217')
ggsave(paste(path, 'ptau_adni_mci.png'), ptau_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

### TAU

```{r}
# Run analysis on AB
tau_analysis = regression_analysis(mci_data[mci_data$exploratory == 1,],
                                  'tau_composite', 
                                  'delta', 
                                  c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Plot results
tau_analysis$scatter_plot

# Save standardized results
adni_mci_tau_model = lm(tau_composite ~ delta, data = mci_data_std[mci_data$exploratory == 1,])
adni_mci_tau_standrdized = summary(adni_mci_tau_model)

# Time sensitivity analysis
tau_sens = regression_analysis(mci_data[mci_data$exploratory == 1 & mci_data$time_diff_tau <=1 & mci_data$time_diff_tau >=-1,],
                              'tau_composite', 
                              'delta', 
                              c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))

# Sensitivity analysis
cat("Sensitivity analysis: \n")
cat("Correlation with delta including covariates:", 
    tau_analysis$partial_correlation$estimate,
    tau_analysis$partial_correlation$p.value, "\n")
cat("Correlation with delta including covariates and time difference:", 
    tau_sens$partial_correlation$estimate,
    tau_sens$partial_correlation$p.value, "\n")

# Apply figure improvement and save
tau_analysis$scatter_plot <- improve_graph(tau_analysis$scatter_plot, 'Delta (years)', 'Tau-PET')
ggsave(paste(path, 'tau_adni_mci.png'), tau_analysis$scatter_plot, 
       width = 50, height = 36, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

# Meta-analysis

## E4 status
```{r}
# Define model names and corresponding summary objects
e4_models <- list(
  "A4/LEARN" = a4_e4_standrdized,
  "HABS" = habs_e4_standrdized,
  "ADNI CU" = adni_cu_e4_standrdized,
  "ADNI MCI" = adni_mci_e4_standrdized
)

# Create the combined data frame
e4_results <- do.call(rbind, lapply(names(e4_models), function(name) {
  data.frame(
    model = name,
    estimate = e4_models[[name]]$coefficients["delta", "Estimate"],
    se = e4_models[[name]]$coefficients["delta", "Std. Error"],
    pval = e4_models[[name]]$coefficients["delta", "Pr(>|z|)"]
  )
}))

# E4 meta-analysis ALL
e4_all <- rma(yi = estimate, sei = se, data = e4_results, method = "ML", test = "knha")
cat("E4 All:", e4_all$beta, "(", e4_all$pval, ") \n")
# E4 meta-analysis CU
e4_cu <- rma(yi = estimate, sei = se, data = e4_results[e4_results$model %in% c("ADNI CU", "HABS"), ], method = "ML", test = "knha")
cat("E4 CU:", e4_cu$beta, "(", e4_cu$pval, ") \n")
```

## AB status

```{r}
# Define model names and corresponding summary objects
ab_status_models <- list(
  "A4/LEARN" = a4_ab_status_standrdized,
  "HABS" = habs_ab_status_standrdized,
  "ADNI CU" = adni_cu_ab_status_standrdized,
  "ADNI MCI" = adni_mci_ab_status_standrdized
)

# Create the combined data frame
ab_status_results <- do.call(rbind, lapply(names(ab_status_models), function(name) {
  data.frame(
    model = name,
    estimate = ab_status_models[[name]]$coefficients["delta", "Estimate"],
    se = ab_status_models[[name]]$coefficients["delta", "Std. Error"],
    pval = ab_status_models[[name]]$coefficients["delta", "Pr(>|z|)"]
  )
}))

# AB status meta-analysis ALL
ab_status_all <- rma(yi = estimate, sei = se, data = ab_status_results, method = "ML", test = "knha")
cat("AB status All:", ab_status_all$beta, "(", ab_status_all$pval, ") \n")
# AB status meta-analysis CU
ab_status_cu <- rma(yi = estimate, sei = se, data = ab_status_results[ab_status_results$model %in% c("ADNI CU", "HABS"), ], method = "ML", test = "knha")
cat("AB status CU:", ab_status_cu$beta, "(", ab_status_cu$pval, ") \n")
```

## Sex

```{r}
# Define model names and corresponding summary objects
sex_models <- list(
  "A4/LEARN" = a4_sex_standrdized,
  "HABS" = habs_sex_standrdized,
  "ADNI CU" = adni_cu_sex_standrdized,
  "ADNI MCI" = adni_mci_sex_standrdized
)

# Create the combined data frame
sex_results <- do.call(rbind, lapply(names(sex_models), function(name) {
  data.frame(
    model = name,
    estimate = sex_models[[name]]$coefficients["delta", "Estimate"],
    se = sex_models[[name]]$coefficients["delta", "Std. Error"],
    pval = sex_models[[name]]$coefficients["delta", "Pr(>|z|)"]
  )
}))

# Sex meta-analysis ALL
sex_all <- rma(yi = estimate, sei = se, data = sex_results, method = "ML", test = "knha")
cat("Sex All:", sex_all$beta, "(", sex_all$pval, ") \n")
# Sex meta-analysis CU
sex_cu <- rma(yi = estimate, sei = se, data = sex_results[sex_results$model %in% c("ADNI CU", "HABS"), ], method = "ML", test = "knha")
cat("Sex CU:", sex_cu$beta, "(", sex_cu$pval, ") \n")
```

## PACC

```{r}
# Define model names and corresponding summary objects
pacc_models <- list(
  "A4/LEARN" = a4_pacc_standrdized,
  "HABS" = habs_pacc_standrdized,
  "ADNI CU" = adni_cu_pacc_standrdized,
  "ADNI MCI" = adni_mci_pacc_standrdized
)

# Create the combined data frame
pacc_results <- do.call(rbind, lapply(names(pacc_models), function(name) {
  data.frame(
    model = name,
    estimate = pacc_models[[name]]$coefficients["delta", "Estimate"],
    se = pacc_models[[name]]$coefficients["delta", "Std. Error"],
    pval = pacc_models[[name]]$coefficients["delta", "Pr(>|t|)"]
  )
}))

# PACC meta-analysis ALL
pacc_all <- rma(yi = estimate, sei = se, data = pacc_results, method = "ML", test = "knha")
cat("PACC All:", pacc_all$beta, "(", pacc_all$pval, ") \n")

# PACC meta-analysis CU
pacc_cu <- rma(yi = estimate, sei = se, data = pacc_results[pacc_results$model %in% c("ADNI CU", "HABS"), ], method = "ML", test = "knha")
cat("PACC CU:", pacc_cu$beta, "(", pacc_cu$pval, ") \n")
```

## AB

```{r}
# Define model names and corresponding summary objects
ab_models <- list(
  "A4/LEARN" = a4_ab_standrdized,
  "HABS" = habs_ab_standrdized,
  "ADNI CU" = adni_cu_ab_standrdized,
  "ADNI MCI" = adni_mci_ab_standrdized
)

# Create the combined data frame
ab_results <- do.call(rbind, lapply(names(ab_models), function(name) {
  data.frame(
    model = name,
    estimate = ab_models[[name]]$coefficients["delta", "Estimate"],
    se = ab_models[[name]]$coefficients["delta", "Std. Error"]
  )
}))

# AB meta-analysis ALL
ab_all <- rma(yi = estimate, sei = se, data = ab_results, method = "ML", test = "knha")
cat("AB All:", ab_all$beta, "(", ab_all$pval, ") \n")

# AB meta-analysis CU
ab_cu <- rma(yi = estimate, sei = se, data = ab_results[ab_results$model %in% c("ADNI CU", "HABS"), ], method = "ML", test = "knha")
cat("AB CU:", ab_cu$beta, "(", ab_cu$pval, ") \n")
```

## pTau217
```{r}
# Define model names and corresponding summary objects
ptau_models <- list(
  "A4/LEARN" = a4_ptau_standrdized,
  "HABS" = habs_ptau_standrdized,
  "ADNI CU" = adni_cu_ptau_standrdized,
  "ADNI MCI" = adni_mci_ptau_standrdized
)

# Create the combined data frame
ptau_results <- do.call(rbind, lapply(names(ptau_models), function(name) {
  data.frame(
    model = name,
    estimate = ptau_models[[name]]$coefficients["delta", "Estimate"],
    se = ptau_models[[name]]$coefficients["delta", "Std. Error"]
  )
}))

# pTau217 meta-analysis ALL
ptau_all <- rma(yi = estimate, sei = se, data = ptau_results, method = "ML", test = "knha")
cat("pTau217 All:", ptau_all$beta, "(", ptau_all$pval, ") \n")
# pTau217 meta-analysis CU
ptau_cu <- rma(yi = estimate, sei = se, data = ptau_results[ptau_results$model %in% c("ADNI CU", "HABS"), ], method = "ML", test = "knha")
cat("pTau217 CU:", ptau_cu$beta, "(", ptau_cu$pval, ") \n")
```

## Tau

```{r}
# Define model names and corresponding summary objects
tau_models <- list(
  "A4/LEARN" = a4_tau_standrdized,
  "HABS" = habs_tau_standrdized,
  "ADNI CU" = adni_cu_tau_standrdized,
  "ADNI MCI" = adni_mci_tau_standrdized
)

# Create the combined data frame
tau_results <- do.call(rbind, lapply(names(tau_models), function(name) {
  data.frame(
    model = name,
    estimate = tau_models[[name]]$coefficients["delta", "Estimate"],
    se = tau_models[[name]]$coefficients["delta", "Std. Error"]
  )
}))

# Tau meta-analysis ALL
tau_all <- rma(yi = estimate, sei = se, data = tau_results, method = "ML", test = "knha")
cat("Tau All:", tau_all$beta, "(", tau_all$pval, ") \n")
# Tau meta-analysis CU
tau_cu <- rma(yi = estimate, sei = se, data = tau_results[tau_results$model %in% c("ADNI CU", "HABS"), ], method = "ML", test = "knha")
cat("Tau CU:", tau_cu$beta, "(", tau_cu$pval, ") \n")
```

## CU results

```{r}
# List of your meta-analysis results
meta_results <- list(e4_cu, sex_cu, pacc_cu, ab_cu, ptau_cu, tau_cu)

# Corresponding labels for y-axis
labels <- c("APOEe4+", "Female", "PACC", "AB-PET", "pTau217", "Tau-PET")

# Extract estimates, confidence intervals, and p-values
estimates <- sapply(meta_results, function(x) x$beta)
ci_lower <- sapply(meta_results, function(x) x$ci.lb)
ci_upper <- sapply(meta_results, function(x) x$ci.ub)
pvals <- sapply(meta_results, function(x) x$pval)

# Create a data frame for plotting
forest_data_cu <- data.frame(
  labels = labels,
  estimates = estimates,
  ci_lower = ci_lower,
  ci_upper = ci_upper,
  pvals = pvals
)

# Plot the forest plot
forest_plot <- ggplot(forest_data_cu, aes(x = estimates, y = labels)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = ci_lower, xmax = ci_upper), height = 0.2) +   # 95% confidence intervals
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray") +
  labs(
    x = "β (Standardized Coefficients)",
    y = "Cohort"
  ) +
  theme_minimal() +
  xlim(-2.5, 2.5)

# Print the plot
print(forest_plot)
```

## MCI results

```{r}
# List of your meta-analysis results
meta_results <- list(adni_mci_e4_standrdized,
                     adni_mci_sex_standrdized,
                     adni_mci_pacc_standrdized,
                     adni_mci_ab_standrdized,
                     adni_mci_ptau_standrdized,
                     adni_mci_tau_standrdized)

# Corresponding labels for y-axis
labels <- c("APOEe4+", "Female", "PACC", "AB-PET", "pTau217", "Tau-PET")

# Define which coefficient to use for each model
coef_names <- c("Estimate", "Estimate", "Estimate", "Standardized", "Standardized", "Standardized", "Standardized")

# Define which p-value column to use for each model
pval_cols <- c("Pr(>|z|)", "Pr(>|z|)", "Pr(>|t|)", "Pr(>|t|)", "Pr(>|t|)", "Pr(>|t|)")

# Extract estimates
estimates <- sapply(meta_results, function(x) x$coefficients["delta", "Estimate"])
std_errors <- sapply(meta_results, function(x) x$coefficients["delta", "Std. Error"])

# Calculate confidence intervals
ci_lower <- estimates - 1.96 * std_errors
ci_upper <- estimates + 1.96 * std_errors

# Extract p-values
pvals <- sapply(1:length(meta_results), function(i) {
  meta_results[[i]]$coefficients["delta", pval_cols[i]]
})

# Create a data frame for plotting
forest_data_mci <- data.frame(
  labels = labels,
  estimates = estimates,
  ci_lower = ci_lower,
  ci_upper = ci_upper,
  pvals = pvals
)

# Plot the forest plot
forest_plot <- ggplot(forest_data_mci, aes(x = estimates, y = labels)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = ci_lower, xmax = ci_upper), height = 0.2) +   # 95% confidence intervals
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray") +
  labs(
    x = "β (Standardized Coefficients)",
    y = "Cohort"
  ) +
  theme_minimal() +
  xlim(-2.5, 2.5) 

# Print the plot
print(forest_plot)
```