---
title: "ADNI BrainAge"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('ADNIBrainAge.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/ADNIBrainAge', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr); library(dplyr); library(sjPlot)

source('~/Documents/Projects/AgingBrainStudy/scripts/functions.R')

knitr::opts_chunk$set(echo = FALSE, message = FALSE)
theme_set(theme_bw())
```

# BrainAge modelling in ADNI

A linear regression BrainAge model was trained on cognitively unimpaired e4 non-carriers and AB-. The model was then applied to the rest of the cohort.

The model was trained using the following features:

-   Amygdala normalized volume
-   Hippocampus normalized volume
-   Inferior parietal cortical thickness
-   Inferior temporal cortical thickness
-   Middle temporal cortical thickness
-   Entorhinal cortical thickness
-   Parahippocampal cortical thickness
-   Fusiform cortical thickness

Command used: model_age -o analysis/final/adni -f data/final/adni/processed/structural_features.csv --clinical data/final/adni/processed/clinical.csv

```{r, include = FALSE}
# Load deltas and baseline
deltas <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/final/adni/ageml/model_age/predicted_age.csv') %>%
  rename(delta = delta_all)
baseline <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/adni/processed/baseline.csv',
                     na.strings = c("", "NA"))

# Merge data
data <- merge(deltas[, c('ID', 'delta')], baseline, by = 'ID')

# Seperate data for CN and MCI
cn_data <- data[data$diagnosis == 'CN',]
mci_data <- data[data$diagnosis == 'MCI',]
```

# Cognitively Unimpaired

```{r}
# Distribution of deltas for controls
print("Cognitively Unimpaired")
sprintf("Delta mean: %.3f", mean(cn_data$delta))
sprintf("Delta std: %.3f", sqrt(var(cn_data$delta)))
```

## Delta differences {.tabset}

### E4 status

```{r}
# Compute group means and their difference
delta_diff_e4 <- abs(diff(aggregate(delta ~ e4_carrier, data = subset(cn_data, !is.na(e4_carrier)), mean)$delta))

# Plot
ggplot(subset(cn_data, !is.na(e4_carrier)), aes(x = e4_carrier, y = delta)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test") +
  labs(
    title = "Delta differences by E4 status",
    x = "E4 status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 10,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_e4),
    size = 4,
    fontface = "italic"
  )
```

### Amyloid status

```{r}
# Compute group means and their difference
delta_diff_ab <- abs(diff(aggregate(delta ~ ab_status, data = subset(cn_data, !is.na(ab_status)), mean)$delta))

# Plot
ggplot(subset(cn_data, !is.na(ab_status)), aes(x = ab_status, y = delta)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test") +
  labs(
    title = "Delta differences by AB status",
    x = "AB status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 10,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_ab),
    size = 4,
    fontface = "italic"
  )
```

### Sex differences

```{r}
# Compute group means and their difference
delta_diff_sex <- abs(diff(aggregate(delta ~ sex, data = subset(cn_data, !is.na(sex)), mean)$delta))

# Plot
ggplot(subset(cn_data, !is.na(sex)), aes(x = sex, y = delta)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test") +
  labs(
    title = "Delta differences by Sex",
    x = "Sex",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 10,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_sex),
    size = 4,
    fontface = "italic"
  )
```

## Biomarkers {.tabset}

### PACC

```{r}
regression_analysis(cn_data, 'PACC', 'delta', c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))
```

### AB

```{r}
regression_analysis(cn_data, 'ab_composite', 'delta', c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age') )
```

### ptau217

```{r}
regression_analysis(cn_data, 'ptau', 'delta', c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age') )
```

### TAU

```{r}
regression_analysis(cn_data, 'tau_composite', 'delta', c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age') )
```

# Mild Cognitive Impairment

```{r}
# Distribution of deltas for controls
print("Mild Cognitive Impairment")
sprintf("Delta mean: %.3f", mean(mci_data$delta))
sprintf("Delta std: %.3f", sqrt(var(mci_data$delta)))
```

## Delta differences {.tabset}

### E4 status

```{r}
# Compute group means and their difference
delta_diff_e4 <- abs(diff(aggregate(delta ~ e4_carrier, data = subset(mci_data, !is.na(e4_carrier)), mean)$delta))

# Plot
ggplot(subset(mci_data, !is.na(e4_carrier)), aes(x = e4_carrier, y = delta)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test") +
  labs(
    title = "Delta differences by E4 status",
    x = "E4 status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 10,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_e4),
    size = 4,
    fontface = "italic"
  )
```

### Amyloid status

```{r}
# Compute group means and their difference
delta_diff_ab <- abs(diff(aggregate(delta ~ ab_status, data = subset(mci_data, !is.na(ab_status)), mean)$delta))

# Plot
ggplot(subset(mci_data, !is.na(ab_status)), aes(x = ab_status, y = delta)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test") +
  labs(
    title = "Delta differences by AB status",
    x = "AB status",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 10,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_ab),
    size = 4,
    fontface = "italic"
  )
```

### Sex differences

```{r}
# Compute group means and their difference
delta_diff_sex <- abs(diff(aggregate(delta ~ sex, data = subset(mci_data, !is.na(sex)), mean)$delta))

# Plot
ggplot(subset(mci_data, !is.na(sex)), aes(x = sex, y = delta)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test") +
  labs(
    title = "Delta differences by Sex",
    x = "Sex",
    y = "Delta"
  ) +
  annotate(
    "text",
    x = 1.5, y = 10,  # Position the text at the top center
    label = sprintf("Mean difference: %.3f", delta_diff_sex),
    size = 4,
    fontface = "italic"
  )
```

## Biomarkers {.tabset}

### PACC

```{r}
regression_analysis(mci_data, 'PACC', 'delta', c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age'))
```

### AB

```{r}
regression_analysis(mci_data, 'ab_composite', 'delta', c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age') )
```

### ptau217

```{r}
regression_analysis(mci_data, 'ptau', 'delta', c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age') )
```

### TAU

```{r}
regression_analysis(mci_data, 'tau_composite', 'delta', c('sex', 'edu', 'e4_carrier', 'ab_status', 'mri_age') )
```

