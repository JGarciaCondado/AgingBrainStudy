---
title: "Brain Age Longitudinal PACC"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('BrainAgeLongitudinalPACC.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/BrainAgeLongitudinalPACC', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr);library(dplyr);library(nlme);library(sjPlot);library(gtsummary);library(MuMIn);library(gt);library(ggeffects)

# Save path
path <- '~/Documents/Projects/AgingBrainStudy/figures/longitudinal/'

# Load optimal threshold function
source('~/Documents/Projects/AgingBrainStudy/scripts/find_optimal_threshold.R')

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
theme_set(theme_bw())
```

We will explore how baseline Brain Age delta moderates longitudinal PACC through a linear mixed effects model on four cohorts:
- A4/LEARN
- HABS
- ADNI CU
- ADNI MCI

```{r}
# Load A4 data
data_a4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/a4/processed/longitudinal.csv') %>%
  mutate_at(vars(sex, e4_carrier, ab_status, cohort, LMSTORY), factor)

# Placebo data
data_placebo <- data_a4 %>% 
  filter(cohort == 'A4 Placebo')
```

```{r}
# Load HABS data
data_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/habs/processed/longitudinal.csv') %>%
  mutate_at(vars(sex, e4_carrier, ab_status), factor)
```

```{r}
# Load ADNI data
data_adni <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/adni/processed/longitudinal.csv') %>%
  mutate_at(vars(sex, e4_carrier, ab_status), factor)

# Devide between Baseline_diagnosis CN and MCI
data_adni_mci <- data_adni %>% 
  filter(diagnosis == 'MCI')
data_adni_cn <- data_adni %>%
  filter(diagnosis == 'CN')
```

```{r}
# Summary statistics for plotting

# Time
a4_max_time   <- max(data_a4$time_mri, na.rm = TRUE)
adni_max_time <- max(data_adni$time_mri, na.rm = TRUE)
habs_max_time <- max(data_habs$time_mri, na.rm = TRUE)
max_time <- max(c(a4_max_time, adni_max_time, habs_max_time), na.rm = TRUE)

# PACC
min_pacc = -10
max_pacc = 1
```

# A4 Structural BrainAge

## Trajectories

Plot individual PACC trajectories with spaghetti plot.

```{r}
# Plot Trajectories
trajectories_a4 <- ggplot(data_a4, aes(x = time_mri, y = PACC, group = ID, colour = delta_group)) +
  labs(x = 'Time from MRI (years)', 
       y = 'PACC',
       colour = 'BrainAge delta') +
  scale_colour_discrete(labels = c("Older      (>0)", "Younger (<0)")) +
  theme_minimal()

# Show with poitns and lines
trajectories_a4 + geom_line() + geom_point()

# Save plot
trajectories_a4 <- trajectories_a4 + 
  geom_line(linewidth = 0.2) +
  geom_point(size = 0.2) +
    theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm"),
    ) 
ggsave(paste(path, 'trajectories_a4.png'), trajectories_a4, 
       width = 125, height = 50, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

## Mixed Effects Model

Simplest Quadratic mixed effects models with delta interaction:

PACC \~ time_mri\^2 + time_mriXdelta + Cumulative_Dose_Scaled + LMSTORY + time_mriXcohort

```{r}
# Create linear mixed effects model for A4 
lme_a4 <- lme(PACC ~ I(time_mri^2) 
              + time_mri*delta 
              + Cumulative_Dose_Scaled 
              + time_mri*cohort 
              + LMSTORY, 
              data = data_a4, 
              random = ~time_mri|ID, 
              na.action = 'na.omit', 
              method = c('ML'),
              control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
a4_results = summary(lme_a4)$tTable
a4_delta_effects <- data.frame(
    model = "A4/LEARN",
    delta.term = "BrainAge delta",
    delta.estimate = a4_results["time_mri:delta", "Value"],
    delta.std.error = a4_results["time_mri:delta", "Std.Error"],
    delta.lower_ci = a4_results["time_mri:delta", "Value"] 
                      - 1.96 * a4_results["time_mri:delta", "Std.Error"],
    delta.upper_ci = a4_results["time_mri:delta", "Value"]
                      + 1.96 * a4_results["time_mri:delta", "Std.Error"],
    delta.p_value = a4_results["time_mri:delta", "p-value"]
  )
cat("Delta effect:", signif(a4_delta_effects$delta.estimate, 2), 
    "±", signif(a4_delta_effects$delta.std.error, 2), 
    " p-val:", signif(a4_delta_effects$delta.p_value, 2), "\n")

# Plot model
a4_p <- plot(ggpredict(lme_a4, terms = c("time_mri [all]", "delta"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, max_time)) + 
  scale_y_continuous(limits = c(-3.5, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )
a4_p

# Save model
a4_p <- a4_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.05, 0.05, 0.05, 0.05), "cm"),
    ) 
ggsave(paste(path, 'lme_a4.png'), a4_p, 
       width = 125, height = 50, units = "mm", 
       dpi = 500,   # Higher resolution
       scale = 1)
```

## Sensitivity Analysis {.tabset}

### Linear vs Quadratic

```{r}
lme_a4_linear <- lme(PACC ~ time_mri*delta 
                             + Cumulative_Dose_Scaled 
                             + LMSTORY
                             + time_mri*cohort,
                             data = data_a4, 
                             random = ~time_mri|ID, 
                             na.action = 'na.omit', method = c('ML'),
                             control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
anova(lme_a4_linear, lme_a4)
```

### Placebo

```{r}
lme_a4_placebo <- lme(PACC ~ I(time_mri^2) 
                      + time_mri*delta 
                      + Cumulative_Dose_Scaled 
                      + LMSTORY, 
                      data = data_placebo, 
                      random = ~time_mri|ID, 
                      na.action = 'na.omit', method = c('ML'));
cat("Using placebo data p-value:" , summary(lme_a4_placebo)$tTable["time_mri:delta", "p-value"])
```

### Age, e4 and amyloid

Amyloid is not included because cohort already takes this into account as LEARN are those that are ab- compared to A4 which are ab+. This leads to singularity back solve if ab_status included.

Add Age, APOE, Sex, Education:

```{r}
lme_a4_sens_demo <- lme(PACC ~ I(time_mri^2) 
                        + time_mri*delta 
                        + Cumulative_Dose_Scaled 
                        + LMSTORY 
                        + time_mri*cohort 
                        + time_mri*mri_age 
                        + time_mri*e4_carrier 
                        + time_mri*sex 
                        + time_mri*edu, 
                        data = data_a4, 
                        random = ~time_mri|ID, 
                        na.action = 'na.omit', 
                        method = c('ML'),
                        control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Adding gemographcis p-value:" , summary(lme_a4_sens_demo)$tTable["time_mri:delta", "p-value"])
```

### Change from baseline

Changing the model's outcome to be change from baseline PACC and adding baseline PACC as covariate as well as the other covariates.

```{r}
lme_a4_sens_change <- lme(PACC_change ~ I(time_mri^2) 
                          + time_mri*delta 
                          + Cumulative_Dose_Scaled 
                          + time_mri*cohort 
                          + LMSTORY 
                          + time_mri*mri_age 
                          + time_mri*sex 
                          + time_mri*e4_carrier 
                          + time_mri*PACC_mri, 
                          data = data_a4, 
                          random = ~ 0 + time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Change from baseline p-value:" , summary(lme_a4_sens_change)$tTable["time_mri:delta", "p-value"])
```

## Interactions {.tabset}

### AB-PET

```{r}
# Create linear mixed effects model for interaction of delta with Amyloid
lme_a4_ab <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*ab_composite 
                  + Cumulative_Dose_Scaled 
                  + time_mri*cohort 
                  + LMSTORY, 
                  data = data_a4, 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'));

# Extract information of interest
a4_ab_results = summary(lme_a4_ab)$tTable
a4_ab_effects <- data.frame(
    model = "A4/LEARN",
    ab.term = "BrainAge delta X AB-PET",
    ab.estimate = a4_ab_results["time_mri:delta:ab_composite", "Value"],
    ab.std.error = a4_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.lower_ci = a4_ab_results["time_mri:delta:ab_composite", "Value"] 
                      - 1.96 * a4_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.upper_ci = a4_ab_results["time_mri:delta:ab_composite", "Value"] 
                      + 1.96 * a4_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.p_value = a4_ab_results["time_mri:delta:ab_composite", "p-value"]
  )
cat("BrainAge delta * AB effect:", signif(a4_ab_effects$ab.estimate, 2), 
    "±", signif(a4_ab_effects$ab.std.error, 2), 
    " p-val:", signif(a4_ab_effects$ab.p_value, 2), "\n")

# Plot model
a4_ab_p <- plot(ggpredict(lme_a4_ab, terms = c("time_mri [all]", "delta", "ab_composite"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, a4_max_time)) + 
  scale_y_continuous(limits = c(-3, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
a4_ab_mean = mean(data_a4$ab_composite, na.rm = TRUE)
a4_ab_sd = sd(data_a4$ab_composite, na.rm = TRUE)
ab_levels <- c(
  sprintf("Aβ-PET = %.2f ", a4_ab_mean - a4_ab_sd),
  sprintf("Aβ-PET = %.2f ", a4_ab_mean),
  sprintf("Aβ-PET = %.2f ", a4_ab_mean + a4_ab_sd)
)
a4_ab_p$data$facet <- ab_levels

a4_ab_p

# Save model
a4_ab_p <- a4_ab_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.05, 0.05, 0.05, 0.05), "cm"),
    ) 
ggsave(paste(path, 'lme_a4_ab.png'), a4_ab_p, 
       width = 125, height = 55, units = "mm", 
       dpi = 500,   # Higher resolution
       scale = 1)
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_a4_ab_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ab_composite 
                           + Cumulative_Dose_Scaled 
                           + LMSTORY 
                           + time_mri*cohort 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_a4, 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_a4_ab_sens_demo)$tTable["time_mri:delta:ab_composite", "p-value"])
```

Keeping only participants with Aβ-PET within 1 year of MRI.

```{r}
lme_a4_ab_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ab_composite 
                           + Cumulative_Dose_Scaled 
                           + LMSTORY 
                           + time_mri*cohort 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_a4[data_a4$time_diff_ab <=1 & data_a4$time_diff_ab >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_a4_ab_sens_time)$tTable["time_mri:delta:ab_composite", "p-value"])
```

### pTau217

```{r}
# Create linear mixed effects model for interaction of delta with pTau217
lme_a4_ptau <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*ptau 
                  + Cumulative_Dose_Scaled 
                  + time_mri*cohort 
                  + LMSTORY, 
                  data = data_a4[data_a4$exploratory == 1,], 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'),
                  control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
a4_ptau_results = summary(lme_a4_ptau)$tTable
a4_ptau_effects <- data.frame(
    model = "A4/LEARN",
    ptau.term = "BrainAge delta X pTau217",
    ptau.estimate = a4_ptau_results["time_mri:delta:ptau", "Value"],
    ptau.std.error = a4_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.lower_ci = a4_ptau_results["time_mri:delta:ptau", "Value"] 
                      - 1.96 * a4_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.upper_ci = a4_ptau_results["time_mri:delta:ptau", "Value"] 
                      + 1.96 * a4_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.p_value = a4_ptau_results["time_mri:delta:ptau", "p-value"]
  )
cat("BrainAge delta * pTau217 effect:", signif(a4_ptau_effects$ptau.estimate, 2), 
    "±", signif(a4_ptau_effects$ptau.std.error, 2), 
    " p-val:", signif(a4_ptau_effects$ptau.p_value, 2), "\n")

# Plot model
a4_ptau_p <- plot(ggpredict(lme_a4_ptau, terms = c("time_mri [all]", "delta", "ptau"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, a4_max_time)) + 
  scale_y_continuous(limits = c(-3, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
a4_ptau_mean = mean(data_a4[data_a4$exploratory == 1,]$ptau, na.rm = TRUE)
a4_ptau_sd = sd(data_a4[data_a4$exploratory == 1,]$ptau, na.rm = TRUE)
ptau_levels <- c(
  sprintf("pTau217 = %.2f ", a4_ptau_mean - a4_ptau_sd),
  sprintf("pTau217 = %.2f ", a4_ptau_mean),
  sprintf("pTau217 = %.2f ", a4_ptau_mean + a4_ptau_sd)
)
a4_ptau_p$data$facet <- ptau_levels

a4_ptau_p

# Save model
a4_ptau_p <- a4_ptau_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.05, 0.05, 0.05, 0.05), "cm"),
    ) 
ggsave(paste(path, 'lme_a4_ptau.png'), a4_ptau_p, 
       width = 125, height = 55, units = "mm", 
       dpi = 500,   # Higher resolution
       scale = 1)
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_a4_ptau_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ptau
                           + Cumulative_Dose_Scaled 
                           + LMSTORY 
                           + time_mri*cohort 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_a4[data_a4$exploratory == 1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_a4_ptau_sens_demo)$tTable["time_mri:delta:ptau", "p-value"])
```

Keeping only participants with ptau217 within 1 year of MRI.

```{r}
lme_a4_ptau_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ptau 
                           + Cumulative_Dose_Scaled 
                           + LMSTORY 
                           + time_mri*cohort 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_a4[data_a4$exploratory == 1 
                                         & data_a4$time_diff_ptau <=1 & data_a4$time_diff_ptau >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_a4_ptau_sens_time)$tTable["time_mri:delta:ptau", "p-value"])
```

### Tau-PET

```{r}
# Create linear mixed effects model for interaction of delta with Tau-PET
lme_a4_tau <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*tau_composite 
                  + Cumulative_Dose_Scaled 
                  + time_mri*cohort 
                  + LMSTORY, 
                  data = data_a4[data_a4$exploratory == 1,], 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'),
                  control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
a4_tau_results = summary(lme_a4_tau)$tTable
a4_tau_effects <- data.frame(
    model = "A4/LEARN",
    tau.term = "BrainAge delta X Tau-PET",
    tau.estimate = a4_tau_results["time_mri:delta:tau_composite", "Value"],
    tau.std.error = a4_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.lower_ci = a4_tau_results["time_mri:delta:tau_composite", "Value"] 
                      - 1.96 * a4_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.upper_ci = a4_tau_results["time_mri:delta:tau_composite", "Value"] 
                      + 1.96 * a4_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.p_value = a4_tau_results["time_mri:delta:tau_composite", "p-value"]
  )
cat("BrainAge delta * Tau-PET effect:", signif(a4_tau_effects$tau.estimate, 2), 
    "±", signif(a4_tau_effects$tau.std.error, 2), 
    " p-val:", signif(a4_tau_effects$tau.p_value, 2), "\n")

# Plot model
a4_tau_p <- plot(ggpredict(lme_a4_tau, terms = c("time_mri [all]", "delta", "tau_composite "))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, a4_max_time)) + 
  scale_y_continuous(limits = c(-3, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
a4_tau_mean = mean(data_a4[data_a4$exploratory == 1,]$tau_composite , na.rm = TRUE)
a4_tau_sd = sd(data_a4[data_a4$exploratory == 1,]$tau_composite , na.rm = TRUE)
tau_levels <- c(
  sprintf("Tau-PET = %.2f ", a4_tau_mean - a4_tau_sd),
  sprintf("Tau-PET = %.2f ", a4_tau_mean),
  sprintf("Tau-PET = %.2f ", a4_tau_mean + a4_tau_sd)
)
a4_tau_p$data$facet <- tau_levels

a4_tau_p

# Save model
a4_tau_p <- a4_tau_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.05, 0.05, 0.05, 0.05), "cm"),
    ) 
ggsave(paste(path, 'lme_a4_tau.png'), a4_tau_p, 
       width = 125, height = 55, units = "mm", 
       dpi = 500,   # Higher resolution
       scale = 1)
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_a4_tau_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*tau_composite 
                           + Cumulative_Dose_Scaled 
                           + LMSTORY 
                           + time_mri*cohort 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_a4[data_a4$exploratory == 1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_a4_tau_sens_demo)$tTable["time_mri:delta:tau_composite", "p-value"])
```

Keeping only participants with Tau-PET within 1 year of MRI.

```{r}
lme_a4_tau_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*tau_composite  
                           + Cumulative_Dose_Scaled 
                           + LMSTORY 
                           + time_mri*cohort 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_a4[data_a4$exploratory == 1 
                                         & data_a4$time_diff_tau <=1 & data_a4$time_diff_tau >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_a4_tau_sens_time)$tTable["time_mri:delta:tau_composite", "p-value"])
```

### Delta Threshold

```{r}
adni_formula = "I(time_mri^2) + time_mri*delta_status + Cumulative_Dose_Scaled + time_mri*cohort"
adni_random_formula = " ~ time_mri|ID"
mean_adni_delta_cn = mean(data_a4$delta, na.rm = TRUE)
sd_adni_delta_cn = sd(data_a4$delta, na.rm = TRUE)
results_a4 <- find_optimal_threshold(data_a4, seq(mean_adni_delta_cn-2*sd_adni_delta_cn, 
                                                    mean_adni_delta_cn + 2*sd_adni_delta_cn, by = 0.5), 
                                   outcome = "PACC", 
                                   measure = "delta", 
                                   fixed_formula = adni_formula, 
                                   random_formula = adni_random_formula)
print(results_a4$optimal_threshold)
print(results_a4$plot)
print((results_a4$optimal_threshold - mean_adni_delta_cn) / sd_adni_delta_cn)
```

# HABS

## Trajectories

Plot individual PACC trajectories with spaghetti plot.

```{r}
# Plot Trajectories
trajectories_habs <- ggplot(data_habs, aes(x = time_mri, y = PACC, group = ID, colour = delta_group)) +
  labs(x = 'Time from MRI (years)', 
       y = 'PACC',
       colour = 'BrainAge delta') +
  scale_colour_discrete(labels = c("Older      (>0)", "Younger (<0)")) +
  theme_minimal()

# Show with poitns and lines
trajectories_habs + geom_line() + geom_point()

# Save plot
trajectories_habs <- trajectories_habs + 
  geom_line(linewidth = 0.2) +
  geom_point(size = 0.2) +
    theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm"),
    ) 
ggsave(paste(path, 'trajectories_habs.png'), trajectories_habs, 
       width = 125, height = 50, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

## Mixed Effects Model

Simplest Quadratic mixed effects models with delta interaction:

PACC \~ time_mri\^2 + time_mriXdelta

```{r}
# Create linear mixed effects model for HABS 
lme_habs <- lme(PACC ~ I(time_mri^2) 
              + time_mri*delta, 
              data = data_habs, 
              random = ~time_mri|ID, 
              na.action = 'na.omit', 
              method = c('ML'),
              control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
habs_results = summary(lme_habs)$tTable
habs_delta_effects <- data.frame(
    model = "HABS",
    delta.term = "BrainAge delta",
    delta.estimate = habs_results["time_mri:delta", "Value"],
    delta.std.error = habs_results["time_mri:delta", "Std.Error"],
    delta.lower_ci = habs_results["time_mri:delta", "Value"] 
                      - 1.96 * habs_results["time_mri:delta", "Std.Error"],
    delta.upper_ci = habs_results["time_mri:delta", "Value"]
                      + 1.96 * habs_results["time_mri:delta", "Std.Error"],
    delta.p_value = habs_results["time_mri:delta", "p-value"]
  )
cat("Delta effect:", signif(habs_delta_effects$delta.estimate, 2), 
    "±", signif(habs_delta_effects$delta.std.error, 2), 
    " p-val:", signif(habs_delta_effects$delta.p_value, 2), "\n")


# Plot model
habs_p <- plot(ggpredict(lme_habs, terms = c("time_mri [all]", "delta"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, max_time)) + 
  scale_y_continuous(limits = c(-3.5, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )
habs_p

# Save model
habs_p <- habs_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.05, 0.05, 0.05, 0.05), "cm"),
    ) 
ggsave(paste(path, 'lme_habs.png'), habs_p, 
       width = 125, height = 50, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

## Sensitivity Analysis {.tabset}

### Linear vs Quadratic

```{r}
lme_habs_linear <- lme(PACC ~ time_mri*delta,
                             data = data_habs, 
                             random = ~time_mri|ID, 
                             na.action = 'na.omit', method = c('ML'),
                             control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
anova(lme_habs_linear, lme_habs)
```

### Age, e4 and amyloid

Add Age, AB_status, APOE, Sex, Education:

```{r}
lme_habs_sens_demo <- lme(PACC ~ I(time_mri^2) 
                        + time_mri*delta
                        + time_mri*mri_age
                        + time_mri*ab_status
                        + time_mri*e4_carrier 
                        + time_mri*sex 
                        + time_mri*edu, 
                        data = data_habs, 
                        random = ~time_mri|ID, 
                        na.action = 'na.omit', 
                        method = c('ML'),
                        control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Adding gemographcis p-value:" , summary(lme_habs_sens_demo)$tTable["time_mri:delta", "p-value"])
```

### Change from baseline

Changing the model's outcome to be change from baseline PACC and adding baseline PACC as covariate as well as the other covariates.

```{r}
lme_habs_sens_change <- lme(PACC_change ~ I(time_mri^2) 
                          + time_mri*delta
                          + time_mri*mri_age
                          + time_mri*ab_status
                          + time_mri*sex 
                          + time_mri*e4_carrier 
                          + time_mri*PACC_mri, 
                          data = data_habs, 
                          random = ~ 0 + time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Change from baseline p-value:" , summary(lme_habs_sens_change)$tTable["time_mri:delta", "p-value"])
```

## Interactions {.tabset}

### AB-PET

```{r}
# Create linear mixed effects model for interaction of delta with Amyloid
lme_habs_ab <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*ab_composite, 
                  data = data_habs, 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'));

# Extract information of interest
habs_ab_results = summary(lme_habs_ab)$tTable
habs_ab_effects <- data.frame(
    model = "HABS",
    ab.term = "BrainAge delta X AB-PET",
    ab.estimate = habs_ab_results["time_mri:delta:ab_composite", "Value"],
    ab.std.error = habs_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.lower_ci = habs_ab_results["time_mri:delta:ab_composite", "Value"] 
                      - 1.96 * habs_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.upper_ci = habs_ab_results["time_mri:delta:ab_composite", "Value"] 
                      + 1.96 * habs_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.p_value = habs_ab_results["time_mri:delta:ab_composite", "p-value"]
  )
cat("BrainAge delta * AB effect:", signif(habs_ab_effects$ab.estimate, 2), 
    "±", signif(habs_ab_effects$ab.std.error, 2), 
    " p-val:", signif(habs_ab_effects$ab.p_value, 2), "\n")

# Plot model
habs_ab_p <- plot(ggpredict(lme_habs_ab, terms = c("time_mri [all]", "delta", "ab_composite"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, habs_max_time)) + 
  scale_y_continuous(limits = c(-3, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
habs_ab_mean = mean(data_habs$ab_composite, na.rm = TRUE)
habs_ab_sd = sd(data_habs$ab_composite, na.rm = TRUE)
ab_levels <- c(
  sprintf("Aβ-PET = %.2f ", habs_ab_mean - habs_ab_sd),
  sprintf("Aβ-PET = %.2f ", habs_ab_mean),
  sprintf("Aβ-PET = %.2f ", habs_ab_mean + habs_ab_sd)
)
habs_ab_p$data$facet <- ab_levels

habs_ab_p
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_habs_ab_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ab_composite 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_habs, 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_habs_ab_sens_demo)$tTable["time_mri:delta:ab_composite", "p-value"])
```

Keeping only participants with Aβ-PET within 1 year of MRI.

```{r}
lme_habs_ab_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ab_composite 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_habs[data_habs$time_diff_ab <=1 & data_habs$time_diff_ab >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_habs_ab_sens_time)$tTable["time_mri:delta:ab_composite", "p-value"])
```

### pTau217

```{r}
# Create linear mixed effects model for interaction of delta with pTau217
lme_habs_ptau <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*ptau, 
                  data = data_habs[data_habs$exploratory == 1,], 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'),
                  control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
habs_ptau_results = summary(lme_habs_ptau)$tTable
habs_ptau_effects <- data.frame(
    model = "HABS",
    ptau.term = "BrainAge delta X pTau217",
    ptau.estimate = habs_ptau_results["time_mri:delta:ptau", "Value"],
    ptau.std.error = habs_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.lower_ci = habs_ptau_results["time_mri:delta:ptau", "Value"] 
                      - 1.96 * habs_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.upper_ci = habs_ptau_results["time_mri:delta:ptau", "Value"] 
                      + 1.96 * habs_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.p_value = habs_ptau_results["time_mri:delta:ptau", "p-value"]
  )
cat("BrainAge delta * pTau217 effect:", signif(habs_ptau_effects$ptau.estimate, 2), 
    "±", signif(habs_ptau_effects$ptau.std.error, 2), 
    " p-val:", signif(habs_ptau_effects$ptau.p_value, 2), "\n")

# Plot model
habs_ptau_p <- plot(ggpredict(lme_habs_ptau, terms = c("time_mri [all]", "delta", "ptau"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, habs_max_time)) + 
  scale_y_continuous(limits = c(-3, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
habs_ptau_mean = mean(data_habs[data_habs$exploratory == 1,]$ptau, na.rm = TRUE)
habs_ptau_sd = sd(data_habs[data_habs$exploratory == 1,]$ptau, na.rm = TRUE)
ptau_levels <- c(
  sprintf("pTau217 = %.2f ", habs_ptau_mean - habs_ptau_sd),
  sprintf("pTau217 = %.2f ", habs_ptau_mean),
  sprintf("pTau217 = %.2f ", habs_ptau_mean + habs_ptau_sd)
)
habs_ptau_p$data$facet <- ptau_levels

habs_ptau_p
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_habs_ptau_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ptau
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_habs[data_habs$exploratory == 1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_habs_ptau_sens_demo)$tTable["time_mri:delta:ptau", "p-value"])
```

Keeping only participants with pTau217 within 1 year of MRI.

```{r}
lme_habs_ptau_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ptau
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_habs[data_habs$exploratory == 1 
                                         & data_habs$time_diff_ptau <=1 & data_habs$time_diff_ptau >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_habs_ptau_sens_time)$tTable["time_mri:delta:ptau", "p-value"])
```

### Tau-PET

```{r}
# Create linear mixed effects model for interaction of delta with Tau-PET
lme_habs_tau <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*tau_composite, 
                  data = data_habs[data_habs$exploratory == 1,], 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'),
                  control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
habs_tau_results = summary(lme_habs_tau)$tTable
habs_tau_effects <- data.frame(
    model = "HABS",
    tau.term = "BrainAge delta X Tau-PET",
    tau.estimate = habs_tau_results["time_mri:delta:tau_composite", "Value"],
    tau.std.error = habs_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.lower_ci = habs_tau_results["time_mri:delta:tau_composite", "Value"] 
                      - 1.96 * habs_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.upper_ci = habs_tau_results["time_mri:delta:tau_composite", "Value"] 
                      + 1.96 * habs_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.p_value = habs_tau_results["time_mri:delta:tau_composite", "p-value"]
  )
cat("BrainAge delta * Tau-PET effect:", signif(habs_tau_effects$tau.estimate, 2), 
    "±", signif(habs_tau_effects$tau.std.error, 2), 
    " p-val:", signif(habs_tau_effects$tau.p_value, 2), "\n")

# Plot model
habs_tau_p <- plot(ggpredict(lme_habs_tau, terms = c("time_mri [all]", "delta", "tau_composite "))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, habs_max_time)) + 
  scale_y_continuous(limits = c(-3, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
habs_tau_mean = mean(data_habs[data_habs$exploratory == 1,]$tau_composite , na.rm = TRUE)
habs_tau_sd = sd(data_habs[data_habs$exploratory == 1,]$tau_composite , na.rm = TRUE)
tau_levels <- c(
  sprintf("Tau-PET = %.2f ", habs_tau_mean - habs_tau_sd),
  sprintf("Tau-PET = %.2f ", habs_tau_mean),
  sprintf("Tau-PET = %.2f ", habs_tau_mean + habs_tau_sd)
)
habs_tau_p$data$facet <- tau_levels

habs_tau_p
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_habs_tau_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*tau_composite
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_habs[data_habs$exploratory == 1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_habs_tau_sens_demo)$tTable["time_mri:delta:tau_composite", "p-value"])
```

Keeping only participants with Tau-PET within 1 year of MRI.

```{r}
lme_habs_tau_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*tau_composite 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_habs[data_habs$exploratory == 1 
                                         & data_habs$time_diff_tau <=1 & data_habs$time_diff_tau >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_habs_tau_sens_time)$tTable["time_mri:delta:tau_composite", "p-value"])
```

### Delta Threshold

```{r}
adni_formula = "time_mri*delta_status"
adni_random_formula = " ~ time_mri|ID"
mean_adni_delta_cn = mean(data_habs$delta, na.rm = TRUE)
sd_adni_delta_cn = sd(data_habs$delta, na.rm = TRUE)
results_habs <- find_optimal_threshold(data_habs, seq(mean_adni_delta_cn-2*sd_adni_delta_cn, 
                                                    mean_adni_delta_cn + 2*sd_adni_delta_cn, by = 0.5), 
                                   outcome = "PACC", 
                                   measure = "delta", 
                                   fixed_formula = adni_formula, 
                                   random_formula = adni_random_formula)
print(results_habs$optimal_threshold)
print(results_habs$plot)
print((results_habs$optimal_threshold - mean_adni_delta_cn) / sd_adni_delta_cn)
```

# ADNI CU

## Trajectories

Plot individual PACC trajectories with spaghetti plot.

```{r}
# Plot Trajectories
trajectories_adni_cn <- ggplot(data_adni_cn, aes(x = time_mri, y = PACC, group = ID, colour = delta_group)) +
  labs(x = 'Time from MRI (years)', 
       y = 'PACC',
       colour = 'BrainAge delta') +
  scale_colour_discrete(labels = c("Older      (>0)", "Younger (<0)")) +
  theme_minimal()

# Show with poitns and lines
trajectories_adni_cn + geom_line() + geom_point()

# Save plot
trajectories_adni_cn <- trajectories_adni_cn + 
  geom_line(linewidth = 0.2) +
  geom_point(size = 0.2) +
    theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm"),
    ) 
ggsave(paste(path, 'trajectories_adni_cn.png'), trajectories_adni_cn, 
       width = 125, height = 50, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

## Mixed Effects Model

Simplest Quadratic mixed effects models with delta interaction:

PACC \~ time_mri\^2 + time_mriXdelta

```{r}
# Create linear mixed effects model for ADNI CU
lme_adni_cn <- lme(PACC ~ I(time_mri^2) 
              + time_mri*delta, 
              data = data_adni_cn, 
              random = ~time_mri|ID, 
              na.action = 'na.omit', 
              method = c('ML'),
              control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
adni_cn_results = summary(lme_adni_cn)$tTable
adni_cn_delta_effects <- data.frame(
    model = "ADNI CU",
    delta.term = "BrainAge delta",
    delta.estimate = adni_cn_results["time_mri:delta", "Value"],
    delta.std.error = adni_cn_results["time_mri:delta", "Std.Error"],
    delta.lower_ci = adni_cn_results["time_mri:delta", "Value"] 
                      - 1.96 * adni_cn_results["time_mri:delta", "Std.Error"],
    delta.upper_ci = adni_cn_results["time_mri:delta", "Value"]
                      + 1.96 * adni_cn_results["time_mri:delta", "Std.Error"],
    delta.p_value = adni_cn_results["time_mri:delta", "p-value"]
  )
cat("Delta effect:", signif(adni_cn_delta_effects$delta.estimate, 2), 
    "±", signif(adni_cn_delta_effects$delta.std.error, 2), 
    " p-val:", signif(adni_cn_delta_effects$delta.p_value, 2), "\n")


# Plot model
adni_cn_p <- plot(ggpredict(lme_adni_cn, terms = c("time_mri [all]", "delta"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, max_time)) + 
  scale_y_continuous(limits = c(-3.5, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )
adni_cn_p

# Save model
adni_cn_p <- adni_cn_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.05, 0.05, 0.05, 0.05), "cm"),
    ) 
ggsave(paste(path, 'lme_adni_cn.png'), adni_cn_p, 
       width = 125, height = 50, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

## Sensitivity Analysis {.tabset}

### Linear vs Quadratic

```{r}
lme_adni_cn_linear <- lme(PACC ~ time_mri*delta,
                             data = data_adni_cn, 
                             random = ~time_mri|ID, 
                             na.action = 'na.omit', method = c('ML'),
                             control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
anova(lme_adni_cn_linear, lme_adni_cn)
```

### Age, e4 and amyloid

Add Age, AB_status, APOE, Sex, Education:

```{r}
lme_adni_cn_sens_demo <- lme(PACC ~ I(time_mri^2) 
                        + time_mri*delta
                        + time_mri*mri_age
                        + time_mri*ab_status
                        + time_mri*e4_carrier 
                        + time_mri*sex 
                        + time_mri*edu, 
                        data = data_adni_cn, 
                        random = ~time_mri|ID, 
                        na.action = 'na.omit', 
                        method = c('ML'),
                        control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Adding gemographcis p-value:" , summary(lme_adni_cn_sens_demo)$tTable["time_mri:delta", "p-value"])
```

### Change from baseline

Changing the model's outcome to be change from baseline PACC and adding baseline PACC as covariate as well as the other covariates.

```{r}
lme_adni_cn_sens_change <- lme(PACC_change ~ I(time_mri^2) 
                          + time_mri*delta
                          + time_mri*mri_age
                          + time_mri*ab_status
                          + time_mri*sex 
                          + time_mri*e4_carrier 
                          + time_mri*PACC_mri, 
                          data = data_adni_cn, 
                          random = ~ 0 + time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Change from baseline p-value:" , summary(lme_adni_cn_sens_change)$tTable["time_mri:delta", "p-value"])
```

## Interactions {.tabset}

### AB-PET

```{r}
# Create linear mixed effects model for interaction of delta with Amyloid
lme_adni_cn_ab <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*ab_composite, 
                  data = data_adni_cn, 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'));

# Extract information of interest
adni_cn_ab_results = summary(lme_adni_cn_ab)$tTable
adni_cn_ab_effects <- data.frame(
    model = "ADNI CU",
    ab.term = "BrainAge delta X AB-PET",
    ab.estimate = adni_cn_ab_results["time_mri:delta:ab_composite", "Value"],
    ab.std.error = adni_cn_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.lower_ci = adni_cn_ab_results["time_mri:delta:ab_composite", "Value"] 
                      - 1.96 * adni_cn_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.upper_ci = adni_cn_ab_results["time_mri:delta:ab_composite", "Value"] 
                      + 1.96 * adni_cn_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.p_value = adni_cn_ab_results["time_mri:delta:ab_composite", "p-value"]
  )
cat("BrainAge delta * AB effect:", signif(adni_cn_ab_effects$ab.estimate, 2), 
    "±", signif(adni_cn_ab_effects$ab.std.error, 2), 
    " p-val:", signif(adni_cn_ab_effects$ab.p_value, 2), "\n")

# Plot model
adni_cn_ab_p <- plot(ggpredict(lme_adni_cn_ab, terms = c("time_mri [all]", "delta", "ab_composite"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, adni_max_time)) + 
  scale_y_continuous(limits = c(-3, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
adni_cn_ab_mean = mean(data_adni_cn$ab_composite, na.rm = TRUE)
adni_cn_ab_sd = sd(data_adni_cn$ab_composite, na.rm = TRUE)
ab_levels <- c(
  sprintf("Aβ-PET = %.2f ", adni_cn_ab_mean - adni_cn_ab_sd),
  sprintf("Aβ-PET = %.2f ", adni_cn_ab_mean),
  sprintf("Aβ-PET = %.2f ", adni_cn_ab_mean + adni_cn_ab_sd)
)
adni_cn_ab_p$data$facet <- ab_levels

adni_cn_ab_p
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_adni_cn_ab_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ab_composite 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_cn, 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_adni_cn_ab_sens_demo)$tTable["time_mri:delta:ab_composite", "p-value"])
```

Keeping only participants with Aβ-PET within 1 year of MRI.

```{r}
lme_adni_cn_ab_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ab_composite 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_cn[data_adni_cn$time_diff_ab <=1 & data_adni_cn$time_diff_ab >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_adni_cn_ab_sens_time)$tTable["time_mri:delta:ab_composite", "p-value"])
```

### pTau217

```{r}
# Create linear mixed effects model for interaction of delta with pTau217
lme_adni_cn_ptau <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*ptau, 
                  data = data_adni_cn[data_adni_cn$exploratory == 1,], 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'),
                  control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
adni_cn_ptau_results = summary(lme_adni_cn_ptau)$tTable
adni_cn_ptau_effects <- data.frame(
    model = "ADNI CU",
    ptau.term = "BrainAge delta X pTau217",
    ptau.estimate = adni_cn_ptau_results["time_mri:delta:ptau", "Value"],
    ptau.std.error = adni_cn_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.lower_ci = adni_cn_ptau_results["time_mri:delta:ptau", "Value"] 
                      - 1.96 * adni_cn_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.upper_ci = adni_cn_ptau_results["time_mri:delta:ptau", "Value"] 
                      + 1.96 * adni_cn_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.p_value = adni_cn_ptau_results["time_mri:delta:ptau", "p-value"]
  )
cat("BrainAge delta * pTau217 effect:", signif(adni_cn_ptau_effects$ptau.estimate, 2), 
    "±", signif(adni_cn_ptau_effects$ptau.std.error, 2), 
    " p-val:", signif(adni_cn_ptau_effects$ptau.p_value, 2), "\n")

# Plot model
adni_cn_ptau_p <- plot(ggpredict(lme_adni_cn_ptau, terms = c("time_mri [all]", "delta", "ptau"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, adni_max_time)) + 
  scale_y_continuous(limits = c(-3, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
adni_cn_ptau_mean = mean(data_adni_cn[data_adni_cn$exploratory == 1,]$ptau, na.rm = TRUE)
adni_cn_ptau_sd = sd(data_adni_cn[data_adni_cn$exploratory == 1,]$ptau, na.rm = TRUE)
ptau_levels <- c(
  sprintf("pTau217 = %.3f ", adni_cn_ptau_mean - adni_cn_ptau_sd),
  sprintf("pTau217 = %.3f ", adni_cn_ptau_mean),
  sprintf("pTau217 = %.3f ", adni_cn_ptau_mean + adni_cn_ptau_sd)
)
adni_cn_ptau_p$data$facet <- ptau_levels

adni_cn_ptau_p
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_adni_cn_ptau_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ptau
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_cn[data_adni_cn$exploratory == 1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_adni_cn_ptau_sens_demo)$tTable["time_mri:delta:ptau", "p-value"])
```

Keeping only participants with pTau217 within 1 year of MRI.

```{r}
lme_adni_cn_ptau_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ptau
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_cn[data_adni_cn$exploratory == 1 
                                         & data_adni_cn$time_diff_ptau <=1 & data_adni_cn$time_diff_ptau >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_adni_cn_ptau_sens_time)$tTable["time_mri:delta:ptau", "p-value"])
```

### Tau-PET

```{r}
# Create linear mixed effects model for interaction of delta with Tau-PET
lme_adni_cn_tau <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*tau_composite, 
                  data = data_adni_cn[data_adni_cn$exploratory == 1,], 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'),
                  control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
adni_cn_tau_results = summary(lme_adni_cn_tau)$tTable
adni_cn_tau_effects <- data.frame(
    model = "ADNI CU",
    tau.term = "BrainAge delta X Tau-PET",
    tau.estimate = adni_cn_tau_results["time_mri:delta:tau_composite", "Value"],
    tau.std.error = adni_cn_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.lower_ci = adni_cn_tau_results["time_mri:delta:tau_composite", "Value"] 
                      - 1.96 * adni_cn_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.upper_ci = adni_cn_tau_results["time_mri:delta:tau_composite", "Value"] 
                      + 1.96 * adni_cn_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.p_value = adni_cn_tau_results["time_mri:delta:tau_composite", "p-value"]
  )
cat("BrainAge delta * Tau-PET effect:", signif(adni_cn_tau_effects$tau.estimate, 2), 
    "±", signif(adni_cn_tau_effects$tau.std.error, 2), 
    " p-val:", signif(adni_cn_tau_effects$tau.p_value, 2), "\n")

# Plot model
adni_cn_tau_p <- plot(ggpredict(lme_adni_cn_tau, terms = c("time_mri [all]", "delta", "tau_composite "))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, adni_max_time)) + 
  scale_y_continuous(limits = c(-3, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
adni_cn_tau_mean = mean(data_adni_cn[data_adni_cn$exploratory == 1,]$tau_composite , na.rm = TRUE)
adni_cn_tau_sd = sd(data_adni_cn[data_adni_cn$exploratory == 1,]$tau_composite , na.rm = TRUE)
tau_levels <- c(
  sprintf("Tau-PET = %.2f ", adni_cn_tau_mean - adni_cn_tau_sd),
  sprintf("Tau-PET = %.2f ", adni_cn_tau_mean),
  sprintf("Tau-PET = %.2f ", adni_cn_tau_mean + adni_cn_tau_sd)
)
adni_cn_tau_p$data$facet <- tau_levels

adni_cn_tau_p
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_adni_cn_tau_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*tau_composite
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_cn[data_adni_cn$exploratory == 1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_adni_cn_tau_sens_demo)$tTable["time_mri:delta:tau_composite", "p-value"])
```

Keeping only participants with Tau-PET within 1 year of MRI.

```{r}
lme_adni_cn_tau_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*tau_composite 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_cn[data_adni_cn$exploratory == 1 
                                         & data_adni_cn$time_diff_tau <=1 & data_adni_cn$time_diff_tau >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_adni_cn_tau_sens_time)$tTable["time_mri:delta:tau_composite", "p-value"])
```

### Delta Threshold

```{r}
adni_formula = "time_mri*delta_status"
adni_random_formula = " ~ time_mri|ID"
mean_adni_delta_cn = mean(data_adni_cn$delta, na.rm = TRUE)
sd_adni_delta_cn = sd(data_adni_cn$delta, na.rm = TRUE)
results_adni_cn <- find_optimal_threshold(data_adni_cn, seq(mean_adni_delta_cn-2*sd_adni_delta_cn, 
                                                    mean_adni_delta_cn + 2*sd_adni_delta_cn, by = 0.5), 
                                   outcome = "PACC", 
                                   measure = "delta", 
                                   fixed_formula = adni_formula, 
                                   random_formula = adni_random_formula)
print(results_adni_cn$optimal_threshold)
print(results_adni_cn$plot)
print((results_adni_cn$optimal_threshold - mean_adni_delta_cn) / sd_adni_delta_cn)
```

# ADNI MCI

## Trajectories

Plot individual PACC trajectories with spaghetti plot.

```{r}
# Plot Trajectories
trajectories_adni_mci <- ggplot(data_adni_mci, aes(x = time_mri, y = PACC, group = ID, colour = delta_group)) +
  labs(x = 'Time from MRI (years)', 
       y = 'PACC',
       colour = 'BrainAge delta') +
  scale_colour_discrete(labels = c("Older      (>0)", "Younger (<0)")) +
  theme_minimal()

# Show with poitns and lines
trajectories_adni_mci + geom_line() + geom_point()

# Save plot
trajectories_adni_mci <- trajectories_adni_mci + 
  geom_line(linewidth = 0.2) +
  geom_point(size = 0.2) +
    theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm"),
    ) 
ggsave(paste(path, 'trajectories_adni_mci.png'), trajectories_adni_mci, 
       width = 125, height = 50, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

## Mixed Effects Model

Simplest Quadratic mixed effects models with delta interaction:

PACC \~ time_mri\^2 + time_mriXdelta

```{r}
# Create linear mixed effects model for ADNI MCI 
lme_adni_mci <- lme(PACC ~ I(time_mri^2) 
              + time_mri*delta, 
              data = data_adni_mci, 
              random = ~time_mri|ID, 
              na.action = 'na.omit', 
              method = c('ML'),
              control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
adni_mci_results = summary(lme_adni_mci)$tTable
adni_mci_delta_effects <- data.frame(
    model = "ADNI MCI",
    delta.term = "BrainAge delta",
    delta.estimate = adni_mci_results["time_mri:delta", "Value"],
    delta.std.error = adni_mci_results["time_mri:delta", "Std.Error"],
    delta.lower_ci = adni_mci_results["time_mri:delta", "Value"] 
                      - 1.96 * adni_mci_results["time_mri:delta", "Std.Error"],
    delta.upper_ci = adni_mci_results["time_mri:delta", "Value"]
                      + 1.96 * adni_mci_results["time_mri:delta", "Std.Error"],
    delta.p_value = adni_mci_results["time_mri:delta", "p-value"]
  )
cat("Delta effect:", signif(adni_mci_delta_effects$delta.estimate, 2), 
    "±", signif(adni_mci_delta_effects$delta.std.error, 2), 
    " p-val:", signif(adni_mci_delta_effects$delta.p_value, 2), "\n")


# Plot model
adni_mci_p <- plot(ggpredict(lme_adni_mci, terms = c("time_mri [all]", "delta"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, max_time)) + 
  scale_y_continuous(limits = c(min_pacc, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )
adni_mci_p

# Save model
adni_mci <- adni_mci_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.05, 0.05, 0.05, 0.05), "cm"),
    ) 
ggsave(paste(path, 'lme_adni_mci.png'), adni_mci_p, 
       width = 125, height = 50, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1) 
```

## Sensitivity Analysis {.tabset}

### Linear vs Quadratic

```{r}
lme_adni_mci_linear <- lme(PACC ~ time_mri*delta,
                             data = data_adni_mci, 
                             random = ~time_mri|ID, 
                             na.action = 'na.omit', method = c('ML'),
                             control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
anova(lme_adni_mci_linear, lme_adni_mci)
```

### Age, e4 and amyloid

Add Age, AB_status, APOE, Sex, Education:

```{r}
lme_adni_mci_sens_demo <- lme(PACC ~ I(time_mri^2) 
                        + time_mri*delta
                        + time_mri*mri_age
                        + time_mri*ab_status
                        + time_mri*e4_carrier 
                        + time_mri*sex 
                        + time_mri*edu, 
                        data = data_adni_mci, 
                        random = ~time_mri|ID, 
                        na.action = 'na.omit', 
                        method = c('ML'),
                        control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Adding gemographcis p-value:" , summary(lme_adni_mci_sens_demo)$tTable["time_mri:delta", "p-value"])
```

### Change from baseline

Changing the model's outcome to be change from baseline PACC and adding baseline PACC as covariate as well as the other covariates.

```{r}
lme_adni_mci_sens_change <- lme(PACC_change ~ I(time_mri^2) 
                          + time_mri*delta
                          + time_mri*mri_age
                          + time_mri*ab_status
                          + time_mri*sex 
                          + time_mri*e4_carrier 
                          + time_mri*PACC_mri, 
                          data = data_adni_mci, 
                          random = ~ 0 + time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Change from baseline p-value:" , summary(lme_adni_mci_sens_change)$tTable["time_mri:delta", "p-value"])
```

## Interactions {.tabset}

### AB-PET

```{r}
# Create linear mixed effects model for interaction of delta with Amyloid
lme_adni_mci_ab <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*ab_composite, 
                  data = data_adni_mci, 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'));

# Extract information of interest
adni_mci_ab_results = summary(lme_adni_mci_ab)$tTable
adni_mci_ab_effects <- data.frame(
    model = "ADNI MCI",
    ab.term = "BrainAge delta X AB-PET",
    ab.estimate = adni_mci_ab_results["time_mri:delta:ab_composite", "Value"],
    ab.std.error = adni_mci_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.lower_ci = adni_mci_ab_results["time_mri:delta:ab_composite", "Value"] 
                      - 1.96 * adni_mci_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.upper_ci = adni_mci_ab_results["time_mri:delta:ab_composite", "Value"] 
                      + 1.96 * adni_mci_ab_results["time_mri:delta:ab_composite", "Std.Error"],
    ab.p_value = adni_mci_ab_results["time_mri:delta:ab_composite", "p-value"]
  )
cat("BrainAge delta * AB effect:", signif(adni_mci_ab_effects$ab.estimate, 2), 
    "±", signif(adni_mci_ab_effects$ab.std.error, 2), 
    " p-val:", signif(adni_mci_ab_effects$ab.p_value, 2), "\n")

# Plot model
adni_mci_ab_p <- plot(ggpredict(lme_adni_mci_ab, terms = c("time_mri [all]", "delta", "ab_composite"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, adni_max_time)) + 
  scale_y_continuous(limits = c(min_pacc, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
adni_mci_ab_mean = mean(data_adni_mci$ab_composite, na.rm = TRUE)
adni_mci_ab_sd = sd(data_adni_mci$ab_composite, na.rm = TRUE)
ab_levels <- c(
  sprintf("Aβ-PET = %.2f ", adni_mci_ab_mean - adni_mci_ab_sd),
  sprintf("Aβ-PET = %.2f ", adni_mci_ab_mean),
  sprintf("Aβ-PET = %.2f ", adni_mci_ab_mean + adni_mci_ab_sd)
)
adni_mci_ab_p$data$facet <- ab_levels

adni_mci_ab_p
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_adni_mci_ab_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ab_composite 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_mci, 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_adni_mci_ab_sens_demo)$tTable["time_mri:delta:ab_composite", "p-value"])
```

Keeping only participants with Aβ-PET within 1 year of MRI.

```{r}
lme_adni_mci_ab_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ab_composite 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_mci[data_adni_mci$time_diff_ab <=1 & data_adni_mci$time_diff_ab >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_adni_mci_ab_sens_time)$tTable["time_mri:delta:ab_composite", "p-value"])
```

### pTau217

```{r}
# Create linear mixed effects model for interaction of delta with pTau217
lme_adni_mci_ptau <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*ptau, 
                  data = data_adni_mci[data_adni_mci$exploratory == 1,], 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'),
                  control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
adni_mci_ptau_results = summary(lme_adni_mci_ptau)$tTable
adni_mci_ptau_effects <- data.frame(
    model = "ADNI MCI",
    ptau.term = "BrainAge delta X pTau217",
    ptau.estimate = adni_mci_ptau_results["time_mri:delta:ptau", "Value"],
    ptau.std.error = adni_mci_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.lower_ci = adni_mci_ptau_results["time_mri:delta:ptau", "Value"] 
                      - 1.96 * adni_mci_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.upper_ci = adni_mci_ptau_results["time_mri:delta:ptau", "Value"] 
                      + 1.96 * adni_mci_ptau_results["time_mri:delta:ptau", "Std.Error"],
    ptau.p_value = adni_mci_ptau_results["time_mri:delta:ptau", "p-value"]
  )
cat("BrainAge delta * pTau217 effect:", signif(adni_mci_ptau_effects$ptau.estimate, 2), 
    "±", signif(adni_mci_ptau_effects$ptau.std.error, 2), 
    " p-val:", signif(adni_mci_ptau_effects$ptau.p_value, 2), "\n")

# Plot model
adni_mci_ptau_p <- plot(ggpredict(lme_adni_mci_ptau, terms = c("time_mri [all]", "delta", "ptau"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, adni_max_time)) + 
  scale_y_continuous(limits = c(min_pacc, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
adni_mci_ptau_mean = mean(data_adni_mci[data_adni_mci$exploratory == 1,]$ptau, na.rm = TRUE)
adni_mci_ptau_sd = sd(data_adni_mci[data_adni_mci$exploratory == 1,]$ptau, na.rm = TRUE)
ptau_levels <- c(
  sprintf("pTau217 = %.3f ", adni_mci_ptau_mean - adni_mci_ptau_sd),
  sprintf("pTau217 = %.3f ", adni_mci_ptau_mean),
  sprintf("pTau217 = %.3f ", adni_mci_ptau_mean + adni_mci_ptau_sd)
)
adni_mci_ptau_p$data$facet <- ptau_levels

adni_mci_ptau_p
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_adni_mci_ptau_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ptau
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_mci[data_adni_mci$exploratory == 1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_adni_mci_ptau_sens_demo)$tTable["time_mri:delta:ptau", "p-value"])
```

Keeping only participants with pTau217 within 1 year of MRI.

```{r}
lme_adni_mci_ptau_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*ptau
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_mci[data_adni_mci$exploratory == 1 
                                         & data_adni_mci$time_diff_ptau <=1 & data_adni_mci$time_diff_ptau >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_adni_mci_ptau_sens_time)$tTable["time_mri:delta:ptau", "p-value"])
```

### Tau-PET

```{r}
# Create linear mixed effects model for interaction of delta with Tau-PET
lme_adni_mci_tau <- lme(PACC ~ I(time_mri^2) 
                  + time_mri*delta*tau_composite, 
                  data = data_adni_mci[data_adni_mci$exploratory == 1,], 
                  random = ~time_mri|ID, 
                  na.action = 'na.omit', 
                  method = c('ML'),
                  control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));

# Extract information of interest
adni_mci_tau_results = summary(lme_adni_mci_tau)$tTable
adni_mci_tau_effects <- data.frame(
    model = "ADNI MCI",
    tau.term = "BrainAge delta X Tau-PET",
    tau.estimate = adni_mci_tau_results["time_mri:delta:tau_composite", "Value"],
    tau.std.error = adni_mci_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.lower_ci = adni_mci_tau_results["time_mri:delta:tau_composite", "Value"] 
                      - 1.96 * adni_mci_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.upper_ci = adni_mci_tau_results["time_mri:delta:tau_composite", "Value"] 
                      + 1.96 * adni_mci_tau_results["time_mri:delta:tau_composite", "Std.Error"],
    tau.p_value = adni_mci_tau_results["time_mri:delta:tau_composite", "p-value"]
  )
cat("BrainAge delta * Tau-PET effect:", signif(adni_mci_tau_effects$tau.estimate, 2), 
    "±", signif(adni_mci_tau_effects$tau.std.error, 2), 
    " p-val:", signif(adni_mci_tau_effects$tau.p_value, 2), "\n")

# Plot model
adni_mci_tau_p <- plot(ggpredict(lme_adni_mci_tau, terms = c("time_mri [all]", "delta", "tau_composite "))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, adni_max_time)) + 
  scale_y_continuous(limits = c(min_pacc, max_pacc)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
    color = "BrainAge \ndelta (years)"
  )

# Change levels to be more readable
adni_mci_tau_mean = mean(data_adni_mci[data_adni_mci$exploratory == 1,]$tau_composite , na.rm = TRUE)
adni_mci_tau_sd = sd(data_adni_mci[data_adni_mci$exploratory == 1,]$tau_composite , na.rm = TRUE)
tau_levels <- c(
  sprintf("Tau-PET = %.2f ", adni_mci_tau_mean - adni_mci_tau_sd),
  sprintf("Tau-PET = %.2f ", adni_mci_tau_mean),
  sprintf("Tau-PET = %.2f ", adni_mci_tau_mean + adni_mci_tau_sd)
)
adni_mci_tau_p$data$facet <- tau_levels

adni_mci_tau_p
```

Adding Age, Sex, Education, E4 Status as covariates

```{r}
lme_adni_mci_tau_sens_demo <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*tau_composite
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_mci[data_adni_mci$exploratory == 1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'));
cat("Adding gemographcis p-value:" , summary(lme_adni_mci_tau_sens_demo)$tTable["time_mri:delta:tau_composite", "p-value"])
```

Keeping only participants with Tau-PET within 1 year of MRI.

```{r}
lme_adni_mci_tau_sens_time <- lme(PACC~ I(time_mri^2) 
                           + time_mri*delta*tau_composite 
                           + time_mri*mri_age 
                           + time_mri*e4_carrier 
                           + time_mri*sex 
                           + time_mri*edu, 
                          data = data_adni_mci[data_adni_mci$exploratory == 1 
                                         & data_adni_mci$time_diff_tau <=1 & data_adni_mci$time_diff_tau >=-1,], 
                          random = ~time_mri|ID, 
                          na.action = 'na.omit', 
                          method = c('ML'),
                          control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
cat("Participants within 1 year p-value:" , summary(lme_adni_mci_tau_sens_time)$tTable["time_mri:delta:tau_composite", "p-value"])
```

### Delta Threshold

```{r}
adni_formula = "time_mri*delta_status"
adni_random_formula = " ~ time_mri|ID"
mean_adni_delta_mci = mean(data_adni_mci$delta, na.rm = TRUE)
sd_adni_delta_mci = sd(data_adni_mci$delta, na.rm = TRUE)
results_adni_mci <- find_optimal_threshold(data_adni_mci, seq(mean_adni_delta_mci-2*sd_adni_delta_mci, 
                                                    mean_adni_delta_mci + 2*sd_adni_delta_mci, by = 0.5), 
                                   outcome = "PACC", 
                                   measure = "delta", 
                                   fixed_formula = adni_formula, 
                                   random_formula = adni_random_formula)
print(results_adni_mci$optimal_threshold)
print(results_adni_mci$plot)
print((results_adni_mci$optimal_threshold - mean_adni_delta_mci) / sd_adni_delta_mci)
print((results_adni_mci$optimal_threshold - mean_adni_delta_cn) / sd_adni_delta_cn)
```

# Summary {.tabset}

Forest plots to summarize all the information of linear mixed effects models

## Delta

```{r}
# Dataframe storing all the information
delta_interaction_results <- rbind(
  a4_delta_effects,
  habs_delta_effects,
  adni_cn_delta_effects,
  adni_mci_delta_effects
) %>% 
  mutate(model = factor(model, levels = c("ADNI MCI", "ADNI CU", "HABS", "A4/LEARN")))

# Create the forest plot
forest_plot <- ggplot(delta_interaction_results, aes(x = delta.estimate, y = model)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = delta.lower_ci, xmax = delta.upper_ci), height = 0.2) +   # 95% confidence intervals
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray") +
  labs(
    x = "β",
    y = "Cohort"
  ) +
  theme_minimal() +
  # Add effect size values to the plot 
  geom_text(aes(x = 0.01, 
                label = sprintf("%.2f [%.2f, %.2f], p = %.2g", 
                               delta.estimate, delta.lower_ci, delta.upper_ci, delta.p_value)),
            hjust = 0, size = 8 / .pt) +
  # Adjust x-axis from -0.05 to 0.025
  scale_x_continuous(limits = c(-0.05, 0.05)) 

# Print the plot
print(forest_plot)

# Save summary
forest_plot <- forest_plot +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm"),
    ) 
ggsave(paste(path, 'delta_forest.png'), forest_plot, 
       width = 125, height = 45, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1)
```

## AB-PET

```{r}
# Dataframe storing all the information
ab_interaction_results <- rbind(
  a4_ab_effects,
  habs_ab_effects,
  adni_cn_ab_effects,
  adni_mci_ab_effects
) %>% 
  mutate(model = factor(model, levels = c("ADNI MCI", "ADNI CU", "HABS", "A4/LEARN")))

# Create the forest plot
forest_plot <- ggplot(ab_interaction_results, aes(x = ab.estimate, y = model)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = ab.lower_ci, xmax = ab.upper_ci), height = 0.2) +   # 95% confidence intervals
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray") +
  labs(
    x = "β",
    y = "Cohort"
  ) +
  theme_minimal() +
  # Add effect size values to the plot 
  geom_text(aes(x = 0.01, 
                label = sprintf("%.2f [%.2f, %.2f], p = %.2g", 
                               ab.estimate, ab.lower_ci, ab.upper_ci, ab.p_value)),
            hjust = 0, size = 8 / .pt) +
  scale_x_continuous(limits = c(-0.125, 0.05)) 

# Print the plot
print(forest_plot)

# Save summary
forest_plot <- forest_plot +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm"),
    ) 
ggsave(paste(path, 'ab_forest.png'), forest_plot, 
       width = 90, height = 55, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1)
```


## pTau217

```{r}
# Dataframe storing all the information
ptau_interaction_results <- rbind(
  a4_ptau_effects,
  habs_ptau_effects,
  adni_cn_ptau_effects,
  adni_mci_ptau_effects
) %>% 
  mutate(model = factor(model, levels = c("ADNI MCI", "ADNI CU", "HABS", "A4/LEARN")))

# Create the forest plot
forest_plot <- ggplot(ptau_interaction_results, aes(x = ptau.estimate, y = model)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = ptau.lower_ci, xmax = ptau.upper_ci), height = 0.2) +   # 95% confidence intervals
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray") +
  labs(
    x = "β",
    y = "Cohort"
  ) +
  theme_minimal() +
  # Add effect size values to the plot 
  geom_text(aes(x = 0.01, 
                label = sprintf("%.2f [%.2f, %.2f], p = %.2g", 
                               ptau.estimate, ptau.lower_ci, ptau.upper_ci, ptau.p_value)),
            hjust = 0, size = 8 / .pt)

# Print the plot
print(forest_plot)

# Save summary
forest_plot <- forest_plot +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm"),
    ) 
ggsave(paste(path, 'ptau_forest.png'), forest_plot, 
       width = 90, height = 55, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1)
```

## Tau-PET

```{r}
# Dataframe storing all the information
tau_interaction_results <- rbind(
  a4_tau_effects,
  habs_tau_effects,
  adni_cn_tau_effects,
  adni_mci_tau_effects
) %>% 
  mutate(model = factor(model, levels = c("ADNI MCI", "ADNI CU", "HABS", "A4/LEARN")))

# Create the forest plot
forest_plot <- ggplot(tau_interaction_results, aes(x = tau.estimate, y = model)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = tau.lower_ci, xmax = tau.upper_ci), height = 0.2) +   # 95% confidence intervals
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray") +
  labs(
    x = "β",
    y = "Cohort"
  ) +
  theme_minimal() +
  # Add effect size values to the plot 
  geom_text(aes(x = 0.01, 
                label = sprintf("%.2f [%.2f, %.2f], p = %.2g", 
                               tau.estimate, tau.lower_ci, tau.upper_ci, tau.p_value)),
            hjust = 0, size = 8 / .pt)

# Print the plot
print(forest_plot)

# Save summary
forest_plot <- forest_plot +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm"),
    ) 
ggsave(paste(path, 'tau_forest.png'), forest_plot, 
       width = 90, height = 55, units = "mm", 
       dpi = 500,     # Higher resolution
       scale = 1)
```
