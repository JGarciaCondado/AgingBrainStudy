---
title: "Brain Age Longitudinal PACC"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('BrainAgeLongitudinalPACC.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/BrainAgeLongitudinalPACC', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr); library(dplyr);library(nlme);library(sjPlot);library(gtsummary); library(flextable); library(MuMIn); library(pwr)


knitr::opts_chunk$set(echo = FALSE, message = FALSE)
theme_set(theme_bw())
```

# Brain Age Longitudinal PACC

We will explore how baseline Brain Age delta moderates longitudinal PACC through a linear mixed effects model on A4/Learn and HABS data.

```{r}

# Load A4 data
data_A4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/processed/longitudinal_PACC.csv')

# Load factors
factors_A4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/processed/factors.csv')
factors_A4 <- factors_A4 %>% 
  select(BID, pTau217, amyloid_composite, tau_composite)
data_A4 <- merge(data_A4, factors_A4, by = 'BID', all.x = TRUE)

# Load covariates
covars_A4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/processed/covariates.csv')
covars_A4 <- covars_A4 %>% 
  select(BID, Amyloid)
data_A4 <- merge(data_A4, covars_A4, by = 'BID', all.x = TRUE)

# Filter subjects with less than 2 data points
data_A4 <- data_A4 %>% 
  arrange(BID, pacc_time) %>%  
  group_by(BID) %>% 
  add_tally(name = 'nTimePoints', wt = !is.na(PACC)) %>%
  filter(nTimePoints >= 2)

# Load deltas
delta_A4 <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/A4/structural_brainage/ageml/model_age/predicted_age_sex.csv')

# Merge the two datasets
data_A4 <- merge(data_A4, delta_A4, by = 'BID')

# Arrange by pacc_time and calculate PACC_change_bl
data_A4 <- data_A4 %>% 
  arrange(BID, pacc_time) %>%
  group_by(BID) %>%
  mutate(PACC_bl = PACC[1]) %>%
  mutate(PACC_change_bl = PACC - PACC_bl)

# Create new variable delta_group where is 0 below younger and older above zero
data_A4 <- data_A4 %>% 
  mutate(delta_group = ifelse(delta_all < 0, 'younger', 'older'))

# Create cohort variable
data_A4 <- data_A4 %>%
  group_by(BID) %>%
  dplyr::mutate(Cohort = case_when(
    SUBSTUDY == "SF" | SUBSTUDY == "LEARN" ~ "LEARN/SF",
    SUBSTUDY == "A4" & TX == "Placebo" ~ "A4 Placebo",
    SUBSTUDY == "A4" & TX == "Solanezumab" ~ "A4 Treated",
    TRUE ~ NA))

# Ensure variables are factors
data_A4 <- data_A4 %>%
  mutate_at(vars(SUBSTUDY, TX, Cohort, SEX, RACE, ETHNIC, APOE, APOEGN, QSVERSION_PACC), factor)

# Placebo data
data_placebo <- data_A4 %>% 
  filter(TX == 'Placebo' | SUBSTUDY != 'A4')
```

```{r}

# Load HABS data
data_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/HABS/raw/longitudinal_PACC.csv')

# Load delta
deltas_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/HABS/structural_brainage/ageml/model_age/predicted_age.csv')
data_habs <- merge(data_habs, deltas_habs, by = 'SubjIDshort', all.x = TRUE)

# Create new variable delta_group where is 0 below younger and older above zero
data_habs <- data_habs %>% 
  mutate(delta_group = ifelse(delta_all < 0, 'younger', 'older'))

# Add factors
factors_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/HABS/processed/factors.csv')
factors_habs <- factors_habs %>% 
  select(SubjIDshort, ptau, p_tau217_ratio, PIB_FS_SUVR_FLR, PIB_FS_SUVR_Group, tau_composite)
data_habs <- merge(data_habs, factors_habs, by = 'SubjIDshort', all.x = TRUE)

# Ensure correct typing
data_habs$NP_SessionDate <- as.Date(data_habs$NP_SessionDate)
data_habs <- data_habs %>%
  mutate(across(c(E4_Status, PIB_FS_SUVR_Group), as.factor))

# Filter subjects with less than 2 data points
data_habs <- data_habs %>% 
  arrange(SubjIDshort, NP_SessionDate) %>%  
  group_by(SubjIDshort) %>% 
  add_tally(name = 'nTimePoints', wt = !is.na(NP_PACC_PACC5)) %>%
  filter(nTimePoints >= 2) %>%
  mutate(time_from_bl = as.numeric(NP_SessionDate - min(NP_SessionDate, na.rm = TRUE))/365.25)  %>%
  mutate(PACC_change_bl = NP_PACC_PACC5 - NP_PACC_PACC5[1])

# Create baseline data set
baseline_habs <- data_habs %>% 
  group_by(SubjIDshort) %>%
  arrange(NP_SessionDate) %>%
  slice(1) %>% #extract first rows - can also use slice_head() for first and slice_tail() for last
  rename(BL_Age = NP_Age) %>%
  rename(BL_PACC = NP_PACC_PACC5) %>%
  ungroup()

# Add age at baseline of subjects
data_habs <- data_habs %>%
  left_join(baseline_habs %>% select(SubjIDshort, BL_Age, BL_PACC), by = 'SubjIDshort')
```

## Demographics

```{r}
data_A4_demo <- data_A4 %>% 
  arrange(BID, pacc_time) %>%  
  group_by(BID) %>%
  mutate(follow_up_time = max(pacc_time, na.rm = TRUE)) %>%
  slice(1) %>% #extract first rows - can also use slice_head() for first and slice_tail() for last
  select(BID, AGEYR, SEX, EDCCNTU, APOE, Amyloid, amyloid_composite, tau_composite, pTau217, PACC_bl, follow_up_time) %>%
  # Add a column Cohort that has in its entry A4/Learn
  mutate(Cohort = 'A4/Learn') %>%
  mutate(Amyloid = ifelse(Amyloid == 1.0, 'positive', 'negative'))

data_HABS_demo <- data_habs %>% 
  arrange(SubjIDshort, NP_SessionDate) %>%  
  group_by(SubjIDshort) %>% 
  mutate(follow_up_time = max(time_from_bl, na.rm = TRUE)) %>%
  slice(1) %>% #extract first rows - can also use slice_head() for first and slice_tail() for last
  select(SubjIDshort, NP_Age, SEX, YrsEd, E4_Status, PIB_FS_SUVR_Group, PIB_FS_SUVR_FLR, ptau, tau_composite, BL_PACC, follow_up_time) %>%
  rename(BID=SubjIDshort, AGEYR = NP_Age, EDCCNTU = YrsEd, APOE = E4_Status, Amyloid = PIB_FS_SUVR_Group, amyloid_composite = PIB_FS_SUVR_FLR, PACC_bl = BL_PACC, pTau217 = ptau) %>%
  mutate(Cohort = 'HABS') %>%
  # Convert PIB- and PIB + to 0 and 1
  mutate(Amyloid = ifelse(Amyloid == 'PIB-', 'negative', 'positive')) %>%
  mutate(SEX = case_when(
    SEX == "F" ~ "Female",
    SEX == "M" ~ "Male"))

habs_t <- tbl_summary(data_HABS_demo,
            include = c(AGEYR, SEX, EDCCNTU, APOE, Amyloid, amyloid_composite, tau_composite, pTau217, PACC_bl, follow_up_time),
            missing = "no",
            statistic = list(all_continuous()  ~ c("{mean} ({sd})")),
            label = list(AGEYR ~ "Age", EDCCNTU ~ "Education (Years)", SEX ~ "Sex", follow_up_time ~ "Follow-up Time (Years)", pTau217 ~ "pTau217 (U/ml)", amyloid_composite ~ "AB-PET SUVR", tau_composite ~ "Tau-PET SUVR", PACC_bl ~ "PACC at Baseline"),
            digits = list(all_continuous() ~ 2, all_categorical() ~ c(0,2)),
            by = Amyloid) %>%
  bold_labels()

A4_t <- tbl_summary(data_A4_demo,
            include = c(AGEYR, SEX, EDCCNTU, APOE, Amyloid, amyloid_composite, tau_composite, pTau217, PACC_bl, follow_up_time),
            missing = "no",
            statistic = list(all_continuous()  ~ c("{mean} ({sd})")),
            label = list(AGEYR ~ "Age", EDCCNTU ~ "Education (Years)", SEX ~ "Sex", follow_up_time ~ "Follow-up Time (Years)", pTau217 ~ "pTau217 (U/ml)", amyloid_composite ~ "AB-PET SUVR", tau_composite ~ "Tau-PET SUVR", PACC_bl ~ "PACC at Baseline"),
            digits = list(all_continuous() ~ 2, all_categorical() ~ c(0,2)),
            by = Amyloid) %>%
  bold_labels()

table <- tbl_merge(list(A4_t, habs_t), tab_spanner = c("A4/LEARN", "HABS")) 

table

table %>%
  as_flex_table() %>% 
  fontsize(size = 14, part = "all") %>%
  line_spacing(space = 1.5, part = "all") %>%
  autofit() %>%
  save_as_docx(path = "~/Downloads/DemographicsTable.docx")
```


## A4 Structural BrainAge

### Trajectories

Plot PACC trajectories with spaghetti plot.

```{r}
ggplot(data_A4, aes(x = pacc_time, y = PACC, group = BID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from Baseline', y = 'PACC') +
  theme_minimal()
```

Plot PACC change from baseline trajectories with spaghetti plot.

```{r}
ggplot(data_A4, aes(x = pacc_time, y = PACC_change_bl, group = BID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from Baseline', y = 'PACC change from Basline') +
  theme_minimal()
```

### Mixed Effects Model

Simplest Quadratic mixed effects models with delta at baseline:

PACC \~ pacc_time\^2 + pacc_timeXdelta + Cumulative_Dose_Scaled + QSVERSION_PACC + CohortXpacc_time

```{r}
lmm_results_A4 <- lme(PACC ~ I(pacc_time^2) + pacc_time*delta_all + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4)
p <- plot_model(lmm_results_A4, type = c('pred'), terms = c('pacc_time', 'delta_all [-3, 0, 3]')) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
ggsave('~/Downloads/a4_pacc.png', plot = p, width = 3.5, height = 2)
```

### Senstivity Analysis {.tabset}

#### Linear vs Quadratic

```{r}
lmm_results_A4_linear <- lme(PACC ~ pacc_time*delta_all + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
anova(lmm_results_A4_linear, lmm_results_A4)
```

The quadratic model explains the model better.

#### Placebo

```{r} 
lmm_results_A4_placebo <- lme(PACC ~ I(pacc_time^2) + pacc_time*delta_all + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_placebo, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4_placebo)
p <- plot_model(lmm_results_A4_placebo, type = c('pred'), terms = c('pacc_time', 'delta_all [-3, 0, 3]')) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
```

Similar results when excluding the treatment group.

#### Age, e4 and amyloid

Adding Age, APOE and Amyloid status:

```{r} 
lmm_results_A4_sens <- lme(PACC ~ I(pacc_time^2) + pacc_time*delta_all + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort + pacc_time*bl_pacc_age + pacc_time*APOE + pacc_time*Amyloid, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4_sens)
p <- plot_model(lmm_results_A4_sens, type = c('pred'), terms = c('pacc_time', 'delta_all [-3, 0, 3]')) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
```

Similar results but less pronounced effect.

#### Change from baseline

Analysis of modelling PACC change instead of PACC to include PACC at baseline effects.

```{r} 
lmm_results_A4_change <- lme(PACC_change_bl ~ I(pacc_time^2) + pacc_time*delta_all + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort + pacc_time*bl_pacc_age + pacc_time*APOE + pacc_time*Amyloid + pacc_time*PACC_bl, data = data_A4, random = ~ 0 + pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4_change)
plot_model(lmm_results_A4_change, type = c('pred'), terms = c('pacc_time', 'delta_all [-3, 0, 3]'))
plot_model(lmm_results_A4_change, type = c('pred'), terms = c('pacc_time', 'PACC_bl [-3, 0, 2]'), show.values = TRUE)
plot_model(lmm_results_A4_change, type = c('pred'), terms = c('pacc_time', 'delta_all [-3, 0, 3]', 'PACC_bl [-3, 0, 2]'), show.values = TRUE)
```

Resutls still stay significant. 

### Interactions {.tabset}

#### pTau217

```{r}
lmm_results_A4_pTau217 <- lme(PACC ~ I(pacc_time^2) + pacc_time*delta_all*pTau217 + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4_pTau217)
p <- plot_model(lmm_results_A4_pTau217, type = c('pred'), terms = c('pacc_time', 'delta_all [-3, 0, 3]', 'pTau217 [0.14, 0.28, 0.42]'))
levels(p$data$facet) <- c("pTau217 = 0.14", "pTau217 = 0.28", "pTau217 = 0.42")
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
ggsave('~/Downloads/pTau217_a4_pacc.png', plot = p, width = 6, height = 3)
```

#### PET Amyloid

```{r}
lmm_results_A4_amyl <- lme(PACC ~ I(pacc_time^2) + pacc_time*delta_all*amyloid_composite + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'), control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
summary(lmm_results_A4_amyl)
p <- plot_model(lmm_results_A4_amyl, type = c('pred'), terms = c('pacc_time', 'delta_all [-3, 0, 3]', 'amyloid_composite [1.0, 1.17, 1.39]'))
levels(p$data$facet) <- c("AB-PET SUVR = 1.0", "AB-PET SUVR = 1.17", "AB-PET SUVR = 1.39")
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
ggsave('~/Downloads/ab_a4_pacc.png', plot = p, width = 6, height = 3)
```

#### PET Tau

```{r}
lmm_results_A4_tau <- lme(PACC ~ I(pacc_time^2) + pacc_time*delta_all*tau_composite + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4_tau)
p <- plot_model(lmm_results_A4_tau, type = c('pred'), terms = c('pacc_time', 'delta_all [-3, 0, 3]', 'tau_composite [1.19, 1.4, 1.62]'))
levels(p$data$facet) <- c("Tau-PET SUVR = 1.19", "Tau-PET SUVR = 1.4", "Tau-PET SUVR = 1.62")
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
ggsave('~/Downloads/tau_a4_pacc.png', plot = p, width = 6, height = 3)
```


### Treatment effects

Simple model of time on PACC

```{r}
lmm_results_A4_pacc <- lme(PACC ~ pacc_time + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4_pacc)
plot_model(lmm_results_A4_pacc, type = c('pred'), terms = c('pacc_time'))
```

Threshold to determine older looking subjects and repeat linear mixed effects model

```{r}
lmm_results_A4_pacc_old <- lme(PACC ~ pacc_time + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = subset(data_A4, data_A4$delta_all > 0), random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'), control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
summary(lmm_results_A4_pacc_old)
plot_model(lmm_results_A4_pacc_old, type = c('pred'), terms = c('pacc_time'))
```

Power analysis

```{r}
# Extract pacc_time value of linear mixed effects model
beta_pacc_A4 <- fixef(lmm_results_A4_pacc)["pacc_time"]
beta_old_A4 <- fixef(lmm_results_A4_pacc_old)["pacc_time"]
pwr_pacc_A4 <- pwr.t.test(d = beta_pacc_A4, power = 0.8, sig.level = 0.05, type = "two.sample", alternative = "two.sided")
pwr_old_A4 <- pwr.t.test(d = beta_old_A4, power = 0.8, sig.level = 0.05, type = "two.sample", alternative = "two.sided")
# Print number of subjects needed for each case and reduction percentage
print(pwr_pacc_A4$n)
print(pwr_old_A4$n)
print((pwr_old_A4$n - pwr_pacc_A4$n)/pwr_pacc_A4$n*100)
```

## HABS

### Trajectories

Plot PACC trajectories with spaghetti plot

```{r}
ggplot(subset(data_habs, !is.na(delta_group)), aes(x = time_from_bl, y = NP_PACC_PACC5, group = SubjIDshort, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from Baseline', y = 'PACC') +
  theme_minimal()
```

Plot PACC change from baseline trajectories with spaghetti plot.

```{r}
ggplot(subset(data_habs, !is.na(delta_group)), aes(x =  time_from_bl, y = PACC_change_bl, group = SubjIDshort, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from Baseline', y = 'PACC change from Basline') +
  theme_minimal()
```

### Mixed Effects Model

Simplest linear mixed effects models with delta at baseline:

PACC \~ pacc_timeXdelta 

```{r}
lmm_results_habs <- lme(NP_PACC_PACC5 ~ time_from_bl*delta_all, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs)
p <- plot_model(lmm_results_habs, type = c('pred'), terms = c('time_from_bl', 'delta_all [-4, 0, 4]'))
p <- p +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
ggsave('~/Downloads/habs_pacc.png', plot = p, width = 3.5, height = 2)
```

### Sensitivity Analysis {.tabset}

#### Age, e4 and amyloid

Add Age, APOE and Amyloid status:

```{r}
lmm_results_habs_sens <- lme(NP_PACC_PACC5 ~ time_from_bl*delta_all + time_from_bl*BL_Age + time_from_bl+ time_from_bl*E4_Status + time_from_bl*PIB_FS_SUVR_Group, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs_sens)
p <- plot_model(lmm_results_habs_sens, type = c('pred'), terms = c('time_from_bl', 'delta_all [-4, 0, 4]'))
p
```

We keep significant results although the trajectories also depend on the other factors.

#### Change from baseline

```{r}
lmm_results_habs_sens <- lme(PACC_change_bl ~ time_from_bl*delta_all + time_from_bl*BL_Age + time_from_bl+ time_from_bl*E4_Status + time_from_bl*PIB_FS_SUVR_Group + time_from_bl*BL_PACC, data = data_habs, random = ~ 0 + time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs_sens)
p <- plot_model(lmm_results_habs_sens, type = c('pred'), terms = c('time_from_bl', 'delta_all [-4, 0, 4]'))
p
```

### Interactions {.tabset}

#### pTau217

```{r}
lmm_results <- lme(NP_PACC_PACC5 ~ time_from_bl*delta_all*p_tau217_ratio, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results)
p <- plot_model(lmm_results, type = c('pred'), terms = c('time_from_bl', 'delta_all [-4, 0, 4]', 'p_tau217_ratio [0.71, 3.46, 6.21]'))
levels(p$data$facet) <- c("pTau217 = 0.71", "pTau217 = 3.46", "pTau217 = 6.21")
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
ggsave('~/Downloads/pTau217_habs_pacc.png', plot = p, width = 6, height = 3)
```

#### PET Amyloid

```{r}
lmm_results <- lme(NP_PACC_PACC5 ~ time_from_bl*delta_all*PIB_FS_SUVR_FLR, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results)
p <- plot_model(lmm_results, type = c('pred'), terms = c('time_from_bl', 'delta_all [-4, 0, 4]', 'PIB_FS_SUVR_FLR [1.0, 1.24, 1.49]'))
levels(p$data$facet) <- c("AB-PET SUVR = 1.0", "AB-PET SUVR = 1.24", "AB-PET SUVR = 1.49")
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
ggsave('~/Downloads/ab_habs_pacc.png', plot = p, width = 6, height = 3)
```

#### PET Tau

```{r}
lmm_results <- lme(NP_PACC_PACC5 ~ time_from_bl*delta_all*tau_composite, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results)
p <- plot_model(lmm_results, type = c('pred'), terms = c('time_from_bl', 'delta_all [-4, 0, 4]', 'tau_composite [1.17, 1.35, 1.52]'))
levels(p$data$facet) <- c("Tau-PET SUVR = 1.17", "Tau-PET SUVR = 1.35", "Tau-PET SUVR = 1.52")
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
ggsave('~/Downloads/tau_habs_pacc.png', plot = p, width = 6, height = 3)
```

### Treatment effects

Simple model of time on PACC

```{r}
lmm_results_habs_pacc <- lme(NP_PACC_PACC5 ~ time_from_bl, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs_pacc)
plot_model(lmm_results_habs_pacc, type = c('pred'), terms = c('time_from_bl'))
```

Threshold to determine older looking subjects and repeat linear mixed effects model

```{r}
lmm_results_habs_pacc_old <- lme(NP_PACC_PACC5 ~ time_from_bl, data = subset(data_habs, data_habs$delta_all > 0), random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs_pacc_old)
plot_model(lmm_results_habs_pacc_old, type = c('pred'), terms = c('time_from_bl'))
```

Power analysis

```{r}
# Extract pacc_time value of linear mixed effects model
beta_pacc_habs <- fixef(lmm_results_habs_pacc)["time_from_bl"]
beta_old_habs <- fixef(lmm_results_habs_pacc_old)["time_from_bl"]
pwr_pacc_habs <- pwr.t.test(d = beta_pacc_habs, power = 0.8, sig.level = 0.05, type = "two.sample", alternative = "two.sided")
pwr_old_habs <- pwr.t.test(d = beta_old_habs, power = 0.8, sig.level = 0.05, type = "two.sample", alternative = "two.sided")
# Print number of subjects needed for each case and reduction percentage
print(pwr_pacc_habs$n)
print(pwr_old_habs$n)
print((pwr_old_habs$n - pwr_pacc_habs$n)/pwr_pacc_habs$n*100)
```
