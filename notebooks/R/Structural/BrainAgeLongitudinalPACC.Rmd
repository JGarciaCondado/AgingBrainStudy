---
title: "Brain Age Longitudinal PACC"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('BrainAgeLongitudinalPACC.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/BrainAgeLongitudinalPACC', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr); library(dplyr);library(nlme);library(sjPlot);library(gtsummary); library(flextable); library(MuMIn); library(pwr); library(longpower); library(gt)

source('~/Documents/Projects/AgingBrainStudy/scripts/functions.R')

knitr::opts_chunk$set(echo = FALSE, message = FALSE)
theme_set(theme_bw())
```

# Brain Age Longitudinal PACC

We will explore how baseline Brain Age delta moderates longitudinal PACC through a linear mixed effects model on A4/Learn and HABS data.

```{r}
# Load A4 data
data_a4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/a4/processed/longitudinal.csv') %>%
  mutate_at(vars(sex, e4_carrier, ab_status, cohort, LMSTORY), factor)

# Placebo data
data_placebo <- data_a4 %>% 
  filter(cohort == 'A4 Placebo')
```

```{r}
# Load HABS data
data_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/habs/processed/longitudinal.csv') %>%
  mutate_at(vars(sex, e4_carrier, ab_status), factor)
```

```{r}
# Load ADNI data
data_adni <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/adni/processed/longitudinal.csv') %>%
  mutate_at(vars(sex, e4_carrier, ab_status), factor)

# Devide between Baseline_diagnosis CN and MCI
data_adni_mci <- data_adni %>% 
  filter(diagnosis == 'MCI')
data_adni_cn <- data_adni %>%
  filter(diagnosis == 'CN')
```

## A4 Structural BrainAge

### Trajectories

Plot PACC trajectories with spaghetti plot.

```{r}
ggplot(data_a4, aes(x = time_mri, y = PACC, group = ID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from MRI', y = 'PACC') +
  theme_minimal()
```

Plot PACC change from baseline trajectories with spaghetti plot.

```{r}
ggplot(data_habs, aes(x = time_mri, y = PACC_change, group = ID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from MRI', y = 'PACC change from Basline') +
  theme_minimal()
```

### Mixed Effects Model


Simplest Quadratic mixed effects models with delta at baseline:

PACC \~ pacc_time\^2 + pacc_timeXdelta + Cumulative_Dose_Scaled + LMSTORY + CohortXpacc_time

```{r}
lmm_results_a4 <- lme(PACC ~ I(time_mri^2) + time_mri*delta + Cumulative_Dose_Scaled + time_mri*cohort + LMSTORY, data = data_a4, 
                      random = ~time_mri|ID, 
                      na.action = 'na.omit', 
                      method = c('ML'),
                      control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
summary(lmm_results_a4)
p <- plot_model(lmm_results_a4, type = c('pred'), terms = c('time_mri', 'delta'))
p <- p +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p
```

### Sensitivity Analysis {.tabset}


#### Linear vs Quadratic

```{r}
lmm_results_a4_linear <- lme(PACC ~ time_mri*delta + Cumulative_Dose_Scaled + LMSTORY+ time_mri*cohort,
                             data = data_a4, 
                             random = ~time_mri|ID, 
                             na.action = 'na.omit', method = c('ML'),
                             control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
anova(lmm_results_a4_linear, lmm_results_a4)
```

The quadratic model explains the model better.

#### Placebo

```{r} 
lmm_results_a4_placebo <- lme(PACC ~ I(time_mri^2) + time_mri*delta + Cumulative_Dose_Scaled + LMSTORY, 
                              data = data_placebo, 
                              random = ~time_mri|ID, 
                              na.action = 'na.omit', method = c('ML'));
summary(lmm_results_a4_placebo)
p <- plot_model(lmm_results_a4_placebo, type = c('pred'), terms = c('time_mri', 'delta'))
p <- p +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p
```

Similar results when excluding the treatment group.

#### Age, e4 and amyloid

Amyloid is not included because cohort already takes this into account as LEARN are those that are ab- compared to A4 which are ab+. This leads to singularity back solve if ab_status included.

Add Age, APOE, Sex, Education:

```{r}
lmm_results_adni_sens_cn_demo <- lme(PACC ~ I(time_mri^2) + time_mri*delta + Cumulative_Dose_Scaled + LMSTORY + time_mri*cohort + time_mri*mri_age + time_mri*e4_carrier + time_mri*sex + time_mri*edu, 
                                     data = data_a4, 
                                     random = ~time_mri|ID, 
                                     na.action = 'na.omit', 
                                     method = c('ML'),
                                     control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
summary(lmm_results_adni_sens_cn_demo)
p <- plot_model(lmm_results_adni_sens_cn_demo, type = c('pred'), terms = c('time_mri', 'delta'))
p
```

We keep significant results although the trajectories also depend on the other factors.

#### Change from baseline

```{r}
lmm_results_adni_sens_cn_change <- lme(PACC_change ~ I(time_mri^2) + time_mri*delta + Cumulative_Dose_Scaled + time_mri*cohort + LMSTORY + time_mri*mri_age + time_mri*sex + time_mri*e4_carrier + time_mri*PACC_mri, 
                                       data = data_a4, 
                                       random = ~ 0 + time_mri|ID, 
                                       na.action = 'na.omit', 
                                       method = c('ML'));
summary(lmm_results_adni_sens_cn_change)
p <- plot_model(lmm_results_adni_sens_cn_change, type = c('pred'), terms = c('time_mri', 'delta'))
p
```

### Interactions {.tabset}

#### PET Amyloid

```{r}
lmm_results_ADNI_amyl_cn <- lme(PACC ~ I(time_mri^2) + time_mri*delta*ab_composite + Cumulative_Dose_Scaled + time_mri*cohort + LMSTORY, 
                                data = data_a4[data_a4$secondary == 1,], 
                                random = ~time_mri|ID, 
                                na.action = 'na.omit', 
                                method = c('ML'));
summary(lmm_results_ADNI_amyl_cn)
p <- plot_model(lmm_results_ADNI_amyl_cn, type = c('pred'), terms = c('time_mri', 'delta', 'ab_composite'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_amyl_cn)$tTable["time_mri:delta:ab_composite", 5])
```

Add Age, Sex, Education, E4 Status

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ I(time_mri^2) + time_mri*delta*ab_composite + Cumulative_Dose_Scaled + LMSTORY + time_mri*cohort + time_mri*mri_age + time_mri*e4_carrier + time_mri*sex + time_mri*edu, 
                                     data = data_a4[data_a4$secondary == 1,], 
                                     random = ~time_mri|ID, 
                                     na.action = 'na.omit', 
                                     method = c('ML'));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:ab_composite", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ I(time_mri^2) 
                                     + time_mri*delta*ab_composite 
                                     + Cumulative_Dose_Scaled 
                                     + LMSTORY 
                                     + time_mri*cohort 
                                     + time_mri*mri_age 
                                     + time_mri*e4_carrier 
                                     + time_mri*sex 
                                     + time_mri*edu, 
                                     data = data_a4[data_a4$secondary == 1 & data_a4$time_diff_ab <=1 & data_a4$time_diff_ab >=-1,], 
                                     random = ~time_mri|ID, na.action = 'na.omit', 
                                     method = c('ML'),
                                     control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:ab_composite", 5])
```

#### pTau217

```{r}
lmm_results_ADNI_ptau_cn <- lme(PACC ~ I(time_mri^2) 
                                + time_mri*delta*ptau 
                                + Cumulative_Dose_Scaled 
                                + LMSTORY
                                + time_mri*cohort, 
                                data = data_a4[data_a4$exploratory == 1,], 
                                random = ~time_mri|ID, 
                                na.action = 'na.omit', 
                                method = c('ML'));
summary(lmm_results_ADNI_ptau_cn)
p <- plot_model(lmm_results_ADNI_ptau_cn, type = c('pred'), terms = c('time_mri', 'delta', 'ptau'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_ptau_cn)$tTable["time_mri:delta:ptau", 5])
```
Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_ptau_sens_cn <- lme(PACC~ I(time_mri^2) 
                                     + time_mri*delta*ptau 
                                     + Cumulative_Dose_Scaled 
                                     + LMSTORY
                                     + time_mri*cohort
                                     + time_mri*mri_age 
                                     + time_mri*e4_carrier 
                                     + time_mri*sex 
                                     + time_mri*edu, 
                                     data = data_a4[data_a4$exploratory == 1,], 
                                     random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_ptau_sens_cn)$tTable["time_mri:delta:ptau", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_ptau_sens_cn <- lme(PACC~ I(time_mri^2) 
                                     + time_mri*delta*ptau 
                                     + Cumulative_Dose_Scaled
                                     + LMSTORY
                                     + time_mri*cohort 
                                     + time_mri*mri_age 
                                     + time_mri*e4_carrier 
                                     + time_mri*sex 
                                     + time_mri*edu, 
                                     data = data_a4[data_a4$exploratory == 1 & data_a4$time_diff_ptau <=1 & data_a4$time_diff_ptau >=-1,], 
                                     random = ~time_mri|ID, 
                                     na.action = 'na.omit', 
                                     method = c('ML'));
print(summary(lmm_results_ADNI_ptau_sens_cn)$tTable["time_mri:delta:ptau", 5])
```

#### PET Tau

```{r}
lmm_results_ADNI_tau_cn <- lme(PACC ~ I(time_mri^2) 
                               + time_mri*delta*tau_composite 
                               + Cumulative_Dose_Scaled 
                               + LMSTORY
                               + time_mri*cohort, 
                               data = data_a4[data_a4$exploratory == 1,], 
                               random = ~time_mri|ID, 
                               na.action = 'na.omit', 
                               method = c('ML'));
summary(lmm_results_ADNI_tau_cn)
p <- plot_model(lmm_results_ADNI_tau_cn, type = c('pred'), terms = c('time_mri', 'delta', 'tau_composite'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_tau_cn)$tTable["time_mri:delta:tau_composite", 5])
```

Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_tau_sens_cn <- lme(PACC~ I(time_mri^2) 
                                    + time_mri*delta*tau_composite 
                                    + Cumulative_Dose_Scaled 
                                    + LMSTORY
                                    + time_mri*cohort 
                                    + time_mri*mri_age 
                                    + time_mri*e4_carrier 
                                    + time_mri*sex 
                                    + time_mri*edu, 
                                    data = data_a4[data_a4$exploratory == 1,], 
                                    random = ~time_mri|ID, 
                                    na.action = 'na.omit', 
                                    method = c('ML'));
print(summary(lmm_results_ADNI_tau_sens_cn)$tTable["time_mri:delta:tau_composite", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_tau_sens_cn <- lme(PACC~ I(time_mri^2) 
                                    + time_mri*delta*tau_composite 
                                    + Cumulative_Dose_Scaled 
                                    + LMSTORY
                                    + time_mri*cohort 
                                    + time_mri*mri_age 
                                    + time_mri*e4_carrier 
                                    + time_mri*sex 
                                    + time_mri*edu, 
                                    data = data_a4[data_a4$exploratory == 1 & data_a4$time_diff_tau <=1 & data_a4$time_diff_tau >=-1,], 
                                    random = ~time_mri|ID, 
                                    na.action = 'na.omit', 
                                    method = c('ML'));
print(summary(lmm_results_ADNI_tau_sens_cn)$tTable["time_mri:delta:tau_composite", 5])
```

### Delta Threshold

```{r}
adni_formula = "I(time_mri^2) + time_mri*delta_status + Cumulative_Dose_Scaled + time_mri*cohort"
adni_random_formula = " ~ time_mri|ID"
mean_adni_delta_cn = mean(data_a4$delta, na.rm = TRUE)
sd_adni_delta_cn = sd(data_a4$delta, na.rm = TRUE)
results_a4 <- find_optimal_threshold(data_a4, seq(mean_adni_delta_cn-2*sd_adni_delta_cn, 
                                                    mean_adni_delta_cn + 2*sd_adni_delta_cn, by = 0.5), 
                                   outcome = "PACC", 
                                   measure = "delta", 
                                   fixed_formula = adni_formula, 
                                   random_formula = adni_random_formula)
print(results_a4$optimal_threshold)
print(results_a4$plot)
print((results_a4$optimal_threshold - mean_adni_delta_cn) / sd_adni_delta_cn)
```

## HABS

### Trajectories

Plot PACC trajectories with spaghetti plot.

```{r}
ggplot(data_habs, aes(x = time_mri, y = PACC, group = ID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from MRI', y = 'PACC') +
  theme_minimal()
```

Plot PACC change from baseline trajectories with spaghetti plot.

```{r}
ggplot(data_habs, aes(x = time_mri, y = PACC_change, group = ID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from MRI', y = 'PACC change from Basline') +
  theme_minimal()
```

### Mixed Effects Model

Simplest linear mixed effects models with delta at baseline:

PACC \~ pacc_timeXdelta

```{r}
lmm_results_habs <- lme(PACC ~ time_mri*delta, data = data_habs, random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs)
p <- plot_model(lmm_results_habs, type = c('pred'), terms = c('time_mri', 'delta'))
p <- p +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p
```

### Sensitivity Analysis {.tabset}

#### Age, e4 and amyloid

Add Age, APOE, Sex, Education and Amyloid status:

```{r}
lmm_results_adni_sens_cn_demo <- lme(PACC ~ time_mri*delta + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_habs, random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_adni_sens_cn_demo)
p <- plot_model(lmm_results_adni_sens_cn_demo, type = c('pred'), terms = c('time_mri', 'delta'))
p
```

We keep significant results although the trajectories also depend on the other factors.

#### Change from baseline

```{r}
lmm_results_adni_sens_cn_change <- lme(PACC_change ~ time_mri*delta + time_mri*mri_age + time_mri*sex + time_mri*e4_carrier + time_mri*ab_status + time_mri*PACC_mri, data = data_habs, random = ~ 0 + time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_adni_sens_cn_change)
p <- plot_model(lmm_results_adni_sens_cn_change, type = c('pred'), terms = c('time_mri', 'delta'))
p
```

### Interactions {.tabset}

#### PET Amyloid

```{r}
lmm_results_ADNI_amyl_cn <- lme(PACC ~ time_mri*delta*ab_composite, data = data_habs[data_habs$secondary == 1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_ADNI_amyl_cn)
p <- plot_model(lmm_results_ADNI_amyl_cn, type = c('pred'), terms = c('time_mri', 'delta', 'ab_composite'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_amyl_cn)$tTable["time_mri:delta:ab_composite", 5])
```

Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ time_mri*delta*ab_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_habs[data_habs$secondary == 1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:ab_composite", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ time_mri*delta*ab_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_habs[data_habs$secondary == 1 & data_habs$time_diff_ab <=1 & data_habs$time_diff_ab >=-1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:ab_composite", 5])
```

#### pTau217

```{r}
lmm_results_ADNI_ptau_cn <- lme(PACC ~ time_mri*delta*ptau, data = data_habs[data_habs$exploratory == 1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_ADNI_ptau_cn)
p <- plot_model(lmm_results_ADNI_ptau_cn, type = c('pred'), terms = c('time_mri', 'delta', 'ptau'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_ptau_cn)$tTable["time_mri:delta:ptau", 5])
```
Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_ptau_sens_cn <- lme(PACC~ time_mri*delta*ptau + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_habs[data_habs$exploratory == 1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_ptau_sens_cn)$tTable["time_mri:delta:ptau", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_ptau_sens_cn <- lme(PACC~ time_mri*delta*ptau + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_habs[data_habs$exploratory == 1 & data_habs$time_diff_ptau <=1 & data_habs$time_diff_ptau >=-1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_ptau_sens_cn)$tTable["time_mri:delta:ptau", 5])
```

#### PET Tau

```{r}
lmm_results_ADNI_tau_cn <- lme(PACC ~ time_mri*delta*tau_composite, data = data_habs[data_habs$exploratory == 1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_ADNI_tau_cn)
p <- plot_model(lmm_results_ADNI_tau_cn, type = c('pred'), terms = c('time_mri', 'delta', 'tau_composite'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_tau_cn)$tTable["time_mri:delta:tau_composite", 5])
```

Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_tau_sens_cn <- lme(PACC~ time_mri*delta*tau_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_habs[data_habs$exploratory == 1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_tau_sens_cn)$tTable["time_mri:delta:tau_composite", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_tau_sens_cn <- lme(PACC~ time_mri*delta*tau_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_habs[data_habs$exploratory == 1 & data_habs$time_diff_tau <=1 & data_habs$time_diff_tau >=-1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_tau_sens_cn)$tTable["time_mri:delta:tau_composite", 5])
```

### Delta Threshold

```{r}
adni_formula = "time_mri*delta_status"
adni_random_formula = " ~ time_mri|ID"
mean_adni_delta_cn = mean(data_habs$delta, na.rm = TRUE)
sd_adni_delta_cn = sd(data_habs$delta, na.rm = TRUE)
results_habs <- find_optimal_threshold(data_habs, seq(mean_adni_delta_cn-2*sd_adni_delta_cn, 
                                                    mean_adni_delta_cn + 2*sd_adni_delta_cn, by = 0.5), 
                                   outcome = "PACC", 
                                   measure = "delta", 
                                   fixed_formula = adni_formula, 
                                   random_formula = adni_random_formula)
print(results_habs$optimal_threshold)
print(results_habs$plot)
print((results_habs$optimal_threshold - mean_adni_delta_cn) / sd_adni_delta_cn)
```


## ADNI CU

### Trajectories

Plot PACC trajectories with spaghetti plot.

```{r}
ggplot(data_adni_cn, aes(x = time_mri, y = PACC, group = ID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from MRI', y = 'PACC') +
  theme_minimal()
```

Plot PACC change from baseline trajectories with spaghetti plot.

```{r}
ggplot(data_adni_cn, aes(x = time_mri, y = PACC_change, group = ID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from MRI', y = 'PACC change from Basline') +
  theme_minimal()
```

### Mixed Effects Model

Simplest linear mixed effects models with delta at baseline:

PACC \~ pacc_timeXdelta

```{r}
lmm_results_adni_cn <- lme(PACC ~ time_mri*delta, data = data_adni_cn, random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_adni_cn)
p <- plot_model(lmm_results_adni_cn, type = c('pred'), terms = c('time_mri', 'delta'))
p <- p +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p
```

### Sensitivity Analysis {.tabset}

#### Age, e4 and amyloid

Add Age, APOE, Sex, Education and Amyloid status:

```{r}
lmm_results_adni_sens_cn_demo <- lme(PACC ~ time_mri*delta + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_cn, random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_adni_sens_cn_demo)
p <- plot_model(lmm_results_adni_sens_cn_demo, type = c('pred'), terms = c('time_mri', 'delta'))
p
```

We keep significant results although the trajectories also depend on the other factors.

#### Change from baseline

```{r}
lmm_results_adni_sens_cn_change <- lme(PACC_change ~ time_mri*delta + time_mri*mri_age + time_mri*sex + time_mri*e4_carrier + time_mri*ab_status + time_mri*PACC_mri, data = data_adni_cn, random = ~ 0 + time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_adni_sens_cn_change)
p <- plot_model(lmm_results_adni_sens_cn_change, type = c('pred'), terms = c('time_mri', 'delta'))
p
```

### Interactions {.tabset}

#### PET Amyloid

```{r}
lmm_results_ADNI_amyl_cn <- lme(PACC ~ time_mri*delta*ab_composite, data = data_adni_cn[data_adni_cn$secondary==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_ADNI_amyl_cn)
p <- plot_model(lmm_results_ADNI_amyl_cn, type = c('pred'), terms = c('time_mri', 'delta', 'ab_composite'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_amyl_cn)$tTable["time_mri:delta:ab_composite", 5])
```

Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ time_mri*delta*ab_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_cn[data_adni_cn$secondary==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:ab_composite", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ time_mri*delta*ab_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_cn[data_adni_cn$secondary == 1 & data_adni_cn$time_diff_ab <=1 & data_adni_cn$time_diff_ab >=-1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:ab_composite", 5])
```

#### pTau217

```{r}
lmm_results_ADNI_ptau_cn <- lme(PACC ~ time_mri*delta*ptau, data = data_adni_cn[data_adni_cn$exploratory==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_ADNI_ptau_cn)
p <- plot_model(lmm_results_ADNI_ptau_cn, type = c('pred'), terms = c('time_mri', 'delta', 'ptau'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_ptau_cn)$tTable["time_mri:delta:ptau", 5])
```
Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_ptau_sens_cn <- lme(PACC~ time_mri*delta*ptau + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_cn[data_adni_cn$exploratory==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_ptau_sens_cn)$tTable["time_mri:delta:ptau", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ time_mri*delta*ptau + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_cn[data_adni_cn$exploratory == 1 & data_adni_cn$time_diff_ptau <=1 & data_adni_cn$time_diff_ptau >=-1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:ptau", 5])
```

#### PET Tau

```{r}
lmm_results_ADNI_tau_cn <- lme(PACC ~ time_mri*delta*tau_composite, data = data_adni_cn[data_adni_cn$exploratory==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_ADNI_tau_cn)
p <- plot_model(lmm_results_ADNI_tau_cn, type = c('pred'), terms = c('time_mri', 'delta', 'tau_composite'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_tau_cn)$tTable["time_mri:delta:tau_composite", 5])
```

Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_tau_sens_cn <- lme(PACC~ time_mri*delta*tau_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_cn[data_adni_cn$exploratory==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_tau_sens_cn)$tTable["time_mri:delta:tau_composite", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ time_mri*delta*tau_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_cn[data_adni_cn$secondary == 1 & data_adni_cn$time_diff_tau <=1 & data_adni_cn$time_diff_tau >=-1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:tau_composite", 5])
```

### Delta Threshold

```{r}
adni_formula = "time_mri*delta_status"
adni_random_formula = " ~ time_mri|ID"
mean_adni_delta_cn = mean(data_adni_cn$delta, na.rm = TRUE)
sd_adni_delta_cn = sd(data_adni_cn$delta, na.rm = TRUE)
results_adni_cn <- find_optimal_threshold(data_adni_cn, seq(mean_adni_delta_cn-2*sd_adni_delta_cn, 
                                                    mean_adni_delta_cn + 2*sd_adni_delta_cn, by = 0.5), 
                                   outcome = "PACC", 
                                   measure = "delta", 
                                   fixed_formula = adni_formula, 
                                   random_formula = adni_random_formula)
print(results_adni_cn$optimal_threshold)
print(results_adni_cn$plot)
print((results_adni_cn$optimal_threshold - mean_adni_delta_cn) / sd_adni_delta_cn)
```

## ADNI MCI

### Trajectories

Plot PACC trajectories with spaghetti plot.

```{r}
ggplot(data_adni_mci, aes(x = time_mri, y = PACC, group = ID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from MRI', y = 'PACC') +
  theme_minimal()
```

Plot PACC change from baseline trajectories with spaghetti plot.

```{r}
ggplot(data_adni_mci, aes(x = time_mri, y = PACC_change, group = ID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from MRI', y = 'PACC change from Basline') +
  theme_minimal()
```

### Mixed Effects Model

Simplest linear mixed effects models with delta at baseline:

PACC \~ pacc_timeXdelta

```{r}
lmm_results_adni_mci <- lme(PACC ~ time_mri*delta, data = data_adni_mci, random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_adni_mci)
p <- plot_model(lmm_results_adni_mci, type = c('pred'), terms = c('time_mri', 'delta'))
p <- p +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p
```

### Sensitivity Analysis {.tabset}

#### Age, e4 and amyloid

Add Age, APOE, Sex, Education and Amyloid status:

```{r}
lmm_results_adni_sens_mci_demo <- lme(PACC ~ time_mri*delta + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_mci, random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_adni_sens_mci_demo)
p <- plot_model(lmm_results_adni_sens_mci_demo, type = c('pred'), terms = c('time_mri', 'delta'))
p
```

We keep significant results although the trajectories also depend on the other factors.

#### Change from baseline

```{r}
lmm_results_adni_sens_mci_change <- lme(PACC_change ~ time_mri*delta + time_mri*mri_age + time_mri*sex + time_mri*e4_carrier + time_mri*ab_status + time_mri*PACC_mri, data = data_adni_mci, random = ~ 0 + time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_adni_sens_mci_change)
p <- plot_model(lmm_results_adni_sens_mci_change, type = c('pred'), terms = c('time_mri', 'delta'))
p
```

### Interactions {.tabset}

#### PET Amyloid

```{r}
lmm_results_ADNI_amyl_mci <- lme(PACC ~ time_mri*delta*ab_composite, data = data_adni_mci[data_adni_mci$secondary==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_ADNI_amyl_mci)
p <- plot_model(lmm_results_ADNI_amyl_mci, type = c('pred'), terms = c('time_mri', 'delta', 'ab_composite'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_amyl_mci)$tTable["time_mri:delta:ab_composite", 5])
```

Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_amyl_sens_mci <- lme(PACC~ time_mri*delta*ab_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_mci[data_adni_mci$exploratory==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_amyl_sens_mci)$tTable["time_mri:delta:ab_composite", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ time_mri*delta*ab_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_mci[data_adni_mci$secondary == 1 & data_adni_mci$time_diff_ab <=1 & data_adni_mci$time_diff_ab >=-1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:ab_composite", 5])
```

#### pTau217

```{r}
lmm_results_ADNI_ptau_mci <- lme(PACC ~ time_mri*delta*ptau, data = data_adni_mci[data_adni_mci$exploratory==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_ADNI_ptau_mci)
p <- plot_model(lmm_results_ADNI_ptau_mci, type = c('pred'), terms = c('time_mri', 'delta', 'ptau'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_ptau_mci)$tTable["time_mri:delta:ptau", 5])
```
Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_ptau_sens_mci <- lme(PACC~ time_mri*delta*ptau + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_mci[data_adni_mci$secondary==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_ptau_sens_mci)$tTable["time_mri:delta:ptau", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ time_mri*delta*ptau + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_mci[data_adni_mci$exploratory == 1 & data_adni_mci$time_diff_ptau <=1 & data_adni_mci$time_diff_ptau >=-1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'), control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:ptau", 5])
```

#### PET Tau

```{r}
lmm_results_ADNI_tau_mci <- lme(PACC ~ time_mri*delta*tau_composite, data = data_adni_mci[data_adni_mci$exploratory==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_ADNI_tau_mci)
p <- plot_model(lmm_results_ADNI_tau_mci, type = c('pred'), terms = c('time_mri', 'delta', 'tau_composite'))
p <- p +
  ggtitle(NULL) +
  theme(strip.background = element_rect(fill = "white")) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from MRI (years)',
      y = 'PACC')
p

print(summary(lmm_results_ADNI_tau_mci)$tTable["time_mri:delta:tau_composite", 5])
```

Add Age, Sex, Education, E4 Status and Amyloid status.

```{r}
lmm_results_ADNI_tau_sens_mci <- lme(PACC~ time_mri*delta*tau_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_mci[data_adni_mci$exploratory==1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'));
print(summary(lmm_results_ADNI_tau_sens_mci)$tTable["time_mri:delta:tau_composite", 5])
```

Only samples within 1 year of MRI.

```{r}
lmm_results_ADNI_amyl_sens_cn <- lme(PACC~ time_mri*delta*tau_composite + time_mri*mri_age + time_mri*e4_carrier + time_mri*ab_status + time_mri*sex + time_mri*edu, data = data_adni_mci[data_adni_mci$exploratory == 1 & data_adni_mci$time_diff_tau <=1 & data_adni_mci$time_diff_tau >=-1,], random = ~time_mri|ID, na.action = 'na.omit', method = c('ML'),  control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000));
print(summary(lmm_results_ADNI_amyl_sens_cn)$tTable["time_mri:delta:tau_composite", 5])
```

### Delta Threshold

```{r}
adni_formula = "time_mri*delta_status"
adni_random_formula = " ~ time_mri|ID"
mean_adni_delta_mci = mean(data_adni_mci$delta, na.rm = TRUE)
sd_adni_delta_mci = sd(data_adni_mci$delta, na.rm = TRUE)
results_adni_mci <- find_optimal_threshold(data_adni_mci, seq(mean_adni_delta_mci-2*sd_adni_delta_mci, 
                                                    mean_adni_delta_mci + 2*sd_adni_delta_mci, by = 0.5), 
                                   outcome = "PACC", 
                                   measure = "delta", 
                                   fixed_formula = adni_formula, 
                                   random_formula = adni_random_formula)
print(results_adni_mci$optimal_threshold)
print(results_adni_mci$plot)
print((results_adni_mci$optimal_threshold - mean_adni_delta_mci) / sd_adni_delta_mci)
print((results_adni_mci$optimal_threshold - mean_adni_delta_cn) / sd_adni_delta_cn)
```