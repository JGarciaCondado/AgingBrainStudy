---
title: "Clinical Enrichment with BrainAge"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('ClinicalEnrichment.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/ClinicalEnrichment', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr); library(dplyr);


knitr::opts_chunk$set(echo = FALSE, message = FALSE)
theme_set(theme_bw())
```

# Brain Age Longitudinal PACC

We will explore how baseline Brain Age delta moderates longitudinal PACC through a linear mixed effects model on A4/Learn and HABS data.

```{r}

# Load ADNI data
data_adni <- read.csv('~/Documents/Projects/AgingBrainStudy/data/ADNI/raw/adni_03242025.csv')

# Concert time from baseline to years
data_adni <- data_adni %>% 
  rename(pacc_time = MonthsFromBaseline_PACC) %>%
  mutate(pacc_time = pacc_time/12)

# Load deltas
deltas_adni <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/ADNI/ageml/model_age/predicted_age.csv')
data_adni <- merge(data_adni, deltas_adni, by = 'ID')

# Arrange by pacc_time and calculate PACC_change_bl
data_adni <- data_adni %>% 
  arrange(ID, pacc_time) %>%
  group_by(ID) %>%
  add_tally(name = 'nTimePoints', wt = !is.na(zPACC)) %>%
  filter(nTimePoints >= 2)

# Remove time points of visits up to m24
data <- data_adni %>% 
  filter(VISCODE %in% c('bl', 'm06', 'm12', 'm18', 'm24')) %>%
  filter(AMYLOID_STATUS == 1) %>%
  filter(Baseline_Diagnosis == 'MCI')

# Extract those with delta_all above median
data_median <- data %>% 
  filter(delta_all > median(data$delta_all, na.rm = TRUE))

# Extract those with delta_all above 0
data_median_control <- data %>% 
  filter(delta_all > 0)

# Optimum threshold

# Total number of unique participants in each
n_participants <- length(unique(data$ID))
n_participants_median <- length(unique(data_median$ID))
n_participants_median_control <- length(unique(data_median_control$ID))
```

# Linear Mixed Effects Model

```{r}
library(nlme); library(sjPlot)
lmm <- lme(zPACC ~ pacc_time, random = ~ pacc_time|ID, na.action = 'na.omit', method = c('ML'), data = data, control = lmeControl(opt = "optim", maxIter = 500, msMaxIter = 1000)  )
summary(lmm)
plot_model(lmm, type = 'pred', terms = c('pacc_time'))
```

# Sample and power caclulations

```{r}
library(longpower)
source("../../../scripts/longpower_fix.R") # fixes an error in lmmpowwer (see https://github.com/mcdonohue/longpower/issues/6)

# Set parameters
outcome = 'zPACC'
t_visits = seq(0, 2, 0.5)
treatment_eff = 0.27
power = 0.9
sig_level = 0.05
n = NULL
method = 'edland'

# create a linear mixed model of outcome progression on which we base the sample size/power estimation
lmm <- lmer(as.formula(paste(outcome, "~ pacc_time + (1 + pacc_time | ID)")), data = data)

# calculate power / sample size using longpower package
pwr_all <- lmmpower(lmm, pct.change = treatment_eff, t = t_visits, power = power, sig.level = sig_level, n = n, method = method)
```

```{r}
# create a linear mixed model of outcome progression on which we base the sample size/power estimation
lmm_median <- lmer(as.formula(paste(outcome, "~ pacc_time + (1 + pacc_time | ID)")), data = data_median_control)

# calculate power / sample size using longpower package
pwr_median <- lmmpower(lmm_median, pct.change = treatment_eff, t = t_visits, power = power, sig.level = sig_level, n = n, method = method)
```

# Calculate savings

```{r}
screened_org = 5967
recruited_org = 1796
treatment_cost_per_year = 26500
years = 2
scren_cost = 6957
screen_pass = recruited_org / screened_org
```

```{r}
# Original costs
total_treatment = treatment_cost_per_year * years * recruited_org/2 # half of pariticpants get recruitment
total_screen = scren_cost * screened_org
total_cost = total_treatment + total_screen
```

```{r}
percentage_reduction = pwr_median$N / pwr_all$N
increase_screens = n_participants_median_control/n_participants # calculate this ratio directly from data 
mri_cost = 353
recruited_enriched = recruited_org * percentage_reduction
screened_enriched = recruited_enriched / (increase_screens * screen_pass)
total_treatment_enriched = treatment_cost_per_year * years * recruited_enriched/2
total_screen_enriched = (scren_cost + mri_cost) * screened_enriched
total_cost_enriched = total_treatment_enriched + total_screen_enriched
```