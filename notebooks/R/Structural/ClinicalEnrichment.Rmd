---
title: "Clinical Enrichment with BrainAge"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('ClinicalEnrichment.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/ClinicalEnrichment', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr); library(dplyr);library(nlme); library(sjPlot);library(longpower)


knitr::opts_chunk$set(echo = FALSE, message = FALSE)
theme_set(theme_bw())
```

# Brain Age in Clinical Trials

We will explore usign BrainAge as a clinical enrichment biomarker in two clinical trials:
- ADNI: MCI participants with amyloid positivity in two year trial looking at CDR sum of boxes
- A4: Preclinical AD participants with amyloid positivity in five year trial looking at PACC

```{r}
# Trial variables
treatment_eff = 0.27
power = 0.9
sig_level = 0.05
n = NULL
method = 'edland'

# Lecanemab costs
screened_lecanemab = 5967
recruited_lecanemab = 1796
treatment_cost_per_year = 26500
scren_cost = 6957
screen_cost_mri = 353
screen_pass_lecanemab = recruited_lecanemab / screened_lecanemab

# Function to calculate drug trial costs
calculate_drug_trial_costs <- function(
  years,                     # Total years of the trial
  participants_required,     # Number of participants required in the trial
  screen_pass_rate,       # Percentage of participants that screen fail (0-100)
  screen_cost,               # Cost per screening (default value)
  mri_cost,                  # Cost per MRI screening (default value)
  treatment_cost_per_year,   # Treatment cost per participant per year (default value)
  has_mri_screening = FALSE, # Whether there are MRI screenings (TRUE/FALSE)
  mri_pass_rate = 0      # Percentage of participants that don't pass MRI screening (0-100)
) {
  
  # Calculate number of participants to screen
  if (has_mri_screening) {
    # If using MRI screening, account for both regular screening and MRI screening failures
    participants_to_screen = participants_required / (screen_pass_rate * mri_pass_rate)
  } else {
    # Without MRI, only account for regular screening failures
    participants_to_screen = participants_required / screen_pass_rate
  }
  
  # Calculate screening costs
  if (has_mri_screening) {
    # For participants who pass initial screening, they also get an MRI
    participants_passing_initial = participants_to_screen * screen_pass_rate
    screening_cost = (participants_to_screen * screen_cost) + (participants_passing_initial * mri_cost)
  } else {
    screening_cost = participants_to_screen * screen_cost
  }
  
  # Calculate treatment costs
  # Assuming half of the enrolled participants receive the treatment (other half is control)
  treatment_cost = treatment_cost_per_year * years * participants_required / 2
  
  # Calculate total costs
  total_cost = screening_cost + treatment_cost
  
  # Create and return results list
  results <- list(
    screening_cost = screening_cost,
    participants_to_screen = participants_to_screen,
    treatment_cost = treatment_cost,
    total_cost = total_cost
  )
  
  return(results)
}

```


## ADNI

```{r}

# Load ADNI data for MCI
data_adni <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/adni/processed/longitudinal.csv')

# Filter only MCI, Amyloid Positive and first 24 months
data <- data_adni %>% 
  filter(VISCODE %in% c('bl', 'm06', 'm12', 'm18', 'm24')) %>%
  filter(ab_status == 'ab+') %>%
  filter(diagnosis == 'MCI')

# Extract those with delta_all above median
data_median <- data %>% 
  filter(delta > median(data$delta))

# Extract those with Optimum Threshold from previous notebook
data_opt <- data %>% 
  filter(delta > 3.88)

# Total number of unique participants in each
n_adni_participants <- length(unique(data$ID))
n_adni_participants_median <- length(unique(data_median$ID))
n_adni_participants_opt <- length(unique(data_opt$ID))

# Outcome of interest
outcome = 'CDRSUM'
```

### Linear Mixed Effects Model {.tabset}

#### All
```{r}
lmm_adni_all <-lmer(as.formula(paste(outcome, "~ time_mri + (1 + time_mri | ID)")), data = data)
summary(lmm_adni_all)
plot_model(lmm_adni_all, type = 'pred', terms = c('time_mri'))
```
#### Median

```{r}
lmm_adni_median <-lmer(as.formula(paste(outcome, "~ time_mri + (1 + time_mri | ID)")), data = data_median)
summary(lmm_adni_median)
plot_model(lmm_adni_median, type = 'pred', terms = c('time_mri'))
```

#### Optimum

```{r}
lmm_adni_opt <-lmer(as.formula(paste(outcome, "~ time_mri + (1 + time_mri | ID)")), data = data_opt)
summary(lmm_adni_opt)
plot_model(lmm_adni_opt, type = 'pred', terms = c('time_mri'))
```


### Sample and power caclulations {.tabset}

```{r}
# Set parameters for ADNI two years
t_visits_adni = seq(0, 2, 0.5)
```

#### All

```{r}
# calculate power / sample size using longpower package
pwr_all <- lmmpower(lmm_adni_all, pct.change = treatment_eff, t = t_visits_adni, power = power, sig.level = sig_level, n = n, method = method)
# Print number of subjects
n_adni_all <- pwr_all$N
n_adni_all
```
#### Median

```{r}
# calculate power / sample size using longpower package
pwr_median <- lmmpower(lmm_adni_median, pct.change = treatment_eff, t = t_visits_adni, power = power, sig.level = sig_level, n = n, method = method)
# Print number of subjects
n_adni_median <- pwr_median$N
n_adni_median
# Reduction percentage
reduction_median <- (n_adni_all - n_adni_median) / n_adni_all * 100
reduction_median
```

#### Optimum

```{r}
# calculate power / sample size using longpower package
pwr_opt <- lmmpower(lmm_adni_opt, pct.change = treatment_eff, t = t_visits_adni, power = power, sig.level = sig_level, n = n, method = method)
# Print number of subjects
n_adni_opt <- pwr_opt$N
n_adni_opt
# Reduction percentage
reduction_optimum <- (n_adni_all - n_adni_opt) / n_adni_all * 100
reduction_optimum
```

### Calculate savings {.tabset}

#### All
```{r}
cost_adni_all <- calculate_drug_trial_costs(
  years = 2,
  participants_required = n_adni_all,
  screen_pass_rate = screen_pass_lecanemab,
  screen_cost = scren_cost,
  mri_cost = screen_cost_mri,
  treatment_cost_per_year = treatment_cost_per_year,
  has_mri_screening = FALSE,
  mri_pass_rate = 0
)

cost_adni_all
```

#### Median
```{r}
mri_pass_rate_median = n_adni_participants_median / n_adni_participants
mri_pass_rate_median
cost_adni_median <- calculate_drug_trial_costs(
  years = 2,
  participants_required = n_adni_median,
  screen_pass_rate = screen_pass_lecanemab,
  screen_cost = scren_cost,
  mri_cost = screen_cost_mri,
  treatment_cost_per_year = treatment_cost_per_year,
  has_mri_screening = TRUE,
  mri_pass_rate = mri_pass_rate_median
)
cost_adni_median
```

#### Optimum
```{r}
mri_pass_rate_opt = n_adni_participants_opt / n_adni_participants
mri_pass_rate_opt
cost_adni_opt <- calculate_drug_trial_costs(
  years = 2,
  participants_required = n_adni_opt,
  screen_pass_rate = screen_pass_lecanemab,
  screen_cost = scren_cost,
  mri_cost = screen_cost_mri,
  treatment_cost_per_year = treatment_cost_per_year,
  has_mri_screening = TRUE,
  mri_pass_rate = mri_pass_rate_opt
)
cost_adni_opt
```
## A4

```{r}
# Load A4 data
data_a4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/a4/processed/longitudinal.csv')

# Placebo data
data_placebo <- data_a4 %>% 
  filter(cohort == 'A4 Placebo') %>% # Filter only with placebo
  filter(ab_status == 'ab+') %>% # Only placebo
  filter(VISCODE <= 60) # Only before the first 5 years

# Extract those with delta_all above median
data_a4_median <- data_placebo %>% 
  filter(delta > median(data_placebo$delta, na.rm = TRUE))

# Extract those with Optimum Threshold from previous notebook
data_a4_opt <- data_placebo %>% 
  filter(delta > 1.82)

# Total number of unique participants in each
n_a4_participants <- length(unique(data_placebo$ID))
n_a4_participants_median <- length(unique(data_a4_median$ID))
n_a4_participants_opt <- length(unique(data_a4_opt$ID))

# Outcome of interest
outcome = 'PACC'
```

### Linear Mixed Effects Model {.tabset}

#### All
```{r}
lmm_a4_all <-lmer(as.formula(paste(outcome, "~ time_mri + (1 + time_mri| ID)")), data = data_placebo)
summary(lmm_a4_all)
plot_model(lmm_a4_all, type = 'pred', terms = c('time_mri'))
```
#### Median

```{r}
lmm_a4_median <-lmer(as.formula(paste(outcome, "~ time_mri + (1 + time_mri | ID)")), data = data_a4_median)
summary(lmm_a4_median)
plot_model(lmm_a4_median, type = 'pred', terms = c('time_mri'))
```

#### Optimum

```{r}
lmm_a4_opt <-lmer(as.formula(paste(outcome, "~ time_mri + (1 + time_mri | ID)")), data = data_a4_opt)
summary(lmm_a4_opt)
plot_model(lmm_a4_opt, type = 'pred', terms = c('time_mri'))
```


### Sample and power caclulations {.tabset}

```{r}
# Set parameters for A4 5 years
t_visits_a4 = seq(0, 5, 0.5)
```

#### All

```{r}
# calculate power / sample size using longpower package
pwr_all_a4 <- lmmpower(lmm_a4_all, pct.change = treatment_eff, t = t_visits_a4, power = power, sig.level = sig_level, n = n, method = method)
# Print number of subjects
n_a4_all <- pwr_all_a4$N
n_a4_all
```
#### Median

```{r}
# calculate power / sample size using longpower package
pwr_median_a4 <- lmmpower(lmm_a4_median, pct.change = treatment_eff, t = t_visits_a4, power = power, sig.level = sig_level, n = n, method = method)
# Print number of subjects
n_a4_median <- pwr_median_a4$N
n_a4_median
# Reduction percentage
reduction_median <- (n_a4_all - n_a4_median) / n_a4_all * 100
reduction_median
```

#### Optimum

```{r}
# calculate power / sample size using longpower package
pwr_opt_a4 <- lmmpower(lmm_a4_opt, pct.change = treatment_eff, t = t_visits_adni, power = power, sig.level = sig_level, n = n, method = method)
# Print number of subjects
n_a4_opt <- pwr_opt_a4$N
n_a4_opt
# Reduction percentage
reduction_optimum <- (n_a4_all - n_a4_opt) / n_a4_all * 100
reduction_optimum
```
