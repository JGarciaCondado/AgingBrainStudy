---
title: "Clinical Enrichment with BrainAge"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('ClinicalEnrichment.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/ClinicalEnrichment', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr); library(dplyr);library(nlme); library(sjPlot);library(longpower);library(ggeffects)

# Load cost of clinical trial
source('~/Documents/Projects/AgingBrainStudy/scripts/calculate_drug_trial_costs.R')

# Path to save figures
path = '~/Documents/Projects/AgingBrainStudy/figures/clinical_enrichment/'

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
theme_set(theme_bw())
```

# Brain Age in Clinical Trials

We will explore usign BrainAge as a clinical enrichment biomarker in two clinical trials:

-   ADNI: MCI participants with amyloid positivity in two year trial looking at CDR sum of boxes
-   A4: Preclinical AD participants with amyloid positivity in five year trial looking at PACC

```{r}
# Trial variables
treatment_eff = 0.27
power = 0.9
sig_level = 0.05
n = NULL
method = 'edland'

# Lecanemab costs
screened_lecanemab = 5967
recruited_lecanemab = 1796
treatment_cost_per_year = 26500
scren_cost = 6957
screen_cost_mri = 353
screen_pass_lecanemab = recruited_lecanemab / screened_lecanemab
```

# ADNI

```{r}

# Load ADNI data for MCI
data_adni <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/adni/processed/longitudinal.csv')

# Filter only MCI, Amyloid Positive and first 24 months
data <- data_adni %>% 
  filter(VISCODE %in% c('bl', 'm06', 'm12', 'm18', 'm24')) %>%
  filter(ab_status == 'ab+') %>%
  filter(diagnosis == 'MCI')

# Extract those with delta_all above median
data_median <- data %>% 
  filter(delta > median(data$delta))

# Total number of unique participants in each
n_adni_participants <- length(unique(data$ID))
n_adni_participants_median <- length(unique(data_median$ID))

# Outcome of interest
outcome = 'CDRSUM'
```

## Linear Mixed Effects Model {.tabset}

Simple linear mixed effects model with random intercept and slope for each particpant for the three subsets.

### All

```{r}
# Create model
lmm_adni_all <-lmer(as.formula(paste(outcome, "~ time_mri + (1 + time_mri | ID)")), data = data)

# Plot model
adni_all_p <- plot(ggpredict(lmm_adni_all, terms = c("time_mri [all]"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, max(data$time_mri))) + 
  scale_y_continuous(limits = c(0, 4.5)) +
  labs(
    title = "",
    y = "CDRSUM",
    x = "Time from MRI (years)",
  )
  
print(adni_all_p)

# Save model
adni_all_p <- adni_all_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.15, 0.15, 0.15, 0.15), "cm"),
    ) 
ggsave(paste(path, 'lme_adni_all.png'), adni_all_p, 
       width = 70, height = 70, units = "mm", 
       dpi = 500,   # Higher resolution
       scale = 1)
```

### Median

```{r}
# Create model
lmm_adni_median <-lmer(as.formula(paste(outcome, "~ time_mri + (1 + time_mri | ID)")), data = data_median)

# Plot model
adni_median_p <- plot(ggpredict(lmm_adni_median, terms = c("time_mri [all]"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, max(data$time_mri))) + 
  scale_y_continuous(limits = c(0, 4.5)) +
  labs(
    title = "",
    y = "CDRSUM",
    x = "Time from MRI (years)",
  )
  
print(adni_median_p)

# Save model
adni_median_p <- adni_median_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.15, 0.15, 0.15, 0.15), "cm"),
    ) 
ggsave(paste(path, 'lme_adni_median.png'), adni_median_p, 
       width = 70, height = 70, units = "mm", 
       dpi = 500,   # Higher resolution
       scale = 1)
```

## Sample and power caclulations {.tabset}

The trial will last 2 years with follow ups every 6 months.

```{r}
# Set parameters for ADNI two years
t_visits_adni = seq(0, 2, 0.5)
```

### All

```{r}
# calculate power / sample size using longpower package
pwr_all <- lmmpower(lmm_adni_all, pct.change = treatment_eff, t = t_visits_adni, power = power, sig.level = sig_level, n = n, method = method)

# Print number of subjects
n_adni_all <- pwr_all$N
cat("Number of participants required for clinical trial: ", n_adni_all, "\n")
```

### Median

```{r}
# calculate power / sample size using longpower package
pwr_median <- lmmpower(lmm_adni_median, pct.change = treatment_eff, t = t_visits_adni, power = power, sig.level = sig_level, n = n, method = method)

# Print number of subjects
n_adni_median <- pwr_median$N
cat("Number of participants required for clinical trial: ", n_adni_median, "\n")

# Reduction percentage
reduction_median <- (n_adni_all - n_adni_median) / n_adni_all * 100
cat("Reduction in number of participants required: ", reduction_median, "%\n")
```

## Calculate savings {.tabset}

Calculate costs of the trail

### All

```{r}

#Calculate cost
cost_adni_all <- calculate_drug_trial_costs(
  years = 2,
  participants_required = n_adni_all,
  screen_pass_rate = screen_pass_lecanemab,
  screen_cost = scren_cost,
  mri_cost = screen_cost_mri,
  treatment_cost_per_year = treatment_cost_per_year,
  has_mri_screening = FALSE,
  mri_pass_rate = 0
)

cat("Total cost of the trial: ", cost_adni_all$total_cost, "\n")
cat("Screening cost: ", cost_adni_all$screening_cost, "\n")
cat("Participants to screen: ", cost_adni_all$participants_to_screen, "\n")
cat("Treatment cost: ", cost_adni_all$treatment_cost, "\n")
```

### Median

```{r}

# Calculate pass rate for MRI
mri_pass_rate_median = n_adni_participants_median / n_adni_participants
cat("MRI pass rate: ", mri_pass_rate_median, "\n")

# Calculate cost
cost_adni_median <- calculate_drug_trial_costs(
  years = 2,
  participants_required = n_adni_median,
  screen_pass_rate = screen_pass_lecanemab,
  screen_cost = scren_cost,
  mri_cost = screen_cost_mri,
  treatment_cost_per_year = treatment_cost_per_year,
  has_mri_screening = TRUE,
  mri_pass_rate = mri_pass_rate_median
)

cat("Total cost of the trial: ", cost_adni_median$total_cost, "\n")
cat("Screening cost: ", cost_adni_median$screening_cost, "\n")
cat("Participants to screen: ", cost_adni_median$participants_to_screen, "\n")
cat("Treatment cost: ", cost_adni_median$treatment_cost, "\n")
```


# A4

```{r}
# Load A4 data
data_a4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/a4/processed/longitudinal.csv')

# Placebo data
data_placebo <- data_a4 %>% 
  filter(cohort == 'A4 Placebo') %>% # Filter only with placebo
  filter(ab_status == 'ab+') %>% # Only placebo
  filter(VISCODE <= 60) # Only before the first 5 years

# Extract those with delta_all above median
data_a4_median <- data_placebo %>% 
  filter(delta > median(data_placebo$delta, na.rm = TRUE))

# Total number of unique participants in each
n_a4_participants <- length(unique(data_placebo$ID))
n_a4_participants_median <- length(unique(data_a4_median$ID))

# Outcome of interest
outcome = 'PACC'
```

## Linear Mixed Effects Model {.tabset}

Simple linear mixed effects model with random intercept and slope for each particpant for the three subsets.

### All

```{r}
# Create model
lmm_a4_all <-lmer(as.formula(paste(outcome, "~time_mri + LMSTORY + (1 + time_mri | ID)")), data = data_placebo)

# Plot model
a4_all_p <- plot(ggpredict(lmm_a4_all, terms = c("time_mri [all]"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, max(data_placebo$time_mri))) + 
  scale_y_continuous(limits = c(-1, 1)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
  )
  
print(a4_all_p)

# Save model
a4_all_p <- a4_all_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.15, 0.15, 0.15, 0.15), "cm"),
    ) 
ggsave(paste(path, 'lme_a4_all.png'), a4_all_p, 
       width = 70, height = 70, units = "mm", 
       dpi = 500,   # Higher resolution
       scale = 1)
```

### Median

```{r}
# Create model
lmm_a4_median <-lmer(as.formula(paste(outcome, "~time_mri + LMSTORY + (1 + time_mri | ID)")), data = data_a4_median)

# Plot model
a4_median_p <- plot(ggpredict(lmm_a4_median, terms = c("time_mri [all]"))) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, max(data_placebo$time_mri))) + 
  scale_y_continuous(limits = c(-1, 1)) +
  labs(
    title = "",
    y = "PACC",
    x = "Time from MRI (years)",
  )
  
print(a4_median_p)

# Save model
a4_median_p <- a4_median_p +
  theme(
      text = element_text(family = "Times New Roman", size = 12),
      axis.text = element_text(family = "Times New Roman", size = 12),
      axis.title = element_text(family = "Times New Roman", size = 12),
      plot.margin = unit(c(0.15, 0.15, 0.15, 0.15), "cm"),
    ) 
ggsave(paste(path, 'lme_a4_median.png'), a4_median_p, 
       width = 70, height = 70, units = "mm", 
       dpi = 500,   # Higher resolution
       scale = 1)
```

## Sample and power caclulations {.tabset}

Trial duration is 5 years with follow ups every 6 months.

```{r}
# Set parameters for A4 5 years
t_visits_a4 = seq(0, 5, 0.5)
```

### All

```{r}
# calculate power / sample size using longpower package
pwr_all_a4 <- lmmpower(lmm_a4_all, pct.change = treatment_eff, t = t_visits_a4, power = power, sig.level = sig_level, n = n, method = method)

# Print number of subjects
n_a4_all <- pwr_all_a4$N
cat("Number of participants required for clinical trial: ", n_a4_all, "\n")
```

### Median

```{r}
# calculate power / sample size using longpower package
pwr_median_a4 <- lmmpower(lmm_a4_median, pct.change = treatment_eff, t = t_visits_a4, power = power, sig.level = sig_level, n = n, method = method)

# Print number of subjects
n_a4_median <- pwr_median_a4$N
cat("Number of participants required for clinical trial: ", n_a4_median, "\n")

# Reduction percentage
reduction_median <- (n_a4_all - n_a4_median) / n_a4_all * 100
cat("Reduction in number of participants required: ", reduction_median, "%\n")

# Screen fails for MRI
mri_pass_rate_median = n_a4_participants_median / n_a4_participants
cat("MRI pass rate: ", mri_pass_rate_median, "\n")
```