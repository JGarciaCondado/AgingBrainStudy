---
title: "Simulations"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('Simulations.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/Simulations', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr); library(MASS); library(dplyr);library(nlme);library(sjPlot);library(longpower);


knitr::opts_chunk$set(echo = FALSE, message = FALSE)
theme_set(theme_bw())
```


# Brain Age power analysis

```{r}

# Load HABS data
data_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/HABS/raw/longitudinal_PACC.csv')

# Load delta
deltas_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/HABS/structural_brainage/ageml/model_age/predicted_age.csv')
data_habs <- merge(data_habs, deltas_habs, by = 'SubjIDshort', all.x = TRUE)

# Create new variable delta_group where is 0 below younger and older above zero
data_habs <- data_habs %>% 
  mutate(delta_group = ifelse(delta_all < 0, 'younger', 'older'))

# Add factors
factors_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/HABS/processed/factors.csv')
factors_habs <- factors_habs %>% 
  select(SubjIDshort, p_tau217, p_tau217_ratio, PIB_FS_SUVR_FLR, PIB_FS_SUVR_Group, tau_composite)
data_habs <- merge(data_habs, factors_habs, by = 'SubjIDshort', all.x = TRUE)

# Ensure correct typing
data_habs$NP_SessionDate <- as.Date(data_habs$NP_SessionDate)
data_habs <- data_habs %>%
  mutate(across(c(E4_Status, PIB_FS_SUVR_Group), as.factor))

# Filter subjects with less than 2 data points
data_habs <- data_habs %>% 
  arrange(SubjIDshort, NP_SessionDate) %>%  
  group_by(SubjIDshort) %>% 
  add_tally(name = 'nTimePoints', wt = !is.na(NP_PACC_PACC5)) %>%
  filter(nTimePoints >= 2) %>%
  mutate(time_from_bl = as.numeric(NP_SessionDate - min(NP_SessionDate, na.rm = TRUE))/365.25)  %>%
  mutate(PACC_change_bl = NP_PACC_PACC5 - NP_PACC_PACC5[1])

# Create baseline data set
baseline_habs <- data_habs %>% 
  group_by(SubjIDshort) %>%
  arrange(NP_SessionDate) %>%
  slice(1) %>% #extract first rows - can also use slice_head() for first and slice_tail() for last
  rename(BL_Age = NP_Age) %>%
  rename(BL_PACC = NP_PACC_PACC5) %>%
  ungroup()

# Add age at baseline of subjects
data_habs <- data_habs %>%
  left_join(baseline_habs %>% select(SubjIDshort, BL_Age, BL_PACC), by = 'SubjIDshort')
```

Linear mixed effects model

```{r}
# remove those with delta lower than 2
#data_habs <- data_habs %>% filter(delta_all > 0)
lmm_results_habs_pacc <- lme(NP_PACC_PACC5 ~ time_from_bl, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs_pacc)
plot_model(lmm_results_habs_pacc, type = c('pred'), terms = c('time_from_bl'))
```
Power caclulations with object

```{r}
effect = 0.27
time_points = seq(0, 2, 0.5)
sig.level = 0.05
power = 0.8
lmmpower(lmm_results_habs_pacc, pct.change = effect, t = time_points, sig.level = sig.level, power = power)
```

Power calculations with measurments

```{r}
vc_matrix <- VarCorr(lmm_results_habs_pacc)
vc_numeric <- as.numeric(vc_matrix)
random_intercept_var = vc_numeric[1]
random_slope_var = vc_numeric[2]
random_residual_var = vc_numeric[3]
corr_intercept_slope = vc_numeric[8]
lmmpower(sig2.i = random_intercept_var, sig2.s = random_slope_var, sig2.e = random_residual_var, cor.s.i = corr_intercept_slope, pct.change = effect, t = time_points, sig.level = sig.level, power = power)
lmmpower(n=100, sig2.i = 0.1, sig2.s = 0.1, sig2.e = 0.1, cor.s.i = 0.1, 
         pct.change = 0.1, t = 3, sig.level = 0.05, power = 0.08)
```

Simulations

```{r}
simulate_longitudinal_data <- function(
  numsubj,                # Number of subjects
  t,                      # Vector of time points
  intercept,              # Fixed intercept
  slope,                  # Fixed slope
  random_intercept_var,   # Variance of random intercept
  random_slope_var,       # Variance of random slope
  corr_intercept_slope,   # Correlation between intercept and slope
  random_residual_var,    # Variance of residual error
  effect                  # Treatment effect
) {
  
  # Random effects simulation
  cov_intercept_slope <- corr_intercept_slope * sqrt(random_intercept_var) * sqrt(random_slope_var)
  sigma_matrix <- matrix(
    c(random_intercept_var, cov_intercept_slope, cov_intercept_slope, random_slope_var),
    nrow = 2, byrow = TRUE
  )
  randeff <- MASS::mvrnorm(n = numsubj, mu = c(0, 0), Sigma = sigma_matrix)
  
  # Assignation of treatment
  data <- data.frame(
    id = 1:numsubj,
    randint = randeff[, 1],
    randsl = randeff[, 2],
    txt = rep(c(0, 1), each = numsubj / 2)
  )
  
  # Simulate observations dynamically
  for (i in seq_along(t)) {
    data[[paste0("obs", i)]] <- intercept + data$randint + 
      t[i] * (slope + data$randsl - slope * effect * data$txt) +
      rnorm(numsubj, 0, random_residual_var)
  }
  
  # Convert to long format
  data_long <- data %>%
    tidyr::pivot_longer(
      cols = starts_with("obs"),
      names_to = "timepoint",
      values_to = "obs"
    ) %>%
    mutate(time = rep(t, times = numsubj))
  
  # Sort by subject ID and time
  data_long <- data_long[order(data_long$id, data_long$time), ]
  
  return(data_long)
}
```

```{r}
# Specific trial metrics
numsubj = 2000
effect = 0.27
t <- seq(0, 2, 0.5)

# Fixe effects extrcted from lme model
results_table <- summary(lmm_results_habs_pacc)$tTable
intercept <- results_table[1, 1]
slope <- results_table[2, 1]

# Random effect variance
vc_matrix <- VarCorr(lmm_results_habs_pacc)
vc_numeric <- as.numeric(vc_matrix)
random_intercept_var = vc_numeric[1]
random_slope_var = vc_numeric[2]
random_residual_var = vc_numeric[3]
corr_intercept_slope = vc_numeric[8]

# Simulate data
data_long <- simulate_longitudinal_data(
  numsubj = numsubj,
  t = t,
  intercept = intercept,
  slope = slope,
  random_intercept_var = random_intercept_var,
  random_slope_var = random_slope_var,
  corr_intercept_slope = corr_intercept_slope,
  random_residual_var = random_residual_var,
  effect = effect
)

# Create lme model and show restuls
results <- lme(obs ~ time*txt, random = ~time|id, data = data_long, control=lmeControl(maxiter=100,opt="optim"))
summary(results)$tTable[4, 5]
plot_model(results, type = c('pred'), terms = c('time', 'txt'))
```

```{r}
# Create dataframe to store results of simulation
numsim = 100
results_sim <- data.frame(
  time_txt_pval = rep(NA, numsim)
)

# Simulate data 
for (i in 1:numsim) {
  data_long <- simulate_longitudinal_data(
    numsubj = numsubj,
    t = t,
    intercept = intercept,
    slope = slope,
    random_intercept_var = random_intercept_var,
    random_slope_var = random_slope_var,
    corr_intercept_slope = corr_intercept_slope,
    random_residual_var = random_residual_var,
    effect = effect
  )
  
  # Create lme model
  results <- lme(obs ~ time*txt, random = ~time|id, data = data_long, control=lmeControl(maxiter=100,opt="optim"))
  time_txt_pval <- summary(results)$tTable[4, 5]
  
  # Store results
  results_sim$time_txt_pval[i] <- time_txt_pval
}
```

```{r}
# Calculate power of simulation
sig.level = 0.05
power = mean(results_sim$time_txt_pval < sig.level)
```

