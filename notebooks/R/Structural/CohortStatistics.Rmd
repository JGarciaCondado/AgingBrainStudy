---
title: "Cohort Statistics"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('CohortStatistics.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/CohortStatistics', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(dplyr);library(gtsummary); library(flextable);


knitr::opts_chunk$set(echo = FALSE, message = FALSE)
theme_set(theme_bw())
```

# Data load

## HABS

```{r}

# Load HABS data
data_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/HABS/raw/longitudinal_PACC.csv')

# Load delta
deltas_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/HABS/structural_brainage/ageml/model_age/predicted_age.csv')
data_habs <- merge(data_habs, deltas_habs, by = 'SubjIDshort', all.x = TRUE)

# Create new variable delta_group where is 0 below younger and older above zero
data_habs <- data_habs %>% 
  mutate(delta_group = ifelse(delta_all < 0, 'younger', 'older'))

# Add factors
factors_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/HABS/processed/factors.csv')
factors_habs <- factors_habs %>% 
  select(SubjIDshort, p_tau217, p_tau217_ratio, PIB_FS_SUVR_FLR, PIB_FS_SUVR_Group, tau_composite)
data_habs <- merge(data_habs, factors_habs, by = 'SubjIDshort', all.x = TRUE)

# Ensure correct typing
data_habs$NP_SessionDate <- as.Date(data_habs$NP_SessionDate)
data_habs <- data_habs %>%
  mutate(across(c(E4_Status, PIB_FS_SUVR_Group), as.factor))

# Filter subjects with less than 2 data points
data_habs <- data_habs %>% 
  arrange(SubjIDshort, NP_SessionDate) %>%  
  group_by(SubjIDshort) %>% 
  add_tally(name = 'nTimePoints', wt = !is.na(NP_PACC_PACC5)) %>%
  filter(nTimePoints >= 2) %>%
  mutate(time_from_bl = as.numeric(NP_SessionDate - min(NP_SessionDate, na.rm = TRUE))/365.25)  %>%
  mutate(PACC_change_bl = NP_PACC_PACC5 - NP_PACC_PACC5[1])

# Create baseline data set
baseline_habs <- data_habs %>% 
  group_by(SubjIDshort) %>%
  arrange(NP_SessionDate) %>%
  slice(1) %>% #extract first rows - can also use slice_head() for first and slice_tail() for last
  rename(BL_Age = NP_Age) %>%
  rename(BL_PACC = NP_PACC_PACC5) %>%
  ungroup()

# Add age at baseline of subjects
data_habs <- data_habs %>%
  left_join(baseline_habs %>% select(SubjIDshort, BL_Age, BL_PACC), by = 'SubjIDshort')

# Ensure factors
data_habs <- data_habs %>%
  mutate_at(vars(SEX, E4_Status), factor)
```

## ADNI

```{r}

# Load ADNI data
data_adni <- read.csv('~/Documents/Projects/AgingBrainStudy/data/ADNI/raw/adni_03242025.csv')

# Concert time from baseline to years
data_adni <- data_adni %>% 
  rename(time_from_bl = MonthsFromBaseline_PACC) %>%
  mutate(time_from_bl = time_from_bl/12)

# Load deltas
deltas_adni <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/ADNI/ageml/model_age/predicted_age.csv')
data_adni <- merge(data_adni, deltas_adni, by = 'ID')

# Create new variable delta_group where is 0 below younger and older above zero
data_adni <- data_adni %>% 
  mutate(delta_group = ifelse(delta_all < 0, 'younger', 'older'))

# Arrange by pacc_time and calculate PACC_change_bl
data_adni <- data_adni %>% 
  arrange(ID, time_from_bl) %>%
  group_by(ID) %>%
  add_tally(name = 'nTimePoints', wt = !is.na(zPACC)) %>%
  filter(nTimePoints >= 2) %>%
  mutate(PACC_bl = zPACC[1]) %>%
  mutate(PACC_change_bl = zPACC - PACC_bl)

# Load factors
factors_adni <- read.csv('~/Documents/Projects/AgingBrainStudy/data/ADNI/processed/factors.csv', na.strings = c("", " ", "NaN", "NA", NA))
factors_adni <- factors_adni %>%
  rename(amyloid_composite = CENTILOIDS_AMYLOID) %>%
  select(ID, pT217, amyloid_composite, tau_composite)
data_adni <- merge(data_adni, factors_adni, by = 'ID', all.x = TRUE)

# Ensur MRI_SessionDate and TAU_SCANDATE are in the format YYYY-MM-DD
data_adni <- data_adni %>%
  mutate(MRI_SessionDate = as.Date(MRI_SessionDate, format = "%Y-%m-%d"),
         PACC_Date = as.Date(PACC_Date, format = "%Y-%m-%d"),
         AB_SCANDATE = as.Date(AB_SCANDATE, format = "%Y-%m-%d"),
         TAU_SCANDATE = as.Date(TAU_SCANDATE, format = "%Y-%m-%d"),
         EXAMDATE_PLASMA = as.Date(EXAMDATE_PLASMA, format = "%Y-%m-%d"))

data_adni <- data_adni %>%
  mutate(TAU_MRI_Diff = ifelse(!is.na(TAU_SCANDATE) & !is.na(MRI_SessionDate), 
                               as.numeric(difftime(TAU_SCANDATE, MRI_SessionDate, units = "days"))/365, NA)) %>%
  mutate(AB_MRI_Diff = ifelse(!is.na(AB_SCANDATE) & !is.na(MRI_SessionDate), 
                               as.numeric(difftime(AB_SCANDATE, MRI_SessionDate, units = "days"))/365, NA)) %>%
  mutate(Plasma_MRI_Diff= ifelse(!is.na(EXAMDATE_PLASMA) & !is.na(MRI_SessionDate), 
                               as.numeric(difftime(EXAMDATE_PLASMA, MRI_SessionDate, units = "days"))/365, NA)) %>%
  mutate(PACC_MRI_Diff = ifelse(!is.na(PACC_Date) & !is.na(MRI_SessionDate), 
                               as.numeric(difftime(PACC_Date, MRI_SessionDate, units = "days"))/365, NA))

# Devide between Baseline_diagnosis CN and MCI
data_adni_mci <- data_adni %>% 
  filter(Baseline_Diagnosis == 'MCI')
data_adni_cn <- data_adni %>%
  filter(Baseline_Diagnosis == 'CN')

# Data ADNI baseline
data_adni_baseline <- data_adni %>%
  group_by(ID) %>%
  arrange(MRI_SessionDate) %>%
  slice(1) # Select the first time point for each ID
```

# Imaging times statistics

```{r}
ggplot(subset(data_adni_baseline, !is.na(PACC_MRI_Diff)), aes(x = PACC_MRI_Diff)) +
  geom_histogram(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Histogram of PACC_MRI_DiffDays at Baseline",
       x = "PACC_MRI_Diff",
       y = "Count") +
  theme_minimal()

ggplot(subset(data_adni_baseline, !is.na(TAU_MRI_Diff)), aes(x = TAU_MRI_Diff)) +
  geom_histogram(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Histogram of TAU_MRI_DiffDays at Baseline",
       x = "TAU_MRI_Diff",
       y = "Count") +
  theme_minimal()

ggplot(subset(data_adni_baseline, !is.na(AB_MRI_Diff)), aes(x = AB_MRI_Diff)) +
  geom_histogram(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Histogram of AB_MRI_DiffDays at Baseline",
       x = "AB_MRI_Diff",
       y = "Count") +
  theme_minimal()

ggplot(subset(data_adni_baseline, !is.na(Plasma_MRI_Diff)), aes(x = Plasma_MRI_Diff)) +
  geom_histogram(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Histogram of Plasma_MRI_DiffDays at Baseline",
       x = "Plasma_MRI_Diff",
       y = "Count") +
  theme_minimal()

# Save in processed this difference data
save_path <- '~/Documents/Projects/AgingBrainStudy/data/ADNI/processed/'
data_adni_time_diff <- data_adni_baseline %>%
  select(ID, TAU_MRI_Diff, AB_MRI_Diff, Plasma_MRI_Diff, PACC_MRI_Diff)
write.csv(data_adni_time_diff, 
          file = paste0(save_path, 'data_adni_time_diff.csv'), 
          row.names = FALSE)
```
