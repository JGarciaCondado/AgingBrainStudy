---
title: "Cohort Statistics"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('CohortStatistics.Rmd',
      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/CohortStatistics', '.html', sep=''))
      })
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(dplyr);library(gtsummary); library(flextable);


knitr::opts_chunk$set(echo = FALSE, message = FALSE)
theme_set(theme_bw())
```

# Data load

```{r}
# Load A4
data_a4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/a4/processed/baseline.csv',
                     na.strings = c("", "NA"))

# Load HABS data
data_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/habs/processed/baseline.csv',
                      na.strings = c("", "NA"))

# Load ADNI data
data_adni <- read.csv('~/Documents/Projects/AgingBrainStudy/data/final/adni/processed/baseline.csv',
                      na.strings = c("", "NA"))

# Create cohort variables
data_a4 <- data_a4 %>%
  mutate(cohort = 'A4/LEARN')
data_habs <- data_habs %>%
  mutate(cohort = 'HABS')
data_adni <- data_adni %>%
  mutate(cohort = ifelse(diagnosis == 'CN', 'ADNI CU', 'ADNI MCI'))

# Paste together
data_all <- bind_rows(data_a4, data_habs, data_adni)

# Change NaN in e4_carrier and ab_status to Unknown
data_all <- data_all %>%
  mutate(e4_carrier = ifelse(is.na(e4_carrier), 'Unknown', e4_carrier),
         ab_status = ifelse(is.na(ab_status), 'Unknown', ab_status))

# Ensure factors
data_all <- data_all %>%
  mutate_at(vars(sex, e4_carrier, ab_status), factor)
```


# Demogprahics

```{r}
# Specify order of cohorts
data_all$cohort <- factor(data_all$cohort, levels = c("A4/LEARN", "HABS", "ADNI CU", "ADNI MCI"))

demo_table <- tbl_summary(data_all,
            include = c(mri_age, sex, edu, e4_carrier, ab_status,  PACC_mri, time_diff_pacc, follow_up_time, ab_composite, time_diff_ab, ptau, time_diff_ptau, tau_composite, time_diff_tau),
            missing = "no",
            statistic = list(all_continuous()  ~ c("{mean} ({sd})")),
            label = list(
              mri_age ~ "Age", 
              edu ~ "Education (Years)", 
              sex ~ "Sex",
              e4_carrier ~ "APOEe4",
              ab_status ~ "AB status",
              PACC_mri ~ "PACC at MRI",
              time_diff_pacc ~ "PACC Time from MRI (Years)",
              follow_up_time ~ "Follow-up Time (Years)", 
              ab_composite ~ "AB-PET",
              time_diff_ab ~ "AB PET Time from MRI (Years)",
              ptau ~ "pTau217",
              time_diff_ptau ~ "pTau217 Time from MRI (Years)",
              tau_composite ~ "Tau-PET",
              time_diff_tau ~ "Tau PET Time from MRI (Years)"),
            digits = list(all_continuous() ~ 2, all_categorical() ~ c(0,2)),
            by = cohort) %>%
        bold_labels() %>%
        add_p() %>%
        modify_table_styling(
          columns = label,
          rows = label == "AB-PET",
          footnote = "A4/LEARN and ADNI use 18F-Florbetapir (FBP) tracer and SUVRs and HABS uses 11C Pittsburgh compound-B (PiB) and DVR",
        )  %>%
        modify_table_styling(
          columns = label,
          rows = label == "pTau217",
          footnote = "A4 uses levels of pTau217 from E-Lilly, HABS uses the ratio of pTau217 to npTau217 from C2N and ADNI uses the ratio of pTau217 to AB42 from Lumipulse."
        )   %>%
        modify_table_styling(
          columns = label,
          rows = label == "Tau-PET",
          footnote = "A4/LEARN, HABS and ADNI all use 18F-Flortaucipir (FTP) and PVC SUVR."
        ) 

# Print table
demo_table

# Save to docx
demo_table %>%
  as_flex_table() %>% 
  fontsize(size = 9, part = "all") %>%
  line_spacing(space = 1.05, part = "all") %>%
  autofit() %>%
  save_as_docx(path = "~/Documents/Projects/AgingBrainStudy/tables/demographics.docx")
```

# Analysis breakdown {.tabset}

```{r}

# First, create a base dataset with "analysis" column set to "primary" for all rows
data_primary <- data_all %>%
  mutate(analysis = "primary")

# Create dataset with rows that have secondary = 1
data_secondary <- data_all %>%
  filter(secondary == 1) %>%
  mutate(analysis = "secondary")

# Create dataset with rows that have exploratory = 1
data_exploratory <- data_all %>%
  filter(exploratory == 1) %>%
  mutate(analysis = "exploratory")

# Now combine all datasets
data_combined <- bind_rows(data_primary, data_secondary, data_exploratory)

# Sort the data to keep related rows together (optional)
# Assuming you have an ID column, otherwise use other columns that uniquely identify the original rows
data_combined <- data_combined %>%
  arrange(ID)

# Set order of anlaysis
data_combined$analysis <- factor(data_combined$analysis, levels = c("primary", "secondary", "exploratory"))

# First create a summary table stratified by analysis
analysis_table <- data_combined %>%
  tbl_strata(
    strata = cohort,  # First stratify by cohort
    .tbl_fun =
      ~ .x %>%
        tbl_summary(  # Then create summary tables with analysis as the by variable
          include = c(mri_age, sex, edu, e4_carrier, ab_status, PACC_mri, time_diff_pacc, follow_up_time),
          missing = "no",
          statistic = list(all_continuous() ~ c("{mean} ({sd})")),
          label = list(
            mri_age ~ "Age", 
            edu ~ "Education (Years)", 
            sex ~ "Sex",
            e4_carrier ~ "APOEe4",
            ab_status ~ "AB status",
            PACC_mri ~ "PACC at MRI",
            time_diff_pacc ~ "PACC Time from MRI (Years)",
            follow_up_time ~ "Follow-up Time (Years)"), 
          digits = list(all_continuous() ~ 2, all_categorical() ~ c(0,2)),
          by = analysis) %>%
        bold_labels() %>%
        add_p()
    )

# Print the table
analysis_table

#Save to docx
analysis_table %>%
  as_flex_table() %>% 
  fontsize(size = 9, part = "all") %>%
  line_spacing(space = 1.05, part = "all") %>%
  autofit() %>%
  save_as_docx(path = "~/Documents/Projects/AgingBrainStudy/tables/analysis.docx")
```

## A4
```{r}
# Count total observations in the dataset
total_obs <- nrow(data_a4)

# Count how many have values for each variable
have_ab_composite <- sum(!is.na(data_a4$ab_composite))
have_ptau217 <- sum(!is.na(data_a4$ptau))
have_tau <- sum(!is.na(data_a4$tau_composite))

# Count how many have both variables
have_both <- sum(!is.na(data_a4$ab_composite) & !is.na(data_a4$ptau))
have_all <- sum(!is.na(data_a4$ab_composite) & !is.na(data_a4$ptau) & !is.na(data_a4$tau_composite))

# Create a summary
cat("Total observations:", total_obs, "\n")
cat("Have ab_composite:", have_ab_composite, "(", round(have_ab_composite/total_obs*100, 1), "%)\n")
cat("Have ptau217:", have_ptau217, "(", round(have_ptau217/total_obs*100, 1), "%)\n")
cat("Have both:", have_both, "(", round(have_both/total_obs*100, 1), "%)\n")
cat("Have tau:", have_tau, "(", round(have_tau/total_obs*100, 1), "%)\n")
cat("Have all:", have_all, "(", round(have_all/total_obs*100, 1), "%)\n")

# Analysis type
cat("Secondary analysis:", sum(data_a4$secondary), "(", round(sum(data_a4$secondary)/total_obs*100, 1), "%)\n")
cat("Exploratory analysis:", sum(data_a4$exploratory), "(", round(sum(data_a4$exploratory)/total_obs*100, 1), "%)\n")
```

## HABS

```{r}
# Count total observations in the dataset
total_obs <- nrow(data_habs)

# Count how many have values for each variable
have_ab_composite <- sum(!is.na(data_habs$ab_composite))
have_ptau217 <- sum(!is.na(data_habs$ptau))
have_tau <- sum(!is.na(data_habs$tau_composite))

# Count how many have both variables
have_both <- sum(!is.na(data_habs$ab_composite) & !is.na(data_habs$ptau))
have_all <- sum(!is.na(data_habs$ab_composite) & !is.na(data_habs$ptau) & !is.na(data_habs$tau_composite))

# Create a summary
cat("Total observations:", total_obs, "\n")
cat("Have ab_composite:", have_ab_composite, "(", round(have_ab_composite/total_obs*100, 1), "%)\n")
cat("Have ptau217:", have_ptau217, "(", round(have_ptau217/total_obs*100, 1), "%)\n")
cat("Have both:", have_both, "(", round(have_both/total_obs*100, 1), "%)\n")
cat("Have tau:", have_tau, "(", round(have_tau/total_obs*100, 1), "%)\n")
cat("Have all:", have_all, "(", round(have_all/total_obs*100, 1), "%)\n")

# Analysis type
cat("Secondary analysis:", sum(data_habs$secondary), "(", round(sum(data_habs$secondary)/total_obs*100, 1), "%)\n")
cat("Exploratory analysis:", sum(data_habs$exploratory), "(", round(sum(data_habs$exploratory)/total_obs*100, 1), "%)\n")
```
## ADNI CU

```{r}
# Count total observations in the dataset
total_obs <- nrow(data_adni[data_adni$diagnosis == 'CN',])

# Count how many have values for each variable
have_ab_composite <- sum(!is.na(data_adni[data_adni$diagnosis == 'CN',]$ab_composite))
have_ptau217 <- sum(!is.na(data_adni[data_adni$diagnosis == 'CN',]$ptau))
have_tau <- sum(!is.na(data_adni[data_adni$diagnosis == 'CN',]$tau_composite))

# Count how many have both variables
have_both <- sum(!is.na(data_adni[data_adni$diagnosis == 'CN',]$ab_composite) & !is.na(data_adni[data_adni$diagnosis == 'CN',]$ptau))
have_all <- sum(!is.na(data_adni[data_adni$diagnosis == 'CN',]$ab_composite) & !is.na(data_adni[data_adni$diagnosis == 'CN',]$ptau) & !is.na(data_adni[data_adni$diagnosis == 'CN',]$tau_composite))

# Create a summary
cat("Total observations:", total_obs, "\n")
cat("Have ab_composite:", have_ab_composite, "(", round(have_ab_composite/total_obs*100, 1), "%)\n")
cat("Have ptau217:", have_ptau217, "(", round(have_ptau217/total_obs*100, 1), "%)\n")
cat("Have both:", have_both, "(", round(have_both/total_obs*100, 1), "%)\n")
cat("Have tau:", have_tau, "(", round(have_tau/total_obs*100, 1), "%)\n")
cat("Have all:", have_all, "(", round(have_all/total_obs*100, 1), "%)\n")

# Analysis type
cat("Secondary analysis:", sum(data_adni[data_adni$diagnosis == 'CN',]$secondary), "(", round(sum(data_adni[data_adni$diagnosis == 'CN',]$secondary)/total_obs*100, 1), "%)\n")
cat("Exploratory analysis:", sum(data_adni[data_adni$diagnosis == 'CN',]$exploratory), "(", round(sum(data_adni[data_adni$diagnosis == 'CN',]$exploratory)/total_obs*100, 1), "%)\n")
```

## ADNI MCI

```{r}
# Count total observations in the dataset
total_obs <- nrow(data_adni[data_adni$diagnosis == 'MCI',])

# Count how many have values for each variable
have_ab_composite <- sum(!is.na(data_adni[data_adni$diagnosis == 'MCI',]$ab_composite))
have_ptau217 <- sum(!is.na(data_adni[data_adni$diagnosis == 'MCI',]$ptau))
have_tau <- sum(!is.na(data_adni[data_adni$diagnosis == 'MCI',]$tau_composite))

# Count how many have both variables
have_both <- sum(!is.na(data_adni[data_adni$diagnosis == 'MCI',]$ab_composite) & !is.na(data_adni[data_adni$diagnosis == 'MCI',]$ptau))
have_all <- sum(!is.na(data_adni[data_adni$diagnosis == 'MCI',]$ab_composite) & !is.na(data_adni[data_adni$diagnosis == 'MCI',]$ptau) & !is.na(data_adni[data_adni$diagnosis == 'MCI',]$tau_composite))

# Create a summary
cat("Total observations:", total_obs, "\n")
cat("Have ab_composite:", have_ab_composite, "(", round(have_ab_composite/total_obs*100, 1), "%)\n")
cat("Have ptau217:", have_ptau217, "(", round(have_ptau217/total_obs*100, 1), "%)\n")
cat("Have both:", have_both, "(", round(have_both/total_obs*100, 1), "%)\n")
cat("Have tau:", have_tau, "(", round(have_tau/total_obs*100, 1), "%)\n")
cat("Have all:", have_all, "(", round(have_all/total_obs*100, 1), "%)\n")

# Analysis type
cat("Secondary analysis:", sum(data_adni[data_adni$diagnosis == 'MCI',]$secondary), "(", round(sum(data_adni[data_adni$diagnosis == 'MCI',]$secondary)/total_obs*100, 1), "%)\n")
cat("Exploratory analysis:", sum(data_adni[data_adni$diagnosis == 'MCI',]$exploratory), "(", round(sum(data_adni[data_adni$diagnosis == 'MCI',]$exploratory)/total_obs*100, 1), "%)\n")
```

