---
title: "PET Brain Age Longitudinal PACC"
author: "Jorge Garcia Condado"
date: "`r Sys.Date()`"
output: 
  html_document:
  toc: true
toc_float: true
self_contained: true
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render('PETBrainAgeLongitudinalPACC.Rmd',
                      output_file = paste('~/Documents/Projects/AgingBrainStudy/results/PETBrainAgeLongitudinalPACC', '.html', sep=''))
  })
---
  
```{r, include = FALSE, warning = FALSE, message = FALSE}
library(ggplot2); library(ggpubr); library(dplyr);library(nlme);library(sjPlot);library(gtsummary); library(flextable); library(MuMIn)


knitr::opts_chunk$set(echo = FALSE, message = FALSE)
theme_set(theme_bw())
```

# Brain Age Longitudinal PACC

We will explore how baseline Brain Age delta moderates longitudinal PACC through a linear mixed effects model on A4/Learn and HABS data.

```{r}

# Load A4 data
data_A4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/processed/longitudinal_PACC.csv')

# Load factors
factors_A4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/processed/factors.csv')
factors_A4 <- factors_A4 %>% 
  select(BID, pTau217, amyloid_composite, tau_composite)
data_A4 <- merge(data_A4, factors_A4, by = 'BID', all.x = TRUE)

# Load covariates
covars_A4 <- read.csv('~/Documents/Projects/AgingBrainStudy/data/A4/processed/covariates.csv')
covars_A4 <- covars_A4 %>% 
  select(BID, Amyloid)
data_A4 <- merge(data_A4, covars_A4, by = 'BID', all.x = TRUE)

# Filter subjects with less than 2 data points
data_A4 <- data_A4 %>% 
  arrange(BID, pacc_time) %>%  
  group_by(BID) %>% 
  add_tally(name = 'nTimePoints', wt = !is.na(PACC)) %>%
  filter(nTimePoints >= 2)

# Load deltas
delta_A4 <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/A4/pet_brainage/ageml/model_age/predicted_age.csv')

# Merge the two datasets
data_A4 <- merge(data_A4, delta_A4, by = 'BID')

# Arrange by pacc_time and calculate PACC_change_bl
data_A4 <- data_A4 %>% 
  arrange(BID, pacc_time) %>%
  group_by(BID) %>%
  mutate(PACC_bl = PACC[1]) %>%
  mutate(PACC_change_bl = PACC - PACC_bl)

# Create new variable delta_group where is 0 below younger and older above zero
data_A4 <- data_A4 %>% 
  mutate(delta_group = ifelse(delta_all < 0, 'younger', 'older'))

# Create cohort variable
data_A4 <- data_A4 %>%
  group_by(BID) %>%
  dplyr::mutate(Cohort = case_when(
    SUBSTUDY == "SF" | SUBSTUDY == "LEARN" ~ "LEARN/SF",
    SUBSTUDY == "A4" & TX == "Placebo" ~ "A4 Placebo",
    SUBSTUDY == "A4" & TX == "Solanezumab" ~ "A4 Treated",
    TRUE ~ NA))

# Ensure variables are factors
data_A4 <- data_A4 %>%
  mutate_at(vars(SUBSTUDY, TX, Cohort, SEX, RACE, ETHNIC, APOE, APOEGN, QSVERSION_PACC), factor)

# Placebo data
data_placebo <- data_A4 %>% 
  filter(TX == 'Placebo' | SUBSTUDY != 'A4')
```

```{r}

# Load HABS data
data_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/HABS/raw/longitudinal_PACC.csv')

# Load delta
deltas_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/analysis/HABS/pet_brainage/ageml/model_age/predicted_age.csv')
data_habs <- merge(data_habs, deltas_habs, by = 'SubjIDshort')

# Create new variable delta_group where is 0 below younger and older above zero
data_habs <- data_habs %>% 
  mutate(delta_group = ifelse(delta_all < 0, 'younger', 'older'))

# Add factors
factors_habs <- read.csv('~/Documents/Projects/AgingBrainStudy/data/HABS/processed/factors.csv')
factors_habs <- factors_habs %>% 
  select(SubjIDshort, ptau, p_tau217_ratio, PIB_FS_SUVR_FLR, PIB_FS_SUVR_Group, tau_composite)
data_habs <- merge(data_habs, factors_habs, by = 'SubjIDshort', all.x = TRUE)

# Ensure correct typing
data_habs$NP_SessionDate <- as.Date(data_habs$NP_SessionDate)
data_habs <- data_habs %>%
  mutate(across(c(E4_Status, PIB_FS_SUVR_Group), as.factor))

# Filter subjects with less than 2 data points
data_habs <- data_habs %>% 
  arrange(SubjIDshort, NP_SessionDate) %>%  
  group_by(SubjIDshort) %>% 
  add_tally(name = 'nTimePoints', wt = !is.na(NP_PACC_PACC5)) %>%
  filter(nTimePoints >= 2) %>%
  mutate(time_from_bl = as.numeric(NP_SessionDate - min(NP_SessionDate, na.rm = TRUE))/365.25)  %>%
  mutate(PACC_change_bl = NP_PACC_PACC5 - NP_PACC_PACC5[1])

# Create baseline data set
baseline_habs <- data_habs %>% 
  group_by(SubjIDshort) %>%
  arrange(NP_SessionDate) %>%
  slice(1) %>% #extract first rows - can also use slice_head() for first and slice_tail() for last
  rename(BL_Age = NP_Age) %>%
  rename(BL_PACC = NP_PACC_PACC5) %>%
  ungroup()

# Add age at baseline of subjects
data_habs <- data_habs %>%
  left_join(baseline_habs %>% select(SubjIDshort, BL_Age, BL_PACC), by = 'SubjIDshort')
```

## Demographics

```{r}
data_A4_demo <- data_A4 %>% 
  arrange(BID, pacc_time) %>%  
  group_by(BID) %>%
  mutate(follow_up_time = max(pacc_time, na.rm = TRUE)) %>%
  slice(1) %>% #extract first rows - can also use slice_head() for first and slice_tail() for last
  select(BID, AGEYR, SEX, EDCCNTU, APOE, Amyloid, amyloid_composite, tau_composite, pTau217, PACC_bl, follow_up_time) %>%
  # Add a column Cohort that has in its entry A4/Learn
  mutate(Cohort = 'A4/Learn') %>%
  mutate(Amyloid = ifelse(Amyloid == 1.0, 'positive', 'negative'))

data_HABS_demo <- data_habs %>% 
  arrange(SubjIDshort, NP_SessionDate) %>%  
  group_by(SubjIDshort) %>% 
  mutate(follow_up_time = max(time_from_bl, na.rm = TRUE)) %>%
  slice(1) %>% #extract first rows - can also use slice_head() for first and slice_tail() for last
  select(SubjIDshort, NP_Age, SEX, YrsEd, E4_Status, PIB_FS_SUVR_Group, PIB_FS_SUVR_FLR, ptau, tau_composite, BL_PACC, follow_up_time) %>%
  rename(BID=SubjIDshort, AGEYR = NP_Age, EDCCNTU = YrsEd, APOE = E4_Status, Amyloid = PIB_FS_SUVR_Group, amyloid_composite = PIB_FS_SUVR_FLR, PACC_bl = BL_PACC, pTau217 = ptau) %>%
  mutate(Cohort = 'HABS') %>%
  # Convert PIB- and PIB + to 0 and 1
  mutate(Amyloid = ifelse(Amyloid == 'PIB-', 'negative', 'positive')) %>%
  mutate(SEX = case_when(
    SEX == "F" ~ "Female",
    SEX == "M" ~ "Male"))

habs_t <- tbl_summary(data_HABS_demo,
            include = c(AGEYR, SEX, EDCCNTU, APOE, Amyloid, amyloid_composite, tau_composite, pTau217, PACC_bl, follow_up_time),
            missing = "no",
            statistic = list(all_continuous()  ~ c("{mean} ({sd})")),
            label = list(AGEYR ~ "Age", EDCCNTU ~ "Education (Years)", SEX ~ "Sex", follow_up_time ~ "Follow-up Time (Years)", pTau217 ~ "pTau217 (U/ml)", amyloid_composite ~ "AB-PET SUVR", tau_composite ~ "Tau-PET SUVR", PACC_bl ~ "PACC at Baseline"),
            digits = list(all_continuous() ~ 2, all_categorical() ~ c(0,2)),
            by = Amyloid) %>%
  bold_labels()

A4_t <- tbl_summary(data_A4_demo,
            include = c(AGEYR, SEX, EDCCNTU, APOE, Amyloid, amyloid_composite, tau_composite, pTau217, PACC_bl, follow_up_time),
            missing = "no",
            statistic = list(all_continuous()  ~ c("{mean} ({sd})")),
            label = list(AGEYR ~ "Age", EDCCNTU ~ "Education (Years)", SEX ~ "Sex", follow_up_time ~ "Follow-up Time (Years)", pTau217 ~ "pTau217 (U/ml)", amyloid_composite ~ "AB-PET SUVR", tau_composite ~ "Tau-PET SUVR", PACC_bl ~ "PACC at Baseline"),
            digits = list(all_continuous() ~ 2, all_categorical() ~ c(0,2)),
            by = Amyloid) %>%
  bold_labels()

table <- tbl_merge(list(A4_t, habs_t), tab_spanner = c("A4/LEARN", "HABS")) 

table

table %>%
  as_flex_table() %>% 
  fontsize(size = 14, part = "all") %>%
  line_spacing(space = 1.5, part = "all") %>%
  autofit() %>%
  save_as_docx(path = "~/Downloads/DemographicsTable.docx")
```

## A4 Structural BrainAge

### Trajectories

Plot PACC trajectories with spaghetti plot.

```{r}
ggplot(subset(data_A4, !is.na(PACC)), aes(x = pacc_time, y = PACC, group = BID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from Baseline', y = 'PACC') +
  theme_minimal()
```

Plot PACC change from baseline trajectories with spaghetti plot.

```{r}
ggplot(subset(data_A4, !is.na(PACC_change_bl)), aes(x = pacc_time, y = PACC_change_bl, group = BID, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from Baseline', y = 'PACC change from Basline') +
  theme_minimal()
```

### Mixed Effects Model

Simplest Quadratic mixed effects models with delta at baseline:

PACC \~ pacc_time\^2 + pacc_timeXdelta + Cumulative_Dose_Scaled + QSVERSION_PACC + CohortXpacc_time

```{r}
lmm_results_A4 <- lme(PACC ~ I(pacc_time^2) + pacc_time*delta_all + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4)
p <- plot_model(lmm_results_A4, type = c('pred'), terms = c('pacc_time', 'delta_all [-3, 0, 3]')) +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
```

### Comparison to Tau Composite

Model using Tau Composite

```{r}
lmm_results_A4_composite <- lme(PACC ~ I(pacc_time^2) + pacc_time*tau_composite + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4_composite)
p <- plot_model(lmm_results_A4_composite, type = c('pred'), terms = c('pacc_time', 'tau_composite')) +
  ggtitle(NULL) +
  labs(color = 'Tau Composite',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
```

Model using PET Brain Age and Tau Composite

```{r}
lmm_results_A4_both <- lme(PACC ~ I(pacc_time^2) + pacc_time*tau_composite + pacc_time*delta_all + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4_both)
```

R2 explained and Loglikelihood ratio between the two models

```{r}
# R2 values for each
r.squaredGLMM(lmm_results_A4)
r.squaredGLMM(lmm_results_A4_composite)
r.squaredGLMM(lmm_results_A4_both)
anova(lmm_results_A4, lmm_results_A4_both)
anova(lmm_results_A4_composite, lmm_results_A4_both)
```

Interaction model

```{r}
lmm_results_A4_interaction <- lme(PACC ~ I(pacc_time^2) + pacc_time*tau_composite*delta_all + pacc_time*bl_pacc_age + Cumulative_Dose_Scaled + QSVERSION_PACC + pacc_time*Cohort, data = data_A4, random = ~ pacc_time|BID, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_A4_interaction)
plot_model(lmm_results_A4_interaction, type = c('pred'), terms = c('pacc_time', 'delta_all [-4, 0, 4]', 'tau_composite'))
```

## HABS

### Trajectories

Plot PACC trajectories with spaghetti plot

```{r}
ggplot(subset(data_habs, !is.na(NP_PACC_PACC5)), aes(x = time_from_bl, y = NP_PACC_PACC5, group = SubjIDshort, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from Baseline', y = 'PACC') +
  theme_minimal()
```

Plot PACC change from baseline trajectories with spaghetti plot.

```{r}
ggplot(subset(data_habs, !is.na(PACC_change_bl)), aes(x =  time_from_bl, y = PACC_change_bl, group = SubjIDshort, colour = delta_group)) +
  geom_line() +
  geom_point() +
  labs(title = 'PACC Trajectories', x = 'Time from Baseline', y = 'PACC change from Basline') +
  theme_minimal()
```

### Mixed Effects Model

Simplest linear mixed effects models with delta at baseline:

PACC \~ pacc_timeXdelta 

```{r}
lmm_results_habs <- lme(NP_PACC_PACC5 ~ time_from_bl*delta_all, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs)
p <- plot_model(lmm_results_habs, type = c('pred'), terms = c('time_from_bl', 'delta_all [-4, 0, 4]'))
p <- p +
  ggtitle(NULL) +
  labs(color = 'Delta (years)',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
```

### Comparison to Tau Composite

Model using Tau Composite

```{r}
lmm_results_habs_composite <- lme(NP_PACC_PACC5 ~ time_from_bl*tau_composite, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs_composite)
p <- plot_model(lmm_results_habs_composite, type = c('pred'), terms = c('time_from_bl', 'tau_composite'))
p <- p +
  ggtitle(NULL) +
  labs(color = 'Tau Composite',
      x = 'Time from baseline (years)',
      y = 'PACC')
p
```

Model using PET Brain Age and Tau Composite

```{r}
lmm_results_habs_both <- lme(NP_PACC_PACC5 ~ time_from_bl*delta_all + time_from_bl*tau_composite, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs_both)
```

R2 explained and Loglikelihood ratio between the two models

```{r}
# R2 values for each
r.squaredGLMM(lmm_results_habs)
r.squaredGLMM(lmm_results_habs_composite)
r.squaredGLMM(lmm_results_habs_both)
anova(lmm_results_habs, lmm_results_habs_both)
anova(lmm_results_habs_composite, lmm_results_habs_both)
```

Interaction model

```{r}
lmm_results_habs_interaction <- lme(NP_PACC_PACC5 ~ time_from_bl*tau_composite*delta_all + time_from_bl*BL_Age, data = data_habs, random = ~time_from_bl|SubjIDshort, na.action = 'na.omit', method = c('ML'));
summary(lmm_results_habs_interaction)
plot_model(lmm_results_habs_interaction, type = c('pred'), terms = c('time_from_bl', 'delta_all [-4, 0, 4]', 'tau_composite'))
```